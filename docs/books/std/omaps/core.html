<!DOCTYPE html>
<html lang="en" vocab="http://schema.org/" typeof="SoftwareSourceCode">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>core - ACL2 Book</title>
  <meta property="name" content="core">
  <meta property="programmingLanguage" content="ACL2">
  
<style>
/* ACL2 Book HTML Documentation Styles */
/* Generated by cert2 - build2 system */

/* Dark theme (default) */
:root {
  --bg: #1e1e2e;
  --fg: #cdd6f4;
  --comment: #6c7086;
  --keyword: #cba6f7;
  --string: #a6e3a1;
  --function: #89b4fa;
  --type: #f9e2af;
  --link: #89dceb;
  --link-hover: #f5c2e7;
  --highlight: rgba(137, 180, 250, 0.2);
  --border: #313244;
  --block-bg: rgba(49, 50, 68, 0.5);
  --btn-bg: #313244;
  --btn-hover: rgba(137, 180, 250, 0.2);
}

/* Light theme */
[data-theme="light"] {
  --bg: #eff1f5;
  --fg: #4c4f69;
  --comment: #6c6f85;
  --keyword: #8839ef;
  --string: #40a02b;
  --function: #1e66f5;
  --type: #df8e1d;
  --link: #04a5e5;
  --link-hover: #ea76cb;
  --highlight: rgba(30, 102, 245, 0.15);
  --border: #ccd0da;
  --block-bg: rgba(204, 208, 218, 0.3);
  --btn-bg: #ccd0da;
  --btn-hover: rgba(30, 102, 245, 0.15);
}

body {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  padding: 20px;
  line-height: 1.6;
  font-size: 14px;
  transition: background 0.1s, color 0.1s;
}

/* Controls toolbar */
.controls-left {
  position: fixed;
  top: 10px;
  left: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
  transition: transform 0.1s ease;
}

.controls-right {
  position: fixed;
  top: 10px;
  right: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
}

.control-btn {
  padding: 6px 12px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  transition: all 0.1s;
}

.control-btn:hover {
  background: var(--btn-hover);
  border-color: var(--link);
}

.name-filter {
  padding: 6px 10px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  width: 150px;
  transition: all 0.1s;
}

.name-filter:focus {
  outline: none;
  border-color: var(--link);
  width: 200px;
}

.name-filter::placeholder {
  color: var(--comment);
}

.regex-label {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--comment);
  font-size: 12px;
  cursor: pointer;
}

.regex-label input {
  cursor: pointer;
}

.book-header {
  border-bottom: 2px solid var(--border);
  padding-bottom: 20px;
  margin-bottom: 20px;
}

.book-header h1 {
  color: var(--keyword);
  margin: 0;
}

.book-header .path {
  color: var(--comment);
  font-size: 0.9em;
}

.book-header .path .source-link {
  color: var(--comment);
  text-decoration: none;
}

.book-header .path .source-link:hover {
  color: var(--link);
  text-decoration: underline;
}

.form-block {
  margin: 10px 0;
  padding: 15px;
  background: var(--block-bg);
  border-radius: 8px;
  border-left: 3px solid var(--border);
}

.form-block.theorem { border-left-color: var(--keyword); }
.form-block.function { border-left-color: var(--function); }
.form-block.macro { border-left-color: var(--type); }
.form-block.include-book { border-left-color: var(--string); }

.form-block.hidden { display: none; }
.form-block.dimmed { opacity: 0.3; }

.form-block.highlight {
  animation: highlight-pulse 0.4s ease-out;
}

@keyframes highlight-pulse {
  0% { background: var(--highlight); box-shadow: 0 0 20px var(--link); }
  100% { background: rgba(49, 50, 68, 0.5); box-shadow: none; }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.form-name {
  color: var(--function);
  font-weight: bold;
  cursor: pointer;
}

.form-name:hover {
  color: var(--link-hover);
  text-decoration: underline;
}

.form-type {
  color: var(--comment);
  font-size: 0.85em;
}

pre.code {
  margin: 0;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.sym-ref {
  color: var(--link);
  cursor: pointer;
  border-radius: 2px;
}

.sym-ref:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.sym-ref.local-def { color: var(--function); font-weight: bold; }
.sym-ref.external { color: var(--type); }

/* Symbol links (clickable hyperlinks) */
.sym-link {
  color: var(--link);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.sym-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

.sym-link.local-def {
  color: var(--function);
  font-weight: bold;
}

.sym-link.external {
  color: var(--type);
}

/* Tooltips using title attribute with custom styling */
.sym-link[title] {
  /* Browser will show title on hover */
}

/* Syntax highlighting in code blocks */
.keyword {
  color: var(--keyword);
}

.string {
  color: var(--string);
}

.number {
  color: #f77524; /* orange */
}

/* Include-book path links */
.include-path {
  color: var(--string);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
}

.include-path:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

/* Part buttons for defthm */
.part-buttons {
  display: flex;
  gap: 5px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.part-btn {
  padding: 4px 10px;
  background: var(--border);
  border: 1px solid var(--comment);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
}

.part-btn:hover {
  background: var(--highlight);
  border-color: var(--link);
}

.part-btn.active {
  background: var(--link);
  color: var(--bg);
  border-color: var(--link);
}

/* References panel */
.refs-panel {
  margin-top: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  display: none;
}

.refs-panel.visible { display: block; }

.refs-panel h4 {
  margin: 0 0 5px 0;
  color: var(--comment);
  font-size: 0.9em;
}

.refs-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* Included books section */
.includes-section {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(49, 50, 68, 0.3);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.includes-section h2 {
  margin: 0 0 10px 0;
  color: var(--comment);
  font-size: 1em;
  font-weight: normal;
}

.includes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.include-link {
  padding: 6px 12px;
  background: var(--border);
  border-radius: 4px;
  color: var(--link);
  text-decoration: none;
  font-size: 0.9em;
  transition: all 0.1s;
}

.include-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.include-link.local {
  border-left: 2px solid var(--comment);
}

/* Filter status */
.filter-status {
  position: fixed;
  top: 10px;
  left: 20px;
  background: var(--bg);
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  z-index: 201;
  display: none;
  align-items: center;
  gap: 10px;
}

.filter-status.active {
  display: flex;
  align-items: center;
  gap: 10px;
}

.clear-filter {
  padding: 5px 15px;
  background: var(--keyword);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* RDFa vocab indicator */
[vocab] { /* semantic web annotations present */ }

</style>

</head>
<body>
  <div class="controls-left">
    <input type="text" id="name-filter" class="name-filter" placeholder="Filter by name..." title="Filter definitions by name">
    <label class="regex-label"><input type="checkbox" id="regex-toggle"> regex</label>
  </div>

  <div class="controls-right">
    <button class="control-btn" id="theme-toggle" title="Toggle light/dark theme">☀️</button>
    <button class="control-btn" id="font-smaller" title="Decrease font size">A-</button>
    <button class="control-btn" id="font-larger" title="Increase font size">A+</button>
  </div>

  <div class="filter-status">
    <span class="filter-text">Filtering...</span>
    <button class="clear-filter">Clear Filter</button>
  </div>
  
  <div class="book-header">
    <h1 property="name">core</h1>
    <div class="path"><a href="core.lisp" class="source-link">books/std/omaps/core</a></div>
  </div>
  
  <main property="text">
<div class="form-block other" id="form-0" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-in-package" data-sym="IN-PACKAGE">in-package</a> <span class="string">"OMAP"</span>)</pre>
  </div>

<div class="form-block other" id="form-1" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/osets/top.html" title="Open std/osets/top">"std/osets/top"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-2" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/util/define.html" title="Open std/util/define">"std/util/define"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-3" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/util/defrule.html" title="Open std/util/defrule">"std/util/defrule"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-4" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../xdoc/defxdoc-plus.html" title="Open xdoc/defxdoc-plus">"xdoc/defxdoc-plus"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-5" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../misc/total-order.html" title="Open misc/total-order">"misc/total-order"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-6" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/basic/inductions.html" title="Open std/basic/inductions">"std/basic/inductions"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-7" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/acl2-count.html" title="Open std/lists/acl2-count">"std/lists/acl2-count"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-8" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/top.html" title="Open std/lists/top">"std/lists/top"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-9" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../tools/rulesets.html" title="Open tools/rulesets">"tools/rulesets"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-10" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defxdoc+ omaps
  <span class="keyword">:parents</span> (std)
  <span class="keyword">:short</span> <span class="string">"A library of omaps (ordered maps),
          i.e. finite maps represented as strictly ordered alists."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is related to the library of "</span>
      (seetopic <span class="string">"set::std/osets"</span> <span class="string">"osets (ordered sets)"</span>)
      <span class="string">", i.e. finite sets represented as strictly ordered lists.
     Like osets capture (up to isomorphism)
     the mathematical notion of finite sets (over ACL2 objects),
     omaps capture (up to isomorphism)
     the mathematical notion of finite maps (over ACL2 objects).
     In particular, omap equality is @(tsee equal)."</span>)
    (p <span class="string">"Since the "</span>
      (seetopic <span class="string">"&lt;&lt;"</span> <span class="string">"total order on ACL2 values"</span>)
      <span class="string">" is lexicographic on @(tsee cons) pairs,
     an omap is an oset of @(tsee cons) pairs;
     furthermore, an omap is an alist.
     While then, in principle,
     some oset and alist operations could be used on omaps,
     this library provides versions of those oset and alist operations
     that have stronger guards
     (i.e. requiring omaps instead of just osets or alists)
     and that treat non-omaps as the empty omap.
     That is, the omap operations respect a `non-map convention&#39;
     analogous to the "</span>
      (seetopic <span class="string">"set::primitives"</span> <span class="string">"non-set convention"</span>)
      <span class="string">" respected by the oset operations;
     some of the latter are, analogously,
     versions of list operations (e.g. @(tsee set::head) for @(tsee car)),
     motivated by the fact that the list operations
     do not respect the non-set convention."</span>)
    (p <span class="string">"The omap operations
     @(tsee mapp),
     @(tsee mfix),
     @(tsee emptyp),
     @(tsee head),
     @(tsee tail), and
     @(tsee update)
     are ``primitive&#39;&#39; in the same sense as the "</span>
      (seetopic <span class="string">"set::primitives"</span> <span class="string">"oset primitives"</span>)
      <span class="string">": their logical definitions depend on
     the underlying representation as alists,
     and provide replacements of alist operations
     that respect the `non-map convention&#39;.
     The logical definitions of the other omap operations
     are in terms of the primitive operations,
     without reference to the underlying alist representation."</span>)
    (p <span class="string">"There are different logically equivalent ways to define omap operations.
     The current definitions (as well as their names) are preliminary
     and could be improved if needed;
     these definitions favor ease of reasoning over efficiency of execution,
     but, as done in osets, @(tsee mbe) could be used to provide
     provably equivalent efficient definitions for execution.
     As it is often possible to reason about osets abstractly
     (i.e. without regard to their underlying list representation),
     it should be often possible to reason about omaps abstractly
     (i.e. without regard to their underlying alist representation),
     using the theorems provided by this library.
     The current theorems are preliminary
     and could be improved and extended if needed.
     The empty omap is @(&#39;nil&#39;), like the empty oset;
     there is no separate operation for the empty omap,
     as there is none for the empty oset."</span>)
    (p <span class="string">"Since osets are in the @(&#39;&quot;SET&quot;&#39;) package,
     it would be natural to use a @(&#39;&quot;MAP&#39;) package for omaps.
     However, a package with this name is already defined
     in @(&#39;coi/maps/package.lsp&#39;) (see below).
     So, we use @(&#39;&quot;OMAP&quot;&#39;) for omaps
     to allow interoperability with this @(&#39;coi&#39;) map library,
     in the sense that an application can use both @(&#39;coi&#39;) maps and omaps.
     Perhaps the @(&#39;&quot;SET&quot;&#39;) package for osets
     could be renamed to @(&#39;&quot;OSET&quot;&#39;) at some point,
     for consistency.
     (A similar issue applies to the library of obags, i.e. ordered bags,
     and the @(&#39;coi/bags&#39;) library,
     which defines a @(&#39;&quot;BAG&quot;&#39;) package.)"</span>)
    (p <span class="string">"Compared to using the built-in @(see acl2::alists) to represent maps,
     omaps are closer to the mathematical notion of maps,
     at the cost of maintaining their strict order.
     These tradeoffs are analogous to the ones between using osets
     and using the built-in @(see acl2::lists) to represent sets.
     The map library in @(&#39;coi/maps/&#39;)
     operates on possibly unordered alists."</span>)
    (p <span class="string">"Compared to the records in "</span>
      (seetopic <span class="string">"acl2::misc/records"</span>
        <span class="string">"@(&#39;misc/records.lisp&#39;)"</span>)
      <span class="string">" and @(&#39;coi/records/&#39;),
     omaps allow any value to be associated to keys,
     without having to exclude @(&#39;nil&#39;) or some other fixed value.
     Furthermore, as noted in the comments in @(&#39;coi/maps/maps.lisp&#39;),
     the `get&#39; operation on those records
     does not always yield a value smaller than the map.
     On the other hand, theorems about omaps have generally more hypotheses
     than the theorems about records."</span>))
  <span class="keyword">:default-parent</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-11" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define mapp
  (x)
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Recognize omaps."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is similar to the definition of @(tsee set::setp),
    but each element of the list is checked to be a @(tsee cons) pair
    and the ordering comparison is performed on the @(tsee car)s."</span>)
  (if (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)
    (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> x)
    (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (consp (car x))
      (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> (cdr x))
        (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (consp (cdr x))
          (consp (<a class="sym-link system" href="../../../axioms.html#def-cadr" data-sym="CADR">cadr</a> x))
          (fast-&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-caar" data-sym="CAAR">caar</a> x) (<a class="sym-link system" href="../../../axioms.html#def-caadr" data-sym="CAADR">caadr</a> x))
          (mapp (cdr x))))))
  ///
  (defruled setp-when-mapp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (mapp x) (setp x))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:forward-chaining</span>)
    <span class="keyword">:enable</span> (setp &lt;&lt; <a class="sym-link system" href="../../../axioms.html#def-lexorder" data-sym="LEXORDER">lexorder</a>))
  (defruled alistp-when-mapp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (mapp x) (<a class="sym-link system" href="../../../axioms.html#def-alistp" data-sym="ALISTP">alistp</a> x))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:forward-chaining</span>)))</pre>
  </div>

<div class="form-block other" id="form-12" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defruledl consp-car-when-mapp-non-nil
  (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> map (mapp map)) (consp (car map)))
  <span class="keyword">:enable</span> mapp)</pre>
  </div>

<div class="form-block other" id="form-13" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define mfix
  ((x mapp))
  <span class="keyword">:returns</span> (fixed-x mapp)
  <span class="keyword">:short</span> <span class="string">"Fixing function for omaps."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is similar to @(tsee set::sfix) for osets."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-mbe" data-sym="MBE">mbe</a> <span class="keyword">:logic</span> (if (mapp x)
      x
      nil)
    <span class="keyword">:exec</span> x)
  ///
  (defrule mfix-when-mapp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (mapp x)
      (equal (mfix x) x)))
  (defrule mfix-implies-mapp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (mfix x) (mapp x))))</pre>
  </div>

<div class="form-block other" id="form-14" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define emptyp
  ((map mapp))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Check if an omap is empty."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is similar to @(tsee set::emptyp) for osets."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> (mfix map))
  ///
  (defrule mapp-when-not-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map)) (mapp map))
    <span class="keyword">:enable</span> mfix)
  (defrule mfix-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp x)
      (equal (mfix x) nil)))
  (defrule mapp-non-nil-implies-not-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (mapp map) map)
      (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))))
  (defrule acl2-count-head-when-not-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (&lt; (<a class="sym-link system" href="../../../axioms.html#def-_2B" data-sym="+">+</a> (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (car (car map)))
          (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (cdr (car map))))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable mfix alistp-when-mapp)))))</pre>
  </div>

<div class="form-block other" id="form-15" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define head
  ((map mapp))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
  <span class="keyword">:returns</span> (<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> key val)
  <span class="keyword">:short</span> <span class="string">"Smallest key, and associated value, of a non-empty omap."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is similar to @(tsee set::head) for osets."</span>)
  (let ((pair (car (mfix map))))
    (<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> (car pair) (cdr pair)))
  <span class="keyword">:guard-hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable emptyp mapp)))
  ///
  (defrule head-key-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>)
    <span class="keyword">:enable</span> mapp)
  (defrule head-value-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span> (head map)) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>)
    <span class="keyword">:enable</span> mapp)
  (defruled head-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (head map) (<a class="sym-link system" href="../../../axioms.html#def-list" data-sym="LIST">list</a> nil nil)))
    <span class="keyword">:enable</span> head)
  (defrule head-when-emptyp-cheap
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (head map) (<a class="sym-link system" href="../../../axioms.html#def-list" data-sym="LIST">list</a> nil nil)))
    <span class="keyword">:rule-classes</span> ((<span class="keyword">:rewrite</span> <span class="keyword">:backchain-limit-lst</span> (<span class="number">0</span>)))
    <span class="keyword">:by</span> head-when-emptyp)
  (defrule head-key-count
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (&lt; (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:linear</span>)
    <span class="keyword">:enable</span> (emptyp mfix alistp-when-mapp))
  (defrule head-value-count
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (&lt; (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span> (head map)))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:linear</span>)
    <span class="keyword">:enable</span> (emptyp mfix alistp-when-mapp))
  (defrule head-key-count-built-in
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (<a class="sym-link system" href="../../../axioms.html#def-o_3C" data-sym="O&lt;">o&lt;</a> (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:rule-classes</span> <span class="keyword">:built-in-clause</span> <span class="keyword">:enable</span> (emptyp mfix alistp-when-mapp))
  (defrule head-value-count-built-in
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (<a class="sym-link system" href="../../../axioms.html#def-o_3C" data-sym="O&lt;">o&lt;</a> (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span> (head map)))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:rule-classes</span> <span class="keyword">:built-in-clause</span> <span class="keyword">:enable</span> (emptyp mfix alistp-when-mapp)))</pre>
  </div>

<div class="form-block other" id="form-16" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define head-key
  ((map mapp))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
  <span class="keyword">:short</span> <span class="string">"Smallest key of a non-empty omap."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is used as an abbreviation, so it is enabled by default."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key val)
    (head map)
    (declare (ignore val))
    key)
  <span class="keyword">:enabled</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-17" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define head-val
  ((map mapp))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
  <span class="keyword">:short</span> <span class="string">"Value associated to the smallest key of a non-empty omap."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is used as an abbreviation, so it is enabled by default."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key val)
    (head map)
    (declare (ignore key))
    val)
  <span class="keyword">:enabled</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-18" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define tail
  ((map mapp))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
  <span class="keyword">:returns</span> (map1 mapp
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable mfix mapp))))
  <span class="keyword">:short</span> <span class="string">"Rest of a non-empty omap after removing its smallest pair."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is similar to @(tsee set::tail) for osets."</span>)
  (cdr (mfix map))
  <span class="keyword">:guard-hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable emptyp alistp-when-mapp)))
  ///
  (defrule tail-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (tail map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>)
    <span class="keyword">:enable</span> (emptyp mfix mapp))
  (defrule tail-count
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (&lt; (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (tail map))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:linear</span>)
    <span class="keyword">:enable</span> (emptyp mfix))
  (defrule tail-count-built-in
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (<a class="sym-link system" href="../../../axioms.html#def-o_3C" data-sym="O&lt;">o&lt;</a> (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (tail map))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:rule-classes</span> <span class="keyword">:built-in-clause</span> <span class="keyword">:enable</span> (emptyp mfix))
  (defruled head-tail-order
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp (tail x)))
      (&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head x))
        (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head (tail x)))))
    <span class="keyword">:enable</span> (mapp head mfix))
  (defruled head-tail-order-contrapositive
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head x))
          (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head (tail x)))))
      (emptyp (tail x)))
    <span class="keyword">:enable</span> head-tail-order
    <span class="keyword">:disable</span> tail))</pre>
  </div>

<div class="form-block other" id="form-19" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define update
  (key val (map mapp))
  <span class="keyword">:returns</span> (map1 mapp
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable mapp
         mfix
         emptyp
         head
         tail))))
  <span class="keyword">:short</span> <span class="string">"Set a key to a value in an omap."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"If the key is not already in the map, it is added, with the value.
     If the key is already in the map, the new value overrides the old value."</span>)
    (p <span class="string">"This is similar to @(tsee set::insert) for osets."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) (<a class="sym-link system" href="../../../axioms.html#def-list" data-sym="LIST">list</a> (cons key val)))
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key0 val0)
        (head map)
        (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((equal key key0) (cons (cons key val) (tail map)))
          ((&lt;&lt; key key0) (cons (cons key val) map))
          (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (cons (cons key0 val0)
              (update key val (tail map))))))))
  ///
  (<a class="sym-link system" href="../../../axioms.html#def-in-theory" data-sym="IN-THEORY">in-theory</a> (disable (<span class="keyword">:type-prescription</span> update)))
  (defrule update-type-prescription
    (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (consp (update x y z))
      (<a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a> (update x y z)))
    <span class="keyword">:rule-classes</span> <span class="keyword">:type-prescription</span>)
  (defrule update-of-head-and-tail
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (equal (update (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))
          (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span> (head map))
          (tail map))
        map))
    <span class="keyword">:rule-classes</span> <span class="keyword">:elim</span> <span class="keyword">:enable</span> (head tail emptyp mfix mapp))
  (defrule update-not-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp (update key val map)))
    <span class="keyword">:enable</span> emptyp)
  (defrule update-same
    (equal (update key
        val1
        (update key val2 map))
      (update key val1 map))
    <span class="keyword">:enable</span> (head tail emptyp mfix mapp))
  (defrule update-different
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (equal key1 key2))
      (equal (update key1
          val1
          (update key2 val2 map))
        (update key2
          val2
          (update key1 val1 map))))
    <span class="keyword">:enable</span> (head tail emptyp mfix mapp))
  (defrule update-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-syntaxp" data-sym="SYNTAXP">syntaxp</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (equal map ''nil)))
        (emptyp map))
      (equal (update key val map)
        (update key val nil)))
    <span class="keyword">:enable</span> update)
  (defrule head-key-of-update-of-nil
    (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span>
        (head (update key val nil)))
      key)
    <span class="keyword">:enable</span> (update head mapp))
  (defrule head-value-of-update-of-nil
    (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span>
        (head (update key val nil)))
      val)
    <span class="keyword">:enable</span> (update head mapp))
  (defrule tail-of-update-of-nil
    (equal (tail (update key val nil))
      nil)
    <span class="keyword">:enable</span> (update tail mfix))
  (defrule head-of-update
    (equal (head (update key val map))
      (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) (<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> key val))
        ((&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) key) (head map))
        (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> key val))))
    <span class="keyword">:enable</span> (update head tail))
  (defruled head-key-of-update
    (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span>
        (head (update key val map)))
      (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) key)
        ((&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) key) (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))
        (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> key)))
    <span class="keyword">:enable</span> (head-of-update))
  (defruled head-value-of-update
    (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span>
        (head (update key val map)))
      (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) val)
        ((&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) key) (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span> (head map)))
        (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> val)))
    <span class="keyword">:enable</span> (head-of-update))
  (defrule tail-of-update
    (equal (tail (update key val map))
      (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
        ((&lt;&lt; key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))) map)
        ((equal key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))) (tail map))
        (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (update key val (tail map)))))
    <span class="keyword">:enable</span> (update tail))
  (defrule head-value-of-update-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span>
          (head (update key val map)))
        val))
    <span class="keyword">:enable</span> (head-value-of-update)
    <span class="keyword">:disable</span> update)
  (defrule head-value-of-update-key-&lt;&lt;
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
        (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (&lt;&lt; key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))
          (equal key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))))
      (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span>
          (head (update key val map)))
        val))
    <span class="keyword">:enable</span> (head-value-of-update)
    <span class="keyword">:disable</span> update)
  (defrule head-value-of-update-when-head-key-equal
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span>
          (head (update key val x)))
        key)
      (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span>
          (head (update key val x)))
        val))
    <span class="keyword">:enable</span> (&lt;&lt;-irreflexive head-of-update)
    <span class="keyword">:disable</span> update)
  (defrule head-value-of-update-not-&lt;&lt;
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
        (&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) key))
      (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span>
          (head (update key val map)))
        (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">1</span> (head map))))
    <span class="keyword">:enable</span> (head-value-of-update)
    <span class="keyword">:disable</span> update)
  (defrule tail-of-update-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (tail (update key val map))
        nil))
    <span class="keyword">:enable</span> (tail-of-update)
    <span class="keyword">:disable</span> update)
  (defrule tail-of-update-&lt;&lt;
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
        (&lt;&lt; key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))))
      (equal (tail (update key val map))
        map))
    <span class="keyword">:enable</span> (tail-of-update)
    <span class="keyword">:disable</span> update)
  (defrule tail-of-update-equal
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
        (equal key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))))
      (equal (tail (update key val map))
        (tail map)))
    <span class="keyword">:enable</span> (tail-of-update)
    <span class="keyword">:disable</span> update)
  (defrule tail-of-update-&lt;&lt;-rev
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
        (&lt;&lt; (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) key))
      (equal (tail (update key val map))
        (update key val (tail map))))
    <span class="keyword">:enable</span> (tail-of-update)
    <span class="keyword">:disable</span> update))</pre>
  </div>

<div class="form-block other" id="form-20" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define update*
  ((new mapp) (old mapp))
  <span class="keyword">:returns</span> (map mapp)
  <span class="keyword">:short</span> <span class="string">"Update a map with another map."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This lifts @(tsee update) from a single key and value
    to a set of key-value pairs, passed as the first argument map.
    If a key is in the second but not in the first map,
    the key is present in the result, with the same value as in the second map.
    If a key is in the first but not in the second map,
    the key is present in the result, with the same value as in the first map.
    If a key is present in both maps,
    it is present in the result, with the same value as in the first map;
    i.e. the first map ``wins&#39;&#39;.
    There are no other keys in the result."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp new) (mfix old))
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (new-key new-val)
        (head new)
        (update new-key
          new-val
          (update* (tail new) old)))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule update*-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp new)
      (equal (update* new old)
        (mfix old))))
  (defrule update*-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp old)
      (equal (update* new old)
        (mfix new)))))</pre>
  </div>

<div class="form-block other" id="form-21" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define delete
  (key (map mapp))
  <span class="keyword">:returns</span> (map1 mapp)
  <span class="keyword">:short</span> <span class="string">"Remove a key, and associated value, from an omap."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is similar to @(tsee set::delete) for osets."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key0 val0)
        (head map)
        (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((equal key key0) (tail map))
          (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (update key0
              val0
              (delete key (tail map))))))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule delete-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (delete key map) nil))))</pre>
  </div>

<div class="form-block other" id="form-22" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define delete*
  ((keys setp) (map mapp))
  <span class="keyword">:returns</span> (map1 mapp)
  <span class="keyword">:short</span> <span class="string">"Remove keys, and associated values, from an omap."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This lifts @(tsee delete) from a single key to a set of keys."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp keys) (mfix map))
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (delete (head keys)
        (delete* (tail keys) map))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule delete*-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp keys)
      (equal (delete* keys map) (mfix map))))
  (defrule delete*-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (delete* keys map) nil))))</pre>
  </div>

<div class="form-block other" id="form-23" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define <a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a>
  (key (map mapp))
  <span class="keyword">:returns</span> (pair? <a class="sym-link system" href="../../../axioms.html#def-listp" data-sym="LISTP">listp</a>)
  <span class="keyword">:short</span> <span class="string">"Find the pair in the omap with a given key."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"If the key is present, return the @(tsee cons) pair with the key.
     Otherwise, return @(&#39;nil&#39;)."</span>)
    (p <span class="string">"This is similar to @(tsee acl2::assoc) for alists."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key0 val0)
        (head map)
        (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((equal key key0) (cons key0 val0))
          (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (tail map)))))))
  ///
  (defrule assoc-of-mfix
    (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (mfix map))
      (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))
  (defrule assoc-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defrule consp-of-assoc
    (equal (consp (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))
      (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)))
  (defrule assoc-of-head
    (<a class="sym-link system" href="../../../axioms.html#def-iff" data-sym="IFF">iff</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) map)
      (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))))
  (defrule assoc-when-assoc-tail
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (tail map))
      (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))
  (defrule acl2-count-assoc-&lt;-map
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (&lt; (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:enable</span> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> head
      emptyp
      mfix
      consp-car-when-mapp-non-nil
      alistp-when-mapp))
  (defrule assoc-of-update
    (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key1 (update key val map))
      (if (equal key1 key)
        (cons key val)
        (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key1 map)))
    <span class="keyword">:enable</span> (update head
      tail
      emptyp
      mfix
      mapp))
  (defrule assoc-of-update*
    (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (update* map1 map2))
      (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map1)
        (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map2)))
    <span class="keyword">:enable</span> update*)
  (defrule update-of-cdr-of-assoc-when-assoc
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> k m)
      (equal (update k (cdr (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> k m)) m)
        m)))
  (defruled head-key-minimal
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (&lt;&lt; key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))
      (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:hints</span> ('(<span class="keyword">:use</span> (<span class="keyword">:instance</span> head-tail-order (x map)))))
  (defrule head-key-not-assoc-tail
    (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)) (tail map)))
    <span class="keyword">:disable</span> <a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a>
    <span class="keyword">:use</span> ((<span class="keyword">:instance</span> head-key-minimal
       (key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map)))
       (map (tail map))) (<span class="keyword">:instance</span> head-tail-order (x map))))
  (defruled assoc-of-tail-when-assoc-of-tail
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (tail map))
      (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (tail map))
        (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))))
  (defruled assoc-of-tail-when-not-head
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (equal key (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))))
      (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (tail map))
        (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))))</pre>
  </div>

<div class="form-block other" id="form-24" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define in*
  ((keys setp) (map mapp))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Check if every key in a set is in an omap."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp keys) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> (head keys) map)
        (in* (tail keys) map))))
  ///
  (defrule in*-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp keys)
      (in* keys map)))
  (defrule in*-when-rigth-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (in* keys map) (emptyp keys))))
  (defrule in*-of-tail
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (in* keys map)
      (in* (tail keys) map))))</pre>
  </div>

<div class="form-block other" id="form-25" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define list-in
  ((keys <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>) (map mapp))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Check if every key in a list is in an omap."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="../../../axioms.html#def-endp" data-sym="ENDP">endp</a> keys) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> (car keys) map)
        (list-in (cdr keys) map)))))</pre>
  </div>

<div class="form-block other" id="form-26" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define list-notin
  ((keys <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>) (map mapp))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Check if none of the keys in a list is in an omap."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (<a class="sym-link system" href="../../../axioms.html#def-endp" data-sym="ENDP">endp</a> keys)
    (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> (car keys) map))
      (list-notin (cdr keys) map)))
  ///
  (defruled not-assoc-map-when-member-of-list-notin
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (list-notin keys map)
        (<a class="sym-link system" href="../../../axioms.html#def-member-equal" data-sym="MEMBER-EQUAL">member-equal</a> key keys))
      (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))</pre>
  </div>

<div class="form-block other" id="form-27" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection omap-order-rules
  <span class="keyword">:short</span> <span class="string">"Some rules involving the ordering in omaps."</span>
  (def-ruleset order-rules
    '(&lt;&lt;-irreflexive &lt;&lt;-transitive
      &lt;&lt;-asymmetric
      &lt;&lt;-trichotomy
      &lt;&lt;-implies-lexorder
      (<span class="keyword">:induction</span> update)
      head-of-update
      head-key-of-update
      head-value-of-update
      head-tail-order
      head-tail-order-contrapositive)))</pre>
  </div>

<div class="form-block other" id="form-28" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection update-induction-on-maps
  <span class="keyword">:short</span> <span class="string">"Induction on omaps based on
          abstract characterization of @(tsee update)."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is similar to the induction on osets
     in @(&#39;[books]/std/osets/primitives.lisp&#39;)."</span>)
    (p <span class="string">"We want to do certain proofs by induction based on @(tsee update),
     but not based on the definition of @(tsee update),
     which involves the internal representation of omaps.
     Instead "</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> weak-update-induction-helper-1
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (mapp m)
        (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key m))
        (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span>
              (head (update key val m)))
            key)))
      (equal (head (update key val m))
        (head m)))
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable* order-rules))))
  (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> weak-update-induction-helper-2
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key m))
        (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span>
              (head (update key val m)))
            key)))
      (equal (tail (update key val m))
        (update key val (tail m))))
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable* order-rules))))
  (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> weak-update-induction-helper-3
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key m))
        (equal (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span>
            (head (update key val m)))
          key))
      (equal (tail (update key val m))
        (mfix m)))
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable* order-rules))))
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> weak-update-induction
    (key val m)
    (declare (xargs <span class="keyword">:guard</span> (mapp m)))
    (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp m) nil)
      ((<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key m) nil)
      ((equal (head-key (update key val m))
         key) nil)
      (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-list" data-sym="LIST">list</a> (weak-update-induction key
            val
            (tail m))))))
  (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> use-weak-update-induction
    <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:rule-classes</span> ((<span class="keyword">:induction</span> <span class="keyword">:pattern</span> (update key val m)
       <span class="keyword">:scheme</span> (weak-update-induction key val m)))))</pre>
  </div>

<div class="form-block other" id="form-29" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define lookup
  (key (map mapp))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)
  <span class="keyword">:returns</span> (val)
  <span class="keyword">:short</span> <span class="string">"Value associated to a key in an omap."</span>
  (cdr (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))
  ///
  (defrule lookup-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (lookup key map)))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defrule acl2-count-lookup-&lt;-map
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
      (&lt; (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> (lookup key map))
        (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> map)))
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (disable acl2-count-assoc-&lt;-map)
       <span class="keyword">:use</span> acl2-count-assoc-&lt;-map)))
  (defruled lookup-of-tail-when-assoc-tail
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (tail map))
      (equal (lookup key (tail map))
        (lookup key map)))
    <span class="keyword">:enable</span> assoc-of-tail-when-assoc-of-tail)
  (defruled lookup-of-update
    (equal (lookup key1
        (update key val map))
      (if (equal key1 key)
        val
        (lookup key1 map)))
    <span class="keyword">:enable</span> lookup)
  (defruled lookup-of-update*
    (equal (lookup key
        (update* map1 map2))
      (if (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map1)
        (lookup key map1)
        (lookup key (mfix map2))))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> (update* lookup-of-update)))</pre>
  </div>

<div class="form-block other" id="form-30" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define lookup*
  ((keys setp) (map mapp))
  <span class="keyword">:guard</span> (in* keys map)
  <span class="keyword">:returns</span> (vals setp)
  <span class="keyword">:short</span> <span class="string">"Set of values associated to a set of keys in an omap."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This lifts @(tsee lookup) to sets of keys."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp keys) nil)
    ((<a class="sym-link system" href="../../../axioms.html#def-mbt" data-sym="MBT">mbt</a> (if (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> (head keys) map)
         <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
         nil)) (insert (lookup (head keys) map)
        (lookup* (tail keys) map)))
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (lookup* (tail keys) map)))
  <span class="keyword">:verify-guards</span> nil
  ///
  (<a class="sym-link system" href="../../../axioms.html#def-verify-guards" data-sym="VERIFY-GUARDS">verify-guards</a> lookup*
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable in*))))
  (defrule lookup*-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp keys)
      (equal (lookup* keys map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defrule lookup*-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (lookup* keys map) nil))))</pre>
  </div>

<div class="form-block other" id="form-31" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define list-lookup
  ((keys <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>) (map mapp))
  <span class="keyword">:guard</span> (list-in keys map)
  <span class="keyword">:returns</span> (vals <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>)
  <span class="keyword">:short</span> <span class="string">"List of values associated to a list of keys in an omap."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="../../../axioms.html#def-endp" data-sym="ENDP">endp</a> keys) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (cons (lookup (car keys) map)
        (list-lookup (cdr keys) map))))
  <span class="keyword">:guard-hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable list-in)))
  ///
  (defruled list-lookup-of-cons
    (equal (list-lookup (cons key keys) map)
      (cons (lookup key map)
        (list-lookup keys map))))
  (defruled list-lookup-of-append
    (equal (list-lookup (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> keys1 keys2) map)
      (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> (list-lookup keys1 map)
        (list-lookup keys2 map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> <a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a>)
  (defruled list-lookup-of-rev
    (equal (list-lookup (rev keys) map)
      (rev (list-lookup keys map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> (rev list-lookup-of-append))
  (defruled list-lookup-of-update*-when-list-in
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (list-in keys map1)
      (equal (list-lookup keys
          (update* map1 map2))
        (list-lookup keys map1)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> (list-in lookup-of-update*))
  (defruled list-lookup-of-update*-when-list-notin
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (list-notin keys map1)
      (equal (list-lookup keys
          (update* map1 map2))
        (list-lookup keys (mfix map2))))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> (list-notin lookup-of-update*))
  (defruled list-lookup-of-update-of-non-member
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-member-equal" data-sym="MEMBER-EQUAL">member-equal</a> key keys))
      (equal (list-lookup keys
          (update key val map))
        (list-lookup keys map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> lookup-of-update))</pre>
  </div>

<div class="form-block other" id="form-32" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define rlookup
  (val (map mapp))
  <span class="keyword">:returns</span> (keys setp)
  <span class="keyword">:short</span> <span class="string">"Set of keys to which a value is associated."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"The resulting set is empty if the value is not in the omap.
     The resulting set is a singleton
     if the value is associated to exactly one key.
     Otherwise, the resulting set contains two or more keys."</span>)
    (p <span class="string">"This is the ``reverse&#39;&#39; of @(tsee lookup),
     which motivates the @(&#39;r&#39;) in the name."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key0 val0)
        (head map)
        (if (equal val val0)
          (insert key0
            (rlookup val (tail map)))
          (rlookup val (tail map))))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule rlookup-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (rlookup val map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>)))</pre>
  </div>

<div class="form-block other" id="form-33" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define rlookup*
  ((vals setp) (map mapp))
  <span class="keyword">:returns</span> (keys setp)
  <span class="keyword">:short</span> <span class="string">"Set of keys to which any value in a set is associated."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This lifts @(tsee rlookup*) to sets of values."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp vals) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (union (rlookup (head vals) map)
        (rlookup* (tail vals) map))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule rlookup*-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp vals)
      (equal (rlookup* vals map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defrule rlookup*-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (rlookup* vals map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>)))</pre>
  </div>

<div class="form-block other" id="form-34" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define restrict
  ((keys setp) (map mapp))
  <span class="keyword">:returns</span> (map1 mapp)
  <span class="keyword">:short</span> <span class="string">"Restrict an omap to a set of keys."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This drops all the keys of the omap
    that are not in the given set of keys."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key val)
        (head map)
        (if (in key keys)
          (update key
            val
            (restrict keys (tail map)))
          (restrict keys (tail map))))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule restrict-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp keys)
      (equal (restrict keys map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defrule restrict-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (restrict keys map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defruled assoc-of-restrict
    (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (restrict keys map))
      (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (in key keys) (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))))
  (defruled assoc-of-restrict-when-in-keys
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (in key keys)
      (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key (restrict keys map))
        (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))))</pre>
  </div>

<div class="form-block other" id="form-35" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define keys
  ((map mapp))
  <span class="keyword">:returns</span> (keys setp
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable mfix mapp setp))))
  <span class="keyword">:short</span> <span class="string">"Oset of the keys of an omap."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key val)
        (head map)
        (declare (ignore val))
        (insert key (keys (tail map))))))
  ///
  (defrule keys-of-mfix
    (equal (keys (mfix map)) (keys map))
    <span class="keyword">:enable</span> keys)
  (defrule keys-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map)
      (equal (keys map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>)
    <span class="keyword">:enable</span> emptyp)
  (defruled keys-iff-not-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-iff" data-sym="IFF">iff</a> (keys map) (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))))
  (defruled assoc-to-in-of-keys
    (<a class="sym-link system" href="../../../axioms.html#def-iff" data-sym="IFF">iff</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)
      (in key (keys map)))
    <span class="keyword">:enable</span> <a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a>)
  (defruled in-of-keys-to-assoc
    (equal (in key (keys map))
      (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))
    <span class="keyword">:enable</span> <a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a>)
  (theory-invariant (incompatible (<span class="keyword">:rewrite</span> assoc-to-in-of-keys)
      (<span class="keyword">:rewrite</span> in-of-keys-to-assoc)))
  (defruled in-of-keys-to-assoc-under-iff
    (<a class="sym-link system" href="../../../axioms.html#def-iff" data-sym="IFF">iff</a> (in key (keys map))
      (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))
    <span class="keyword">:enable</span> <a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a>)
  (theory-invariant (incompatible (<span class="keyword">:rewrite</span> assoc-to-in-of-keys)
      (<span class="keyword">:rewrite</span> in-of-keys-to-assoc-under-iff)))
  (defrule assoc-when-in-of-keys-forward-chaining
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (in key (keys map))
      (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map))
    <span class="keyword">:rule-classes</span> <span class="keyword">:forward-chaining</span>)
  (defrule set-emptyp-of-keys
    (equal (emptyp (keys map)) (emptyp map)))
  (defruled list-in-to-subset-keys
    (<a class="sym-link system" href="../../../axioms.html#def-iff" data-sym="IFF">iff</a> (list-in keys map)
      (subset (mergesort keys) (keys map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> (mergesort list-in assoc-to-in-of-keys))
  (defruled in-keys-when-assoc-forward
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)
      (in key (keys map)))
    <span class="keyword">:rule-classes</span> <span class="keyword">:forward-chaining</span>)
  (defruled in-keys-when-assoc-is-cons
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> a m) (cons a b))
      (in a (keys m))))
  (defrule keys-of-update
    (equal (keys (update key val m))
      (insert key (keys m)))
    <span class="keyword">:enable</span> (expensive-rules in-of-keys-to-assoc))
  (defrule keys-of-update*
    (equal (keys (update* new old))
      (union (keys new) (keys old)))
    <span class="keyword">:enable</span> update*)
  (defrule keys-of-restrict
    (equal (keys (restrict keys map))
      (intersect keys (keys map)))
    <span class="keyword">:enable</span> (double-containment pick-a-point-subset-strategy)
    <span class="keyword">:prep-lemmas</span> ((defrule lemma1
       (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (in x
           (keys (restrict keys map)))
         (in x (keys map)))
       <span class="keyword">:enable</span> restrict) (defrule lemma2
        (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (in x
            (keys (restrict keys map)))
          (in x keys))
        <span class="keyword">:enable</span> restrict)
      (defrule lemma3
        (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (in x (keys map))
            (in x keys))
          (in x
            (keys (restrict keys map))))
        <span class="keyword">:enable</span> restrict)))
  (defrule head-key-not-in-keys-of-tail
    (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (in (<a class="sym-link system" href="../../../axioms.html#def-mv-nth" data-sym="MV-NTH">mv-nth</a> <span class="number">0</span> (head map))
        (keys (tail map))))
    <span class="keyword">:enable</span> in-of-keys-to-assoc))</pre>
  </div>

<div class="form-block other" id="form-36" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define values
  ((map mapp))
  <span class="keyword">:returns</span> (vals setp)
  <span class="keyword">:short</span> <span class="string">"Oset of the values of an omap."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key val)
        (head map)
        (declare (ignore key))
        (insert val (values (tail map))))))
  <span class="keyword">:verify-guards</span> <span class="keyword">:after-returns</span> ///
  (defrule values-when-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map) (equal (values map) nil))
    <span class="keyword">:rule-classes</span> (<span class="keyword">:rewrite</span> <span class="keyword">:type-prescription</span>))
  (defruled in-values-when-assoc
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> a m) (cons a b))
      (in b (values m))))
  (defrule values-of-update-when-not-assoc
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (consp (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key map)))
      (equal (values (update key val map))
        (insert val (values map))))))</pre>
  </div>

<div class="form-block other" id="form-37" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define compatiblep
  ((map1 mapp) (map2 mapp))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Check if two omaps are compatible, in the sense that
          they map their common keys to the same values."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This definition is not optimal for execution.
    The compatibility of two omaps can be checked
    by linearly scanning through them in order.
    A future version of this operation should have that definition,
    at least for execution."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map1) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
    ((<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key1 val1)
       (head map1)
       (let ((pair2 (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key1 map2)))
         (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> pair2 (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (equal val1 (cdr pair2)))))) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (compatiblep (tail map1) map2)))
  ///
  (defrule compatiblep-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map1)
      (compatiblep map1 map2)))
  (defrule compatiblep-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp map2)
      (compatiblep map1 map2))))</pre>
  </div>

<div class="form-block other" id="form-38" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define submap
  ((sub mapp) (sup mapp))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:short</span> <span class="string">"Check if an omap is a submap of another omap."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is true when every key in the first omap is also in the second omap,
     and the two omaps agree on the common keys."</span>)
    (p <span class="string">"This is similar to @(tsee set::subset) for osets."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp sub) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (key val)
        (head sub)
        (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-assoc" data-sym="ASSOC">assoc</a> key sup)
            (cons key val))
          (submap (tail sub) sup)))))
  ///
  (defrule submap-when-left-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp sub)
      (submap sub sup)))
  (defrule submap-when-right-emptyp
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (emptyp sup)
      (equal (submap sub sup)
        (emptyp sub)))))</pre>
  </div>

<div class="form-block other" id="form-39" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define size
  ((map mapp))
  <span class="keyword">:returns</span> (size <a class="sym-link system" href="../../../axioms.html#def-natp" data-sym="NATP">natp</a>)
  <span class="keyword">:short</span> <span class="string">"Size of an omap."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is the number of keys in the omap."</span>)
    (p <span class="string">"The @(&#39;unfold-...-size-const&#39;) are useful to turn
     assertions about sizes and constants
     into assertions about @(tsee emptyp) and @(tsee tail);
     the expansion terminates because of the @(tsee syntaxp) restriction.
     These theorems are disabled by default.
     These are the omap analogous of "</span>
      (seetopic <span class="string">"acl2::list-len-const-theorems"</span>
        <span class="string">"these theorems"</span>)
      <span class="string">" for lists."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map) <span class="number">0</span>)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-1_2B" data-sym="1+">1+</a> (size (tail map)))))
  ///
  (defruled unfold-equal-size-const
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-syntaxp" data-sym="SYNTAXP">syntaxp</a> (<a class="sym-link system" href="../../../axioms.html#def-quotep" data-sym="QUOTEP">quotep</a> c))
      (equal (equal (size map) c)
        (if (<a class="sym-link system" href="../../../axioms.html#def-natp" data-sym="NATP">natp</a> c)
          (if (equal c <span class="number">0</span>)
            (emptyp map)
            (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
              (equal (size (tail map)) (<a class="sym-link system" href="../../../axioms.html#def-1-" data-sym="1-">1-</a> c))))
          nil))))
  (defruled unfold-gteq-size-const
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-syntaxp" data-sym="SYNTAXP">syntaxp</a> (<a class="sym-link system" href="../../../axioms.html#def-quotep" data-sym="QUOTEP">quotep</a> c))
      (equal (<a class="sym-link system" href="../../../axioms.html#def-_3E_3D" data-sym="&gt;=">&gt;=</a> (size map) c)
        (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> (<a class="sym-link system" href="../../../axioms.html#def-fix" data-sym="FIX">fix</a> c) <span class="number">0</span>)
          (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
            (<a class="sym-link system" href="../../../axioms.html#def-_3E_3D" data-sym="&gt;=">&gt;=</a> (size (tail map)) (<a class="sym-link system" href="../../../axioms.html#def-1-" data-sym="1-">1-</a> c)))))))
  (defruled unfold-gt-size-const
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-syntaxp" data-sym="SYNTAXP">syntaxp</a> (<a class="sym-link system" href="../../../axioms.html#def-quotep" data-sym="QUOTEP">quotep</a> c))
      (equal (<a class="sym-link system" href="../../../axioms.html#def-_3E" data-sym="&gt;">&gt;</a> (size map) c)
        (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (&lt; (<a class="sym-link system" href="../../../axioms.html#def-fix" data-sym="FIX">fix</a> c) <span class="number">0</span>)
          (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
            (<a class="sym-link system" href="../../../axioms.html#def-_3E" data-sym="&gt;">&gt;</a> (size (tail map)) (<a class="sym-link system" href="../../../axioms.html#def-1-" data-sym="1-">1-</a> c))))))
    <span class="keyword">:use</span> lemma
    <span class="keyword">:prep-lemmas</span> ((defrule lemma
       (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (emptyp map))
           (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (&lt; (<a class="sym-link system" href="../../../axioms.html#def-fix" data-sym="FIX">fix</a> c) <span class="number">0</span>)
             (<a class="sym-link system" href="../../../axioms.html#def-_3E" data-sym="&gt;">&gt;</a> (size (tail map)) (<a class="sym-link system" href="../../../axioms.html#def-1-" data-sym="1-">1-</a> c))))
         (<a class="sym-link system" href="../../../axioms.html#def-_3E" data-sym="&gt;">&gt;</a> (size map) c))
       <span class="keyword">:rule-classes</span> nil)))
  (defrule equal-of-omap-size-and-0
    (equal (equal (size map) <span class="number">0</span>) (emptyp map))
    <span class="keyword">:expand</span> (size map))
  (defruled size-to-cardinality-of-keys
    (equal (size map) (cardinality (keys map)))
    <span class="keyword">:induct</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:enable</span> (size keys expensive-rules))
  (defruled cardinality-of-keys-to-size
    (equal (cardinality (keys map)) (size map))
    <span class="keyword">:enable</span> size-to-cardinality-of-keys)
  (theory-invariant (incompatible (<span class="keyword">:rewrite</span> size-to-cardinality-of-keys)
      (<span class="keyword">:rewrite</span> cardinality-of-keys-to-size))))</pre>
  </div>

<div class="form-block other" id="form-40" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define from-lists
  ((keys <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>) (vals <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-_3D" data-sym="=">=</a> (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> keys) (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> vals))
  <span class="keyword">:returns</span> (map mapp)
  <span class="keyword">:short</span> <span class="string">"Build an omap from
          a list of keys and a list of corresponding values."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"If there are duplicate keys in the first list,
     the leftmost key, and the corresponding value,
     will be in the resulting omap."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="../../../axioms.html#def-endp" data-sym="ENDP">endp</a> keys) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (update (car keys)
        (car vals)
        (from-lists (cdr keys) (cdr vals)))))
  ///
  (defruled list-lookup-of-from-lists-of-append-first
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> keys1) (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> vals1))
        (<a class="sym-link system" href="../../../axioms.html#def-no-duplicatesp-equal" data-sym="NO-DUPLICATESP-EQUAL">no-duplicatesp-equal</a> keys1))
      (equal (list-lookup keys1
          (from-lists (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> keys1 keys2)
            (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> vals1 vals2)))
        (<a class="sym-link system" href="../../../axioms.html#def-true-list-fix" data-sym="TRUE-LIST-FIX">true-list-fix</a> vals1)))
    <span class="keyword">:induct</span> (cdr-cdr-induct keys1 vals1)
    <span class="keyword">:enable</span> (list-lookup lookup-of-update
      list-lookup-of-update-of-non-member))
  (defruled list-lookup-of-from-lists-of-append-second
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (equal (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> keys1) (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> vals1))
        (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-intersectp-equal" data-sym="INTERSECTP-EQUAL">intersectp-equal</a> keys keys1)))
      (equal (list-lookup keys
          (from-lists (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> keys1 keys2)
            (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> vals1 vals2)))
        (list-lookup keys
          (from-lists keys2 vals2))))
    <span class="keyword">:induct</span> (cdr-cdr-induct keys1 vals1)
    <span class="keyword">:enable</span> (list-lookup list-lookup-of-update-of-non-member)))</pre>
  </div>

<div class="form-block other" id="form-41" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define from-alist
  ((alist <a class="sym-link system" href="../../../axioms.html#def-alistp" data-sym="ALISTP">alistp</a>))
  <span class="keyword">:returns</span> (map mapp)
  <span class="keyword">:short</span> <span class="string">"Build an omap from an alist."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"If there are duplicate keys in the alist,
     the leftmost one, with the corresponding value,
     will be in the resulting omap.
     This is consistent with the shadowing of alists."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="../../../axioms.html#def-endp" data-sym="ENDP">endp</a> alist) nil)
    (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (update (<a class="sym-link system" href="../../../axioms.html#def-caar" data-sym="CAAR">caar</a> alist)
        (<a class="sym-link system" href="../../../axioms.html#def-cdar" data-sym="CDAR">cdar</a> alist)
        (from-alist (cdr alist))))))</pre>
  </div>

<div class="form-block other" id="form-42" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection omap-induction2
  <span class="keyword">:short</span> <span class="string">"Induction on two omaps, applying @(tsee tail) to both."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> omap-induction2
    (map1 map2)
    (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((emptyp map1) nil)
      ((emptyp map2) nil)
      (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (omap-induction2 (tail map1)
          (tail map2))))))</pre>
  </div>


  </main>
  
<script>
// ACL2 Book HTML Documentation - Interactive Features
// Generated by cert2 - build2 system

// State
let activeFilter = null;
let activePartFilter = null;
let activeNameFilter = null;
let currentFontSize = 14;

// Theme management
function getStoredTheme() {
  return localStorage.getItem('acl2-theme') || 'dark';
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('theme-toggle').textContent = '🌙';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('theme-toggle').textContent = '☀️';
  }
  localStorage.setItem('acl2-theme', theme);
}

function toggleTheme() {
  const current = getStoredTheme();
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Font size management
function getStoredFontSize() {
  return parseInt(localStorage.getItem('acl2-fontsize') || '14', 10);
}

function setFontSize(size) {
  size = Math.max(10, Math.min(24, size)); // Clamp between 10-24
  currentFontSize = size;
  document.body.style.fontSize = size + 'px';
  localStorage.setItem('acl2-fontsize', size.toString());
}

function increaseFontSize() {
  setFontSize(currentFontSize + 2);
}

function decreaseFontSize() {
  setFontSize(currentFontSize - 2);
}

// Get all form blocks
function getFormBlocks() {
  return document.querySelectorAll('.form-block');
}

// Clear all filters
function clearFilter() {
  activeFilter = null;
  activePartFilter = null;
  activeNameFilter = null;
  getFormBlocks().forEach(b => {
    b.classList.remove('hidden', 'dimmed');
  });
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  const status = document.querySelector('.filter-status');
  status.classList.remove('active');
  // Slide name filter back to original position
  document.querySelector('.controls-left').style.transform = '';
  // Clear the name filter input
  const nameInput = document.getElementById('name-filter');
  if (nameInput) nameInput.value = '';
}

// Show filter status and slide name filter right
function showFilterStatus(text) {
  const status = document.querySelector('.filter-status');
  status.classList.add('active');
  status.querySelector('.filter-text').textContent = text;
  // Slide name filter to the right to make room
  setTimeout(() => {
    const statusWidth = status.offsetWidth;
    document.querySelector('.controls-left').style.transform = `translateX(${statusWidth + 15}px)`;
  }, 10);
}

// Filter to show only forms that define or reference a symbol
function filterBySymbol(symName, showUsedBy) {
  clearFilter();
  activeFilter = symName;
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines;
    const references = (block.dataset.references || '').split(',');
    const usedBy = (block.dataset.usedBy || '').split(',');
    
    let show = false;
    if (showUsedBy) {
      // Show forms that USE this symbol
      show = references.includes(symName) || definesName === symName;
    } else {
      // Show forms that this symbol USES
      show = usedBy.includes(symName) || definesName === symName;
    }
    
    if (show) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering by: ${symName} (${visibleCount} items)`);
}

// Filter by defthm part (term, hints, rule-classes, etc.)
function filterByPart(formId, partName) {
  clearFilter();
  activePartFilter = { formId, partName };
  
  // Get the part's referenced symbols
  // data-part-term becomes dataset.partTerm, data-part-hints becomes dataset.partHints, etc.
  const block = document.getElementById(formId);
  const datasetKey = 'part' + partName.charAt(0).toUpperCase() + partName.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase());
  const partData = block.dataset[datasetKey];
  if (!partData) return;
  
  const partSyms = partData.split(',').filter(s => s);
  
  // Highlight the button
  block.querySelector(`.part-btn[data-part="${partName}"]`).classList.add('active');
  
  // Hide forms not referenced by this part
  getFormBlocks().forEach(b => {
    const definesName = b.dataset.defines;
    if (b.id === formId || partSyms.includes(definesName)) {
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering ${formId} :${partName} (${partSyms.length} references)`);
}

// Filter by name (substring or regex)
function filterByName(pattern, useRegex) {
  // Clear other filters but keep the input value
  activeFilter = null;
  activePartFilter = null;
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  
  if (!pattern || pattern.trim() === '') {
    // Empty pattern - show all
    activeNameFilter = null;
    getFormBlocks().forEach(b => b.classList.remove('hidden'));
    const status = document.querySelector('.filter-status');
    status.classList.remove('active');
    document.querySelector('.controls-left').style.transform = '';
    return;
  }
  
  activeNameFilter = pattern;
  
  let matcher;
  let isValidRegex = true;
  
  if (useRegex) {
    try {
      matcher = new RegExp(pattern, 'i');
    } catch (e) {
      // Invalid regex - show error in status and don't filter
      showFilterStatus(`Invalid regex: ${e.message}`);
      return;
    }
  } else {
    // Plain substring match (case-insensitive)
    const lowerPattern = pattern.toLowerCase();
    matcher = { test: (s) => s.toLowerCase().includes(lowerPattern) };
  }
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines || '';
    if (matcher.test(definesName)) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  const modeText = useRegex ? 'regex' : 'name';
  showFilterStatus(`Filtering by ${modeText}: "${pattern}" (${visibleCount} matches)`);
}

// Click on a name to show what references it
function handleNameClick(symName) {
  if (activeFilter === symName) {
    clearFilter();
  } else {
    filterBySymbol(symName, true);
  }
}

// Navigate to a definition (same file or different)
function navigateTo(symName, file) {
  if (file) {
    // External file - navigate
    window.location.href = file + '.html#def-' + symName.toLowerCase();
  } else {
    // Same file - scroll
    const target = document.getElementById('def-' + symName.toLowerCase());
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('highlight');
      setTimeout(() => target.classList.remove('highlight'), 400);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Part buttons
  document.querySelectorAll('.part-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const formId = btn.closest('.form-block').id;
      const partName = btn.dataset.part;
      if (activePartFilter && activePartFilter.formId === formId && 
          activePartFilter.partName === partName) {
        clearFilter();
      } else {
        filterByPart(formId, partName);
      }
    });
  });
  
  // Clear filter button
  document.querySelector('.clear-filter').addEventListener('click', clearFilter);
  
  // Name filter input
  const nameFilter = document.getElementById('name-filter');
  const regexToggle = document.getElementById('regex-toggle');
  
  let filterTimeout = null;
  nameFilter.addEventListener('input', () => {
    // Debounce the filter to avoid excessive updates while typing
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      filterByName(nameFilter.value, regexToggle.checked);
    }, 150);
  });
  
  // Re-filter when regex toggle changes
  regexToggle.addEventListener('change', () => {
    if (nameFilter.value) {
      filterByName(nameFilter.value, regexToggle.checked);
    }
  });
  
  // Allow Escape key to clear filter when in input
  nameFilter.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearFilter();
      nameFilter.blur();
    }
  });
  
  // Symbol references (old span-based refs)
  document.querySelectorAll('.sym-ref').forEach(ref => {
    ref.addEventListener('click', (e) => {
      e.stopPropagation();
      const sym = ref.dataset.sym;
      const file = ref.dataset.file;
      if (file) {
        navigateTo(sym, file);
      } else {
        handleNameClick(sym);
      }
    });
  });
  
  // Symbol links (new anchor-based links)
  // These use standard <a> tags so navigation happens automatically
  // But we need to clear filters if target would be hidden
  document.querySelectorAll('.sym-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('#')) {
        // Local link - check if target is hidden by filter
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          // If target is hidden, clear the filter first
          if (target.classList.contains('hidden')) {
            clearFilter();
          }
          // Add highlight effect after a short delay
          setTimeout(() => {
            target.classList.add('highlight');
            setTimeout(() => target.classList.remove('highlight'), 400);
          }, 100);
        }
      }
      // For external links, default behavior handles navigation
    });
  });
  
  // Form names (show what uses them)
  document.querySelectorAll('.form-name').forEach(name => {
    name.addEventListener('click', (e) => {
      handleNameClick(name.dataset.sym);
    });
  });
  
  // Handle hash navigation (when arriving at page with #anchor)
  if (window.location.hash) {
    const target = document.querySelector(window.location.hash);
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.classList.add('highlight');
        setTimeout(() => target.classList.remove('highlight'), 400);
      }, 200);
    }
  }
  
  // Initialize theme from storage
  setTheme(getStoredTheme());
  
  // Initialize font size from storage
  currentFontSize = getStoredFontSize();
  setFontSize(currentFontSize);
  
  // Theme toggle button
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  
  // Font size buttons
  document.getElementById('font-larger').addEventListener('click', increaseFontSize);
  document.getElementById('font-smaller').addEventListener('click', decreaseFontSize);
});

</script>

</body>
</html>