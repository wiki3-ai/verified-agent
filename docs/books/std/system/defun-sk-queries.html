<!DOCTYPE html>
<html lang="en" vocab="http://schema.org/" typeof="SoftwareSourceCode">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>defun-sk-queries - ACL2 Book</title>
  <meta property="name" content="defun-sk-queries">
  <meta property="programmingLanguage" content="ACL2">
  
<style>
/* ACL2 Book HTML Documentation Styles */
/* Generated by cert2 - build2 system */

/* Dark theme (default) */
:root {
  --bg: #1e1e2e;
  --fg: #cdd6f4;
  --comment: #6c7086;
  --keyword: #cba6f7;
  --string: #a6e3a1;
  --function: #89b4fa;
  --type: #f9e2af;
  --link: #89dceb;
  --link-hover: #f5c2e7;
  --highlight: rgba(137, 180, 250, 0.2);
  --border: #313244;
  --block-bg: rgba(49, 50, 68, 0.5);
  --btn-bg: #313244;
  --btn-hover: rgba(137, 180, 250, 0.2);
}

/* Light theme */
[data-theme="light"] {
  --bg: #eff1f5;
  --fg: #4c4f69;
  --comment: #6c6f85;
  --keyword: #8839ef;
  --string: #40a02b;
  --function: #1e66f5;
  --type: #df8e1d;
  --link: #04a5e5;
  --link-hover: #ea76cb;
  --highlight: rgba(30, 102, 245, 0.15);
  --border: #ccd0da;
  --block-bg: rgba(204, 208, 218, 0.3);
  --btn-bg: #ccd0da;
  --btn-hover: rgba(30, 102, 245, 0.15);
}

body {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  padding: 20px;
  line-height: 1.6;
  font-size: 14px;
  transition: background 0.1s, color 0.1s;
}

/* Controls toolbar */
.controls-left {
  position: fixed;
  top: 10px;
  left: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
  transition: transform 0.1s ease;
}

.controls-right {
  position: fixed;
  top: 10px;
  right: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
}

.control-btn {
  padding: 6px 12px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  transition: all 0.1s;
}

.control-btn:hover {
  background: var(--btn-hover);
  border-color: var(--link);
}

.name-filter {
  padding: 6px 10px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  width: 150px;
  transition: all 0.1s;
}

.name-filter:focus {
  outline: none;
  border-color: var(--link);
  width: 200px;
}

.name-filter::placeholder {
  color: var(--comment);
}

.regex-label {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--comment);
  font-size: 12px;
  cursor: pointer;
}

.regex-label input {
  cursor: pointer;
}

.book-header {
  border-bottom: 2px solid var(--border);
  padding-bottom: 20px;
  margin-bottom: 20px;
}

.book-header h1 {
  color: var(--keyword);
  margin: 0;
}

.book-header .path {
  color: var(--comment);
  font-size: 0.9em;
}

.book-header .path .source-link {
  color: var(--comment);
  text-decoration: none;
}

.book-header .path .source-link:hover {
  color: var(--link);
  text-decoration: underline;
}

.form-block {
  margin: 10px 0;
  padding: 15px;
  background: var(--block-bg);
  border-radius: 8px;
  border-left: 3px solid var(--border);
}

.form-block.theorem { border-left-color: var(--keyword); }
.form-block.function { border-left-color: var(--function); }
.form-block.macro { border-left-color: var(--type); }
.form-block.include-book { border-left-color: var(--string); }

.form-block.hidden { display: none; }
.form-block.dimmed { opacity: 0.3; }

.form-block.highlight {
  animation: highlight-pulse 0.4s ease-out;
}

@keyframes highlight-pulse {
  0% { background: var(--highlight); box-shadow: 0 0 20px var(--link); }
  100% { background: rgba(49, 50, 68, 0.5); box-shadow: none; }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.form-name {
  color: var(--function);
  font-weight: bold;
  cursor: pointer;
}

.form-name:hover {
  color: var(--link-hover);
  text-decoration: underline;
}

.form-type {
  color: var(--comment);
  font-size: 0.85em;
}

pre.code {
  margin: 0;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.sym-ref {
  color: var(--link);
  cursor: pointer;
  border-radius: 2px;
}

.sym-ref:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.sym-ref.local-def { color: var(--function); font-weight: bold; }
.sym-ref.external { color: var(--type); }

/* Symbol links (clickable hyperlinks) */
.sym-link {
  color: var(--link);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.sym-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

.sym-link.local-def {
  color: var(--function);
  font-weight: bold;
}

.sym-link.external {
  color: var(--type);
}

/* Tooltips using title attribute with custom styling */
.sym-link[title] {
  /* Browser will show title on hover */
}

/* Syntax highlighting in code blocks */
.keyword {
  color: var(--keyword);
}

.string {
  color: var(--string);
}

.number {
  color: #f77524; /* orange */
}

/* Include-book path links */
.include-path {
  color: var(--string);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
}

.include-path:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

/* Part buttons for defthm */
.part-buttons {
  display: flex;
  gap: 5px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.part-btn {
  padding: 4px 10px;
  background: var(--border);
  border: 1px solid var(--comment);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
}

.part-btn:hover {
  background: var(--highlight);
  border-color: var(--link);
}

.part-btn.active {
  background: var(--link);
  color: var(--bg);
  border-color: var(--link);
}

/* References panel */
.refs-panel {
  margin-top: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  display: none;
}

.refs-panel.visible { display: block; }

.refs-panel h4 {
  margin: 0 0 5px 0;
  color: var(--comment);
  font-size: 0.9em;
}

.refs-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* Included books section */
.includes-section {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(49, 50, 68, 0.3);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.includes-section h2 {
  margin: 0 0 10px 0;
  color: var(--comment);
  font-size: 1em;
  font-weight: normal;
}

.includes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.include-link {
  padding: 6px 12px;
  background: var(--border);
  border-radius: 4px;
  color: var(--link);
  text-decoration: none;
  font-size: 0.9em;
  transition: all 0.1s;
}

.include-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.include-link.local {
  border-left: 2px solid var(--comment);
}

/* Filter status */
.filter-status {
  position: fixed;
  top: 10px;
  left: 20px;
  background: var(--bg);
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  z-index: 201;
  display: none;
  align-items: center;
  gap: 10px;
}

.filter-status.active {
  display: flex;
  align-items: center;
  gap: 10px;
}

.clear-filter {
  padding: 5px 15px;
  background: var(--keyword);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* RDFa vocab indicator */
[vocab] { /* semantic web annotations present */ }

</style>

</head>
<body>
  <div class="controls-left">
    <input type="text" id="name-filter" class="name-filter" placeholder="Filter by name..." title="Filter definitions by name">
    <label class="regex-label"><input type="checkbox" id="regex-toggle"> regex</label>
  </div>

  <div class="controls-right">
    <button class="control-btn" id="theme-toggle" title="Toggle light/dark theme">‚òÄÔ∏è</button>
    <button class="control-btn" id="font-smaller" title="Decrease font size">A-</button>
    <button class="control-btn" id="font-larger" title="Increase font size">A+</button>
  </div>

  <div class="filter-status">
    <span class="filter-text">Filtering...</span>
    <button class="clear-filter">Clear Filter</button>
  </div>
  
  <div class="book-header">
    <h1 property="name">defun-sk-queries</h1>
    <div class="path"><a href="defun-sk-queries.lisp" class="source-link">books/std/system/defun-sk-queries</a></div>
  </div>
  
  <main property="text">
  <div class="includes-section">
    <h2>Included Books</h2>
    <div class="includes-list">
      <a class="include-link" href="function-namep.html" title="function-namep">function-namep</a>
      <a class="include-link" href="non-executablep.html" title="non-executablep">non-executablep</a>
      <a class="include-link" href="thm-formula.html" title="thm-formula">thm-formula</a>
      <a class="include-link" href="ubody.html" title="ubody">ubody</a>
      <a class="include-link" href="../../std/util/defenum.html" title="std/util/defenum">defenum</a>
      <a class="include-link" href="../../xdoc/defxdoc-plus.html" title="xdoc/defxdoc-plus">defxdoc-plus</a>
    </div>
  </div>

<div class="form-block other" id="form-0" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-in-package" data-sym="IN-PACKAGE">in-package</a> <span class="string">"ACL2"</span>)</pre>
  </div>

<div class="form-block include-book" id="form-1" typeof="Code">
    <div class="form-header"><span class="form-type">include-book</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="function-namep.html" title="Open function-namep">"function-namep"</a>)</pre>
  </div>

<div class="form-block include-book" id="form-2" typeof="Code">
    <div class="form-header"><span class="form-type">include-book</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="non-executablep.html" title="Open non-executablep">"non-executablep"</a>)</pre>
  </div>

<div class="form-block include-book" id="form-3" typeof="Code">
    <div class="form-header"><span class="form-type">include-book</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="thm-formula.html" title="Open thm-formula">"thm-formula"</a>)</pre>
  </div>

<div class="form-block include-book" id="form-4" typeof="Code">
    <div class="form-header"><span class="form-type">include-book</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="ubody.html" title="Open ubody">"ubody"</a>)</pre>
  </div>

<div class="form-block include-book" id="form-5" typeof="Code">
    <div class="form-header"><span class="form-type">include-book</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/util/defenum.html" title="Open std/util/defenum">"std/util/defenum"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block include-book" id="form-6" typeof="Code">
    <div class="form-header"><span class="form-type">include-book</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../xdoc/defxdoc-plus.html" title="Open xdoc/defxdoc-plus">"xdoc/defxdoc-plus"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-7" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defxdoc+ defun-sk-queries
  <span class="keyword">:parents</span> (std/system/function-queries defun-sk)
  <span class="keyword">:short</span> <span class="string">"Utilities to query @(tsee defun-sk) functions."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"@(tsee defun-sk) mimics functions with (top-level) quantifiers
     in the quantifier-free logic of ACL2, by "</span>
      (seetopic <span class="string">"defchoose"</span> <span class="string">"conservatively axiomatizing"</span>)
      <span class="string">" an associated witness function
     and by defining the @(tsee defun-sk) function
     in terms of the witness function
     (either via an actual definition,
     or via a definition rule if @(&#39;:constrain&#39;) is not @(&#39;nil&#39;)).
     It also generates a rewrite rule to support reasoning
     about the function with the quantifier."</span>)
    (p <span class="string">"These @(tsee defun-sk) query utilities provide facilities
     to check whether a function has been introduced via @(tsee defun-sk),
     and, if so, to retrieve its @(tsee defun-sk)-specific constituents.
     Constituents of the function that are not @(tsee defun-sk)-specific
     (formal arguments, guard, etc.)
     can be retrieved with "</span>
      (seetopic <span class="string">"system-utilities"</span> <span class="string">"more general utilities"</span>)
      <span class="string">". Since @(tsee defun-sk) extends the @(tsee pe-table)
     with the @(tsee defun-sk) form,
     these utilities consult the @(tsee pe-table) to determine whether
     a function has been introduced by @(tsee defun-sk),
     and if that is the case, the @(tsee defun-sk)-specific components
     are retrieved based on the expected structure of
     the @(tsee defun-sk) form and of the forms it generates
     (@(tsee encapsulate), @(tsee defchoose), etc.).
     Thus, if the @(tsee pe-table) is extended
     with a form starting with @(tsee defun-sk)
     without using @(tsee defun-sk)
     (by directly calling @(tsee extend-pe-table)),
     these utilities, as currently implemented,
     can be fooled and return meaningless results.
     (These utilities could be extended to defensively check
     that the form and its expansion have the right structure,
     if that becomes important.)"</span>))
  <span class="keyword">:order-subtopics</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
  <span class="keyword">:default-parent</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-8" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link external" href="../util/defenum.html#def-defenum" data-sym="DEFENUM">defenum</a> defun-sk-quantifier-p
  (exists forall)
  <span class="keyword">:short</span> (topstring (seetopic <span class="string">"exists"</span> <span class="string">"Existential"</span>)
    <span class="string">" and "</span>
    (seetopic <span class="string">"forall"</span> <span class="string">"universal"</span>)
    <span class="string">" quantifiers."</span>)
  <span class="keyword">:long</span> (topstring-p <span class="string">"Note that these are in the &quot;ACL2&quot; package."</span>))</pre>
  </div>

<div class="form-block other" id="form-9" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link external" href="../util/defenum.html#def-defenum" data-sym="DEFENUM">defenum</a> defun-sk-rewrite-kind-p
  (<span class="keyword">:default</span> <span class="keyword">:direct</span> <span class="keyword">:custom</span>)
  <span class="keyword">:short</span> (topstring <span class="string">"Kinds of rewrite rules associated to
           @(tsee defun-sk) functions with the "</span>
    (seetopic <span class="string">"forall"</span> <span class="string">"universal quantifier"</span>)
    <span class="string">"."</span>)
  <span class="keyword">:long</span> (topstring-p <span class="string">"These correspond to the values
    of the @(&#39;:rewrite&#39;) option of @(tsee defun-sk),
    with @(&#39;:custom&#39;) standing for
    anything but @(&#39;:default&#39;) or @(&#39;:direct&#39;)."</span>))</pre>
  </div>

<div class="form-block other" id="form-10" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-p
  ((fn symbolp) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (defun-sk-form? <span class="string">"A @(tsee maybe-pseudo-event-formp)."</span>)
  <span class="keyword">:verify-guards</span> nil
  <span class="keyword">:short</span> <span class="string">"Check if a named function has been introduced via @(tsee defun-sk),
          returning the function&#39;s @(tsee defun-sk) form if the check succeeds."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"If the check fails, @(&#39;nil&#39;) is returned."</span>)
    (p <span class="string">"As explained "</span>
      (seetopic <span class="string">"defun-sk-queries"</span> <span class="string">"here"</span>)
      <span class="string">", we consult the @(tsee pe-table).
     If the @(tsee defun-sk) is generated by some other macros
     that also extends the table,
     the @(tsee defun-sk) form is not the only one
     associated to @(&#39;fn&#39;) in the table.
     But it should be always the last one in the table entry for @(&#39;fn&#39;)
     (which is an alist from absolute event numbers to forms),
     because none of the forms generated by @(tsee defun-sk) extends the table,
     and newer forms (generated by the hypothesized other macro
     that generates the @(tsee defun-sk)) are @(tsee cons)ed onto the entry."</span>)
    (p <span class="string">"This utility causes an error if called on a symbol
     that is not a function symbol."</span>))
  (b* (((unless (<a class="sym-link system" href="../../../axioms.html#def-function-symbolp" data-sym="FUNCTION-SYMBOLP">function-symbolp</a> fn wrld)) (raise <span class="string">"The symbol ~x0 does not name a function."</span> fn)) (<a class="sym-link system" href="../../../axioms.html#def-table" data-sym="TABLE">table</a> (<a class="sym-link system" href="../../../axioms.html#def-table-alist" data-sym="TABLE-ALIST">table-alist</a> 'pe-table wrld))
      (entry (cdr (<a class="sym-link system" href="../../../axioms.html#def-assoc-eq" data-sym="ASSOC-EQ">assoc-eq</a> fn <a class="sym-link system" href="../../../axioms.html#def-table" data-sym="TABLE">table</a>)))
      (last-number+form (car (<a class="sym-link system" href="../../../axioms.html#def-last" data-sym="LAST">last</a> entry)))
      (last-form (cdr last-number+form)))
    (if (<a class="sym-link system" href="../../../axioms.html#def-eq" data-sym="EQ">eq</a> (car last-form) 'defun-sk)
      last-form
      nil)))</pre>
  </div>

<div class="form-block other" id="form-11" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-namep
  (x (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (yes/no <a class="sym-link system" href="../../../axioms.html#def-booleanp" data-sym="BOOLEANP">booleanp</a>)
  <span class="keyword">:verify-guards</span> nil
  <span class="keyword">:short</span> <span class="string">"Recognize symbols
          that name functions introduced via @(tsee defun-sk)."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This function is enabled because it is meant as an abbreviation.
    Thus, theorems triggered by this function should be avoided."</span>)
  (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (function-namep x wrld) (defun-sk-p x wrld) <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
  <span class="keyword">:enabled</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-12" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-body
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (<a class="sym-link system" href="../../../basis-b.html#def-body" data-sym="BODY">body</a> <span class="string">"A @(tsee pseudo-event-formp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the body of a function introduced via @(tsee defun-sk)."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"This is the sub-form @(&#39;(forall ...)&#39;) or @(&#39;(exists ...)&#39;)
     of the @(tsee defun-sk) form.
     Thus, the terms in this sub-from are untranslated."</span>)
    (p <span class="string">"In the @(tsee defun-sk) form, the body sub-form is obtained
     by first removing the keyed options (if any)
     and then taking the last element of the resulting list."</span>)
    (p <span class="string">"To retrieve the quantifier, bound variable, and matrix of this body, use
     @(tsee defun-sk-quantifier),
     @(tsee defun-sk-bound-vars),
     @(tsee defun-sk-matrix), and
     @(tsee defun-sk-imatrix)."</span>))
  (b* ((form (defun-sk-p fn wrld)) ((<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> erp form-without-keyed-options &amp;) (<a class="sym-link system" href="../../../basis-a.html#def-partition-rest-and-keyword-args" data-sym="PARTITION-REST-AND-KEYWORD-ARGS">partition-rest-and-keyword-args</a> form *defun-sk-keywords*))
      ((when erp) (raise <span class="string">"Internal error: ~
                           the DEFUN-SK form ~x0 of ~x1 is malformed."</span>
          form
          fn)))
    (car (<a class="sym-link system" href="../../../axioms.html#def-last" data-sym="LAST">last</a> form-without-keyed-options))))</pre>
  </div>

<div class="form-block other" id="form-13" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-quantifier
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (quantifier <span class="string">"A @(tsee defun-sk-quantifier-p)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the quantifier of
          a function introduced via @(tsee defun-sk)."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-first" data-sym="FIRST">first</a> (defun-sk-body fn wrld)))</pre>
  </div>

<div class="form-block other" id="form-14" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-bound-vars
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (<a class="sym-link system" href="../../../history-management.html#def-bound-vars" data-sym="BOUND-VARS">bound-vars</a> <span class="string">"A @(tsee symbol-listp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the bound variables of
          a function introduced via @(tsee defun-sk)."</span>
  (b* ((<a class="sym-link system" href="../../../basis-b.html#def-body" data-sym="BODY">body</a> (defun-sk-body fn wrld)) (var/vars (<a class="sym-link system" href="../../../axioms.html#def-second" data-sym="SECOND">second</a> <a class="sym-link system" href="../../../basis-b.html#def-body" data-sym="BODY">body</a>)))
    (if (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> var/vars)
      (<a class="sym-link system" href="../../../axioms.html#def-list" data-sym="LIST">list</a> var/vars)
      var/vars)))</pre>
  </div>

<div class="form-block other" id="form-15" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-imatrix
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (imatrix <span class="string">"An untranslated term."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the matrix of a function introduced via @(tsee defun-sk),
          in untranslated form."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"The @(&#39;i&#39;) that starts @(&#39;imatrix&#39;) in the name of this function
     conveys that the result is based on the @(tsee defun-sk) form
     that &lt;i&gt;introduced&lt;/i&gt; @(&#39;fn&#39;)."</span>)
    (p <span class="string">"Use @(tsee defun-sk-matrix) to retrieve the matrix in translated form."</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-third" data-sym="THIRD">third</a> (defun-sk-body fn wrld)))</pre>
  </div>

<div class="form-block other" id="form-16" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-witness
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (witness <span class="string">"A @(tsee symbolp)."</span>)
  <span class="keyword">:verify-guards</span> nil
  <span class="keyword">:short</span> <span class="string">"Retrieve the name of the witness of
          a function introduced via @(tsee defun-sk)."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"For a function introduced via @(tsee defun-sk),
    the name of the witness is the old @(&#39;constraint-lst&#39;) property, now
    found in the @(&#39;constraint-lst-etc&#39;) property.  Retrieving it from
    there is faster than calculating it from @(&#39;fn&#39;) and the options of
    the @(tsee defun-sk)."</span>)
  (<a class="sym-link system" href="../../../history-management.html#def-pre-v8-7-getpropc-constraint-lst-nil" data-sym="PRE-V8-7-GETPROPC-CONSTRAINT-LST-NIL">pre-v8-7-getpropc-constraint-lst-nil</a> fn wrld))</pre>
  </div>

<div class="form-block other" id="form-17" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-options
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (options <span class="string">"An @(tsee alistp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the keyed options of
          a function introduced via @(tsee defun-sk)."</span>
  (b* ((form (defun-sk-p fn wrld)) ((<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> erp &amp; options) (<a class="sym-link system" href="../../../basis-a.html#def-partition-rest-and-keyword-args" data-sym="PARTITION-REST-AND-KEYWORD-ARGS">partition-rest-and-keyword-args</a> form *defun-sk-keywords*))
      ((when erp) (raise <span class="string">"Internal error: ~
                           the DEFUN-SK form ~x0 of ~x1 is malformed."</span>
          form
          fn)))
    options))</pre>
  </div>

<div class="form-block other" id="form-18" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-strengthen
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (strengthen <span class="string">"A @(tsee booleanp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the value of the @(&#39;:strengthen&#39;) option of
          a function introduced via @(tsee defun-sk)."</span>
  (cdr (<a class="sym-link system" href="../../../axioms.html#def-assoc-eq" data-sym="ASSOC-EQ">assoc-eq</a> <span class="keyword">:strengthen</span> (defun-sk-options fn wrld))))</pre>
  </div>

<div class="form-block other" id="form-19" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-classicalp
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (strengthen <span class="string">"A @(tsee booleanp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the value of the @(&#39;:classicalp&#39;) option of
          a function introduced via @(tsee defun-sk)."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is only relevant for &lt;see topic=&#39;@(url real)&#39;&gt;ACL2(r)&lt;/see&gt;.
    This function returns @(&#39;t&#39;) when not running ACL2(r)."</span>)
  (b* ((options (defun-sk-options fn wrld)) (pair (<a class="sym-link system" href="../../../axioms.html#def-assoc-eq" data-sym="ASSOC-EQ">assoc-eq</a> <span class="keyword">:classicalp</span> options)))
    (if (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> pair)
      <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
      (cdr pair))))</pre>
  </div>

<div class="form-block other" id="form-20" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-rewrite-kind
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (kind <span class="string">"A @(tsee defun-sk-rewrite-kind-p)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the kind of the rewrite rule of
          a function introduced via @(tsee defun-sk)."</span>
  (b* ((options (defun-sk-options fn wrld)) (pair (<a class="sym-link system" href="../../../axioms.html#def-assoc-eq" data-sym="ASSOC-EQ">assoc-eq</a> <span class="keyword">:rewrite</span> options))
      ((when (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> pair)) <span class="keyword">:default</span>)
      (option (cdr pair)))
    (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="../../../axioms.html#def-eq" data-sym="EQ">eq</a> option <span class="keyword">:default</span>) <span class="keyword">:default</span>)
      ((<a class="sym-link system" href="../../../axioms.html#def-eq" data-sym="EQ">eq</a> option <span class="keyword">:direct</span>) <span class="keyword">:direct</span>)
      (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> <span class="keyword">:custom</span>))))</pre>
  </div>

<div class="form-block other" id="form-21" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-rewrite-name
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (name <span class="string">"A @(tsee symbolp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the name of the rewrite rule of
          a function introduced via @(tsee defun-sk)."</span>
  (b* ((options (defun-sk-options fn wrld)) (pair (<a class="sym-link system" href="../../../axioms.html#def-assoc-eq" data-sym="ASSOC-EQ">assoc-eq</a> <span class="keyword">:thm-name</span> options))
      ((unless (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> pair)) (cdr pair))
      (quantifier (defun-sk-quantifier fn wrld)))
    (<a class="sym-link system" href="../../../axioms.html#def-case" data-sym="CASE">case</a> quantifier
      (forall (<a class="sym-link system" href="../../../axioms.html#def-add-suffix" data-sym="ADD-SUFFIX">add-suffix</a> fn <span class="string">"-NECC"</span>))
      (exists (<a class="sym-link system" href="../../../axioms.html#def-add-suffix" data-sym="ADD-SUFFIX">add-suffix</a> fn <span class="string">"-SUFF"</span>))
      (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (impossible)))))</pre>
  </div>

<div class="form-block other" id="form-22" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-definition-name
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (name <span class="string">"A @(tsee symbolp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the name of the definition rule of
          a function introduced via @(tsee defun-sk)."</span>
  <span class="keyword">:long</span> (topstring-p <span class="string">"This is relevant when @(&#39;:constrain&#39;) is not @(&#39;nil&#39;):
    the result is the name of the theorem that essentially defines @(&#39;fn&#39;),
    but leaving @(&#39;fn&#39;) technically just constrained, not defined.
    Otherwise, @(&#39;nil&#39;) is returned."</span>)
  (b* ((options (defun-sk-options fn wrld)) (pair (<a class="sym-link system" href="../../../axioms.html#def-assoc-eq" data-sym="ASSOC-EQ">assoc-eq</a> <span class="keyword">:constrain</span> options))
      ((when (<a class="sym-link system" href="../../../axioms.html#def-null" data-sym="NULL">null</a> pair)) nil)
      (option (cdr pair)))
    (if (<a class="sym-link system" href="../../../axioms.html#def-eq" data-sym="EQ">eq</a> option <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
      (<a class="sym-link system" href="../../../axioms.html#def-add-suffix" data-sym="ADD-SUFFIX">add-suffix</a> fn <span class="string">"-DEFINITION"</span>)
      option)))</pre>
  </div>

<div class="form-block other" id="form-23" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define defun-sk-matrix
  ((fn (defun-sk-namep fn wrld)) (wrld <a class="sym-link system" href="../../../axioms.html#def-plist-worldp" data-sym="PLIST-WORLDP">plist-worldp</a>))
  <span class="keyword">:returns</span> (matrix <span class="string">"A @(tsee pseudo-termp)."</span>)
  <span class="keyword">:mode</span> <span class="keyword">:program</span> <span class="keyword">:short</span> <span class="string">"Retrieve the matrix of a function introduced via @(tsee defun-sk),
          in untranslated form."</span>
  <span class="keyword">:long</span> (topstring (p <span class="string">"If @(&#39;fn&#39;) is defined (i.e. @(&#39;:constrain&#39;) is @(&#39;nil&#39;) or absent),
     then after &lt;see topic=&#39;@(url term)&#39;&gt;translation&lt;/see&gt;,
     the (unnormalized) body of @(&#39;fn&#39;) should have the form
     @(&#39;(return-last &#39;progn (throw-nonexec-error ...) core)&#39;)
     if @(&#39;fn&#39;) is non-executable
     (i.e. it @(&#39;fn&#39;) is introduced via @(tsee defun-nx)
     in the @(tsee encapsulate)),
     or just @(&#39;core&#39;) otherwise.
     @(&#39;core&#39;) should have one of the following forms,
     where @(&#39;arg1&#39;), ..., @(&#39;argN&#39;) are the formal arguments of @(&#39;fn&#39;),
     and @(&#39;matrix&#39;) is the &lt;see topic=&#39;@(url term)&#39;&gt;translated&lt;/see&gt; matrix:"</span>)
    (ul (li (codeblock <span class="string">"((lambda (bvar) matrix) (witness arg1 ... argN))"</span>)
        (p <span class="string">"if there is just one bound variable @(&#39;bvar&#39;),
       as resulting from the &lt;see topic=&#39;@(url term)&#39;&gt;translation&lt;/see&gt;
       of the @(tsee let)."</span>))
      (li (codeblock <span class="string">"((lambda (mv argN ... arg1)"</span>
          <span class="string">"        ((lambda (bvar1 ... bvarM argN ... arg1) matrix)"</span>
          <span class="string">"         (mv-nth &#39;0 mv) ... (mv-nth &#39;M-1 mv) argN ... arg1))"</span>
          <span class="string">"(witness arg1 ... argN) arg1 ... argN)"</span>)
        (p <span class="string">"if there are @(&#39;M&#39;) &amp;gt; 1 bound variables,
       as resulting from the "</span>
          (seetopic <span class="string">"term"</span> <span class="string">"translation"</span>)
          <span class="string">" of the @(tsee mv-let)."</span>)))
    (p <span class="string">"If instead @(&#39;fn&#39;) is constrained (i.e. @(&#39;:constrain&#39;) is not @(&#39;nil&#39;)),
     the generated definition theorem for @(&#39;fn&#39;) should have the form
     @(&#39;(equal (fn arg1 ... argN) core)&#39;),
     with @(&#39;arg1&#39;), ..., @(&#39;argN&#39;) and @(&#39;core&#39;) as above."</span>)
    (p <span class="string">"Note that here we consider a function to be defined
     if it has an unnormalized body (via @(tsee ubody)).
     Certain program-mode functions may be defined
     without having an unnormalized body;
     however, @(tsee defun-sk) functions should always be in logic mode."</span>)
    (p <span class="string">"Use @(tsee defun-sk-imatrix)
     to retrieve the matrix in untranslated form."</span>))
  (b* ((core (if (ubody fn wrld)
         (b* ((<a class="sym-link system" href="../../../basis-b.html#def-body" data-sym="BODY">body</a> (ubody fn wrld)))
           (if (non-executablep fn wrld)
             (car (<a class="sym-link system" href="../../../axioms.html#def-last" data-sym="LAST">last</a> <a class="sym-link system" href="../../../basis-b.html#def-body" data-sym="BODY">body</a>))
             <a class="sym-link system" href="../../../basis-b.html#def-body" data-sym="BODY">body</a>))
         (b* ((def-thm (defun-sk-definition-name fn wrld)))
           (<a class="sym-link system" href="../../../axioms.html#def-third" data-sym="THIRD">third</a> (thm-formula def-thm wrld))))))
    (if (<a class="sym-link system" href="../../../axioms.html#def-_3D" data-sym="=">=</a> <span class="number">1</span> (<a class="sym-link system" href="../../../axioms.html#def-len" data-sym="LEN">len</a> (defun-sk-bound-vars fn wrld)))
      (<a class="sym-link system" href="../../../basis-a.html#def-case-match" data-sym="CASE-MATCH">case-match</a> core
        (((&amp; &amp; matrix) . &amp;) matrix)
        (&amp; (raise <span class="string">"Internal error: ~
                     the translated definiens ~x0 ~
                     of the DEFUN-SK function ~x1 ~
                     is malformed."</span>
            core
            fn)))
      (<a class="sym-link system" href="../../../basis-a.html#def-case-match" data-sym="CASE-MATCH">case-match</a> core
        (((&amp; &amp; ((&amp; &amp; matrix) . &amp;)) . &amp;) matrix)
        (&amp; (raise <span class="string">"Internal error: ~
                   the translated definiens ~x0 ~
                   of the DEFUN-SK function ~x1 ~
                   is malformed."</span>
            core
            fn))))))</pre>
  </div>


  </main>
  
<script>
// ACL2 Book HTML Documentation - Interactive Features
// Generated by cert2 - build2 system

// State
let activeFilter = null;
let activePartFilter = null;
let activeNameFilter = null;
let currentFontSize = 14;

// Theme management
function getStoredTheme() {
  return localStorage.getItem('acl2-theme') || 'dark';
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('theme-toggle').textContent = 'üåô';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
  }
  localStorage.setItem('acl2-theme', theme);
}

function toggleTheme() {
  const current = getStoredTheme();
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Font size management
function getStoredFontSize() {
  return parseInt(localStorage.getItem('acl2-fontsize') || '14', 10);
}

function setFontSize(size) {
  size = Math.max(10, Math.min(24, size)); // Clamp between 10-24
  currentFontSize = size;
  document.body.style.fontSize = size + 'px';
  localStorage.setItem('acl2-fontsize', size.toString());
}

function increaseFontSize() {
  setFontSize(currentFontSize + 2);
}

function decreaseFontSize() {
  setFontSize(currentFontSize - 2);
}

// Get all form blocks
function getFormBlocks() {
  return document.querySelectorAll('.form-block');
}

// Clear all filters
function clearFilter() {
  activeFilter = null;
  activePartFilter = null;
  activeNameFilter = null;
  getFormBlocks().forEach(b => {
    b.classList.remove('hidden', 'dimmed');
  });
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  const status = document.querySelector('.filter-status');
  status.classList.remove('active');
  // Slide name filter back to original position
  document.querySelector('.controls-left').style.transform = '';
  // Clear the name filter input
  const nameInput = document.getElementById('name-filter');
  if (nameInput) nameInput.value = '';
}

// Show filter status and slide name filter right
function showFilterStatus(text) {
  const status = document.querySelector('.filter-status');
  status.classList.add('active');
  status.querySelector('.filter-text').textContent = text;
  // Slide name filter to the right to make room
  setTimeout(() => {
    const statusWidth = status.offsetWidth;
    document.querySelector('.controls-left').style.transform = `translateX(${statusWidth + 15}px)`;
  }, 10);
}

// Filter to show only forms that define or reference a symbol
function filterBySymbol(symName, showUsedBy) {
  clearFilter();
  activeFilter = symName;
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines;
    const references = (block.dataset.references || '').split(',');
    const usedBy = (block.dataset.usedBy || '').split(',');
    
    let show = false;
    if (showUsedBy) {
      // Show forms that USE this symbol
      show = references.includes(symName) || definesName === symName;
    } else {
      // Show forms that this symbol USES
      show = usedBy.includes(symName) || definesName === symName;
    }
    
    if (show) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering by: ${symName} (${visibleCount} items)`);
}

// Filter by defthm part (term, hints, rule-classes, etc.)
function filterByPart(formId, partName) {
  clearFilter();
  activePartFilter = { formId, partName };
  
  // Get the part's referenced symbols
  // data-part-term becomes dataset.partTerm, data-part-hints becomes dataset.partHints, etc.
  const block = document.getElementById(formId);
  const datasetKey = 'part' + partName.charAt(0).toUpperCase() + partName.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase());
  const partData = block.dataset[datasetKey];
  if (!partData) return;
  
  const partSyms = partData.split(',').filter(s => s);
  
  // Highlight the button
  block.querySelector(`.part-btn[data-part="${partName}"]`).classList.add('active');
  
  // Hide forms not referenced by this part
  getFormBlocks().forEach(b => {
    const definesName = b.dataset.defines;
    if (b.id === formId || partSyms.includes(definesName)) {
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering ${formId} :${partName} (${partSyms.length} references)`);
}

// Filter by name (substring or regex)
function filterByName(pattern, useRegex) {
  // Clear other filters but keep the input value
  activeFilter = null;
  activePartFilter = null;
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  
  if (!pattern || pattern.trim() === '') {
    // Empty pattern - show all
    activeNameFilter = null;
    getFormBlocks().forEach(b => b.classList.remove('hidden'));
    const status = document.querySelector('.filter-status');
    status.classList.remove('active');
    document.querySelector('.controls-left').style.transform = '';
    return;
  }
  
  activeNameFilter = pattern;
  
  let matcher;
  let isValidRegex = true;
  
  if (useRegex) {
    try {
      matcher = new RegExp(pattern, 'i');
    } catch (e) {
      // Invalid regex - show error in status and don't filter
      showFilterStatus(`Invalid regex: ${e.message}`);
      return;
    }
  } else {
    // Plain substring match (case-insensitive)
    const lowerPattern = pattern.toLowerCase();
    matcher = { test: (s) => s.toLowerCase().includes(lowerPattern) };
  }
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines || '';
    if (matcher.test(definesName)) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  const modeText = useRegex ? 'regex' : 'name';
  showFilterStatus(`Filtering by ${modeText}: "${pattern}" (${visibleCount} matches)`);
}

// Click on a name to show what references it
function handleNameClick(symName) {
  if (activeFilter === symName) {
    clearFilter();
  } else {
    filterBySymbol(symName, true);
  }
}

// Navigate to a definition (same file or different)
function navigateTo(symName, file) {
  if (file) {
    // External file - navigate
    window.location.href = file + '.html#def-' + symName.toLowerCase();
  } else {
    // Same file - scroll
    const target = document.getElementById('def-' + symName.toLowerCase());
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('highlight');
      setTimeout(() => target.classList.remove('highlight'), 400);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Part buttons
  document.querySelectorAll('.part-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const formId = btn.closest('.form-block').id;
      const partName = btn.dataset.part;
      if (activePartFilter && activePartFilter.formId === formId && 
          activePartFilter.partName === partName) {
        clearFilter();
      } else {
        filterByPart(formId, partName);
      }
    });
  });
  
  // Clear filter button
  document.querySelector('.clear-filter').addEventListener('click', clearFilter);
  
  // Name filter input
  const nameFilter = document.getElementById('name-filter');
  const regexToggle = document.getElementById('regex-toggle');
  
  let filterTimeout = null;
  nameFilter.addEventListener('input', () => {
    // Debounce the filter to avoid excessive updates while typing
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      filterByName(nameFilter.value, regexToggle.checked);
    }, 150);
  });
  
  // Re-filter when regex toggle changes
  regexToggle.addEventListener('change', () => {
    if (nameFilter.value) {
      filterByName(nameFilter.value, regexToggle.checked);
    }
  });
  
  // Allow Escape key to clear filter when in input
  nameFilter.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearFilter();
      nameFilter.blur();
    }
  });
  
  // Symbol references (old span-based refs)
  document.querySelectorAll('.sym-ref').forEach(ref => {
    ref.addEventListener('click', (e) => {
      e.stopPropagation();
      const sym = ref.dataset.sym;
      const file = ref.dataset.file;
      if (file) {
        navigateTo(sym, file);
      } else {
        handleNameClick(sym);
      }
    });
  });
  
  // Symbol links (new anchor-based links)
  // These use standard <a> tags so navigation happens automatically
  // But we need to clear filters if target would be hidden
  document.querySelectorAll('.sym-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('#')) {
        // Local link - check if target is hidden by filter
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          // If target is hidden, clear the filter first
          if (target.classList.contains('hidden')) {
            clearFilter();
          }
          // Add highlight effect after a short delay
          setTimeout(() => {
            target.classList.add('highlight');
            setTimeout(() => target.classList.remove('highlight'), 400);
          }, 100);
        }
      }
      // For external links, default behavior handles navigation
    });
  });
  
  // Form names (show what uses them)
  document.querySelectorAll('.form-name').forEach(name => {
    name.addEventListener('click', (e) => {
      handleNameClick(name.dataset.sym);
    });
  });
  
  // Handle hash navigation (when arriving at page with #anchor)
  if (window.location.hash) {
    const target = document.querySelector(window.location.hash);
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.classList.add('highlight');
        setTimeout(() => target.classList.remove('highlight'), 400);
      }, 200);
    }
  }
  
  // Initialize theme from storage
  setTheme(getStoredTheme());
  
  // Initialize font size from storage
  currentFontSize = getStoredFontSize();
  setFontSize(currentFontSize);
  
  // Theme toggle button
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  
  // Font size buttons
  document.getElementById('font-larger').addEventListener('click', increaseFontSize);
  document.getElementById('font-smaller').addEventListener('click', decreaseFontSize);
});

</script>

</body>
</html>