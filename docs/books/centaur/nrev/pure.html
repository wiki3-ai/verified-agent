<!DOCTYPE html>
<html lang="en" vocab="http://schema.org/" typeof="SoftwareSourceCode">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>pure - ACL2 Book</title>
  <meta property="name" content="pure">
  <meta property="programmingLanguage" content="ACL2">
  
<style>
/* ACL2 Book HTML Documentation Styles */
/* Generated by cert2 - build2 system */

/* Dark theme (default) */
:root {
  --bg: #1e1e2e;
  --fg: #cdd6f4;
  --comment: #6c7086;
  --keyword: #cba6f7;
  --string: #a6e3a1;
  --function: #89b4fa;
  --type: #f9e2af;
  --link: #89dceb;
  --link-hover: #f5c2e7;
  --highlight: rgba(137, 180, 250, 0.2);
  --border: #313244;
  --block-bg: rgba(49, 50, 68, 0.5);
  --btn-bg: #313244;
  --btn-hover: rgba(137, 180, 250, 0.2);
}

/* Light theme */
[data-theme="light"] {
  --bg: #eff1f5;
  --fg: #4c4f69;
  --comment: #6c6f85;
  --keyword: #8839ef;
  --string: #40a02b;
  --function: #1e66f5;
  --type: #df8e1d;
  --link: #04a5e5;
  --link-hover: #ea76cb;
  --highlight: rgba(30, 102, 245, 0.15);
  --border: #ccd0da;
  --block-bg: rgba(204, 208, 218, 0.3);
  --btn-bg: #ccd0da;
  --btn-hover: rgba(30, 102, 245, 0.15);
}

body {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  padding: 20px;
  line-height: 1.6;
  font-size: 14px;
  transition: background 0.1s, color 0.1s;
}

/* Controls toolbar */
.controls-left {
  position: fixed;
  top: 10px;
  left: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
  transition: transform 0.1s ease;
}

.controls-right {
  position: fixed;
  top: 10px;
  right: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
}

.control-btn {
  padding: 6px 12px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  transition: all 0.1s;
}

.control-btn:hover {
  background: var(--btn-hover);
  border-color: var(--link);
}

.name-filter {
  padding: 6px 10px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  width: 150px;
  transition: all 0.1s;
}

.name-filter:focus {
  outline: none;
  border-color: var(--link);
  width: 200px;
}

.name-filter::placeholder {
  color: var(--comment);
}

.regex-label {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--comment);
  font-size: 12px;
  cursor: pointer;
}

.regex-label input {
  cursor: pointer;
}

.book-header {
  border-bottom: 2px solid var(--border);
  padding-bottom: 20px;
  margin-bottom: 20px;
}

.book-header h1 {
  color: var(--keyword);
  margin: 0;
}

.book-header .path {
  color: var(--comment);
  font-size: 0.9em;
}

.book-header .path .source-link {
  color: var(--comment);
  text-decoration: none;
}

.book-header .path .source-link:hover {
  color: var(--link);
  text-decoration: underline;
}

.form-block {
  margin: 10px 0;
  padding: 15px;
  background: var(--block-bg);
  border-radius: 8px;
  border-left: 3px solid var(--border);
}

.form-block.theorem { border-left-color: var(--keyword); }
.form-block.function { border-left-color: var(--function); }
.form-block.macro { border-left-color: var(--type); }
.form-block.include-book { border-left-color: var(--string); }

.form-block.hidden { display: none; }
.form-block.dimmed { opacity: 0.3; }

.form-block.highlight {
  animation: highlight-pulse 0.4s ease-out;
}

@keyframes highlight-pulse {
  0% { background: var(--highlight); box-shadow: 0 0 20px var(--link); }
  100% { background: rgba(49, 50, 68, 0.5); box-shadow: none; }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.form-name {
  color: var(--function);
  font-weight: bold;
  cursor: pointer;
}

.form-name:hover {
  color: var(--link-hover);
  text-decoration: underline;
}

.form-type {
  color: var(--comment);
  font-size: 0.85em;
}

pre.code {
  margin: 0;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.sym-ref {
  color: var(--link);
  cursor: pointer;
  border-radius: 2px;
}

.sym-ref:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.sym-ref.local-def { color: var(--function); font-weight: bold; }
.sym-ref.external { color: var(--type); }

/* Symbol links (clickable hyperlinks) */
.sym-link {
  color: var(--link);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.sym-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

.sym-link.local-def {
  color: var(--function);
  font-weight: bold;
}

.sym-link.external {
  color: var(--type);
}

/* Tooltips using title attribute with custom styling */
.sym-link[title] {
  /* Browser will show title on hover */
}

/* Syntax highlighting in code blocks */
.keyword {
  color: var(--keyword);
}

.string {
  color: var(--string);
}

.number {
  color: #f77524; /* orange */
}

/* Include-book path links */
.include-path {
  color: var(--string);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
}

.include-path:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

/* Part buttons for defthm */
.part-buttons {
  display: flex;
  gap: 5px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.part-btn {
  padding: 4px 10px;
  background: var(--border);
  border: 1px solid var(--comment);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
}

.part-btn:hover {
  background: var(--highlight);
  border-color: var(--link);
}

.part-btn.active {
  background: var(--link);
  color: var(--bg);
  border-color: var(--link);
}

/* References panel */
.refs-panel {
  margin-top: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  display: none;
}

.refs-panel.visible { display: block; }

.refs-panel h4 {
  margin: 0 0 5px 0;
  color: var(--comment);
  font-size: 0.9em;
}

.refs-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* Included books section */
.includes-section {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(49, 50, 68, 0.3);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.includes-section h2 {
  margin: 0 0 10px 0;
  color: var(--comment);
  font-size: 1em;
  font-weight: normal;
}

.includes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.include-link {
  padding: 6px 12px;
  background: var(--border);
  border-radius: 4px;
  color: var(--link);
  text-decoration: none;
  font-size: 0.9em;
  transition: all 0.1s;
}

.include-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.include-link.local {
  border-left: 2px solid var(--comment);
}

/* Filter status */
.filter-status {
  position: fixed;
  top: 10px;
  left: 20px;
  background: var(--bg);
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  z-index: 201;
  display: none;
  align-items: center;
  gap: 10px;
}

.filter-status.active {
  display: flex;
  align-items: center;
  gap: 10px;
}

.clear-filter {
  padding: 5px 15px;
  background: var(--keyword);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* RDFa vocab indicator */
[vocab] { /* semantic web annotations present */ }

</style>

</head>
<body>
  <div class="controls-left">
    <input type="text" id="name-filter" class="name-filter" placeholder="Filter by name..." title="Filter definitions by name">
    <label class="regex-label"><input type="checkbox" id="regex-toggle"> regex</label>
  </div>

  <div class="controls-right">
    <button class="control-btn" id="theme-toggle" title="Toggle light/dark theme">‚òÄÔ∏è</button>
    <button class="control-btn" id="font-smaller" title="Decrease font size">A-</button>
    <button class="control-btn" id="font-larger" title="Increase font size">A+</button>
  </div>

  <div class="filter-status">
    <span class="filter-text">Filtering...</span>
    <button class="clear-filter">Clear Filter</button>
  </div>
  
  <div class="book-header">
    <h1 property="name">pure</h1>
    <div class="path"><a href="pure.lisp" class="source-link">books/centaur/nrev/pure</a></div>
  </div>
  
  <main property="text">
<div class="form-block other" id="form-0" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-in-package" data-sym="IN-PACKAGE">in-package</a> <span class="string">"NREV"</span>)</pre>
  </div>

<div class="form-block other" id="form-1" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/stobjs/absstobjs.html" title="Open std/stobjs/absstobjs">"std/stobjs/absstobjs"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-2" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/stobjs/clone.html" title="Open std/stobjs/clone">"std/stobjs/clone"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-3" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/list-defuns.html" title="Open std/lists/list-defuns">"std/lists/list-defuns"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-4" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/rcons.html" title="Open std/lists/rcons">"std/lists/rcons"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-5" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/rev.html" title="Open std/lists/rev">"std/lists/rev"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-6" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/append.html" title="Open std/lists/append">"std/lists/append"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-7" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-in-theory" data-sym="IN-THEORY">in-theory</a> (enable rcons)))</pre>
  </div>

<div class="form-block other" id="form-8" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defxdoc nrev
  <span class="keyword">:parents</span> (<a class="sym-link system" href="../../../axioms.html#def-reverse" data-sym="REVERSE">reverse</a>)
  <span class="keyword">:short</span> <span class="string">"A safe mechanism for implementing something like @(&#39;nreverse&#39;), for
writing tail-recursive functions that use less memory by avoiding the final
@(see reverse) step."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;h3&gt;Motivation&lt;/h3&gt;

&lt;p&gt;To avoid stack overflows, you sometimes need tail-recursive executable
versions of your functions.  These tail-recursive functions often produce their
elements in the reverse of the desired order.  For instance, here is a basic,
tail-recursive &lt;a
href=&#39;https://en.wikipedia.org/wiki/Map_(higher-order_function)&#39;&gt;map&lt;/a&gt;:&lt;/p&gt;

@({
    (defun map-exec (x acc)
      (if (atom x)
          acc
        (map-exec (cdr x) (cons (f (car x)) acc))))
})

&lt;p&gt;But this produces elements in the wrong order.  To correct for this, you
might explicitly reverse the elements, e.g.,:&lt;/p&gt;

@({
    (defun map (x)
      (mbe :logic (if (atom x)
                      nil
                    (cons (f (car x)) (map (cdr x))))
           :exec (reverse (map-exec x nil))))
})

&lt;p&gt;This successfully avoids stack overflows, but since @(see reverse) is
applicative, this approach allocates twice as many conses as the naive, non
tail-recursive version.&lt;/p&gt;

&lt;p&gt;In Common Lisp, we could avoid this overhead using @(&#39;nreverse&#39;), a
destructive routine that can reverse a list in-place by swapping pointers.  But
since @(&#39;nreverse&#39;) is destructive, it wouldn&#39;t be sound to just make it
generally available in ACL2.&lt;/p&gt;

&lt;p&gt;Even so, we would like to have something like @(&#39;nreverse&#39;) that would allow
us to write tail-recursive versions of @(&#39;map&#39;) without having to allocate
double the conses.  In principle, it is okay to use @(&#39;nreverse&#39;) here because
we are only tampering with fresh conses that are not reachable from anywhere
else in the program.  (Well, that&#39;s almost true; if @(&#39;map-exec&#39;) were @(see
memoize)d, then we could get into trouble.)&lt;/p&gt;

&lt;h3&gt;Solution&lt;/h3&gt;

&lt;p&gt;@(&#39;nrev&#39;) is, we believe, a safe mechanism for writing tail-recursive
functions that can (at your option) avoid this double consing by using
destructive, under-the-hood operations.&lt;/p&gt;

&lt;p&gt;Without trust tags, @(&#39;nrev&#39;) is roughly on par with the ordinary
@(&#39;reverse&#39;) based solution:&lt;/p&gt;

&lt;ul&gt;

&lt;li&gt;Memory &amp;mdash; same as @(&#39;reverse&#39;), i.e., still twice as many as the non
tail-recursive version.&lt;/li&gt;

&lt;li&gt;Runtime &amp;mdash; perhaps around 1.3x worse than @(&#39;reverse&#39;) due to the
@(see acl2::stobj) overhead.&lt;/li&gt;

&lt;/ul&gt;

&lt;p&gt;With a trust tag, @(&#39;nrev&#39;) is roughly on par with the @(&#39;nreverse&#39;)
solution:&lt;/p&gt;

&lt;ul&gt;

&lt;li&gt;Memory &amp;mdash; same as @(&#39;nreverse&#39;), i.e., avoids the double consing
problem.&lt;/li&gt;

&lt;li&gt;Runtime &amp;mdash; perhaps around 1.25x worse than @(&#39;nreverse&#39;) due to the
@(see acl2::stobj) overhead, but still faster than a traditional @(&#39;reverse&#39;)
based solution.&lt;/li&gt;

&lt;/ul&gt;

&lt;h3&gt;Loading @(&#39;nrev&#39;)&lt;/h3&gt;

&lt;p&gt;For the pure ACL2 (no trust tags) version, you can use:&lt;/p&gt;

@({
    (include-book &quot;centaur/nrev/pure&quot; :dir :system)
})

&lt;p&gt;For the optimized (trust tags) version, you can instead load:&lt;/p&gt;

@({
    (include-book &quot;centaur/nrev/fast&quot; :dir :system)
})

&lt;p&gt;Note that it&#39;s perfectly fine to start with the pure book and then load the
fast version later.  Loading the fast version will &quot;retroactively&quot; optimize
all functions that are based on @(&#39;nrev&#39;).&lt;/p&gt;

&lt;h3&gt;Using @(&#39;nrev&#39;)&lt;/h3&gt;

&lt;p&gt;These books implement an abstract stobj called @(&#39;nrev&#39;).  The logical story
is that @(&#39;nrev&#39;) is just a list.  The fundamental operation on @(&#39;nrev&#39;) is
@(see nrev-push), which logically conses &quot;onto the right,&quot; like @(see rcons).
Once you have pushed the desired elements, you can get them back out in queue
order using @(see nrev-finish).&lt;/p&gt;

&lt;p&gt;See @(see nrev-demo) for a basic example.&lt;/p&gt;"</span>)</pre>
  </div>

<div class="form-block other" id="form-9" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev$c
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"The concrete @(&#39;nrev&#39;) stobj."</span>
  <span class="keyword">:long</span> <span class="string">"@(def nrev$c)"</span>
  <span class="keyword">:autodoc</span> nil
  (<a class="sym-link system" href="../../../axioms.html#def-defstobj" data-sym="DEFSTOBJ">defstobj</a> nrev$c
    (nrev$c-acc <span class="keyword">:type</span> (satisfies <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>)
      <span class="keyword">:initially</span> nil)
    (nrev$c-hint <span class="keyword">:type</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> <span class="keyword">:initially</span> nil)))</pre>
  </div>

<div class="form-block other" id="form-10" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-fix
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Identity function for @(&#39;nrev&#39;)."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;box&gt;&lt;p&gt;&lt;b&gt;Signature:&lt;/b&gt; @(&#39;(nrev-fix nrev)&#39;) &amp;rarr; @(&#39;nrev&#39;&#39;)&lt;/p&gt;&lt;/box&gt;

&lt;p&gt;In the logic, this simply sets:&lt;/p&gt;

@({
     nrev&#39; := (list-fix nrev)
})

&lt;p&gt;In both the pure and optimized implementations, this is a no-op that just
returns @(&#39;nrev&#39;) unchanged.&lt;/p&gt;

&lt;p&gt;This is a fast operation.  It is generally useful to call @(&#39;(nrev-fix
nrev)&#39;) in your function&#39;s base case, to avoid needing @(see true-listp)
hypotheses.&lt;/p&gt;"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$a-fix
    (nrev$a)
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))
    (list-fix nrev$a))
  (<a class="sym-link system" href="../../../axioms.html#def-defun-inline" data-sym="DEFUN-INLINE">defun-inline</a> nrev$c-fix
    (nrev$c)
    (declare (xargs <span class="keyword">:stobjs</span> nrev$c))
    nrev$c))</pre>
  </div>

<div class="form-block other" id="form-11" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-push
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Fundamental operation to extend @(&#39;nrev&#39;) with a new element."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;box&gt;&lt;p&gt;&lt;b&gt;Signature:&lt;/b&gt; @(&#39;(nrev-push a nrev)&#39;) &amp;rarr;
@(&#39;nrev&#39;&#39;)&lt;/p&gt;&lt;/box&gt;

&lt;p&gt;In the logic, this sets:&lt;/p&gt;

@({
    nrev&#39; := (rcons a nrev)
})

&lt;p&gt;In the pure ACL2 implementation, the underlying representation of @(&#39;nrev&#39;)
keeps the elements in reverse order, so @(&#39;nrev-push&#39;) takes just a single
cons.&lt;/p&gt;

&lt;p&gt;In the optimized implementation, this operation creates a cons and then
destructively extends the rightmost cons cell, like a Common Lisp @(&#39;rplacd&#39;)
operation.&lt;/p&gt;"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$a-push
    (a nrev$a)
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))
    (rcons a nrev$a))
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$c-push
    (a nrev$c)
    (declare (xargs <span class="keyword">:stobjs</span> nrev$c))
    (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((acc (nrev$c-acc nrev$c)) (acc (cons a acc)))
      (update-nrev$c-acc acc nrev$c))))</pre>
  </div>

<div class="form-block other" id="form-12" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-copy
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Slow operation to copy the current contents of @(&#39;nrev&#39;), without
destroying it."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;box&gt;&lt;p&gt;&lt;b&gt;Signature:&lt;/b&gt; @(&#39;(nrev-copy nrev)&#39;) &amp;rarr;
@(&#39;list&#39;)&lt;/p&gt;&lt;/box&gt;

&lt;p&gt;This is an unusual, expensive operation.  It may occasionally be useful as a
way to inspect the contents of @(&#39;nrev&#39;) without modifying @(&#39;nrev&#39;).&lt;/p&gt;

&lt;p&gt;In the logic, this just returns @(&#39;(list-fix nrev)&#39;).&lt;/p&gt;

&lt;p&gt;In the pure ACL2 implementation, the underlying representation of @(&#39;nrev&#39;)
keeps the elements in reverse order, so @(&#39;nrev-copy&#39;) just calls @(see
reverse) to reverse these elements and give you a list in the proper order.
This, of course, takes O(n) conses.&lt;/p&gt;

&lt;p&gt;In the optimized implementation, we similarly need to create a copy of the
current contents of @(&#39;nrev&#39;), so this again takes O(n) conses.&lt;/p&gt;"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$a-copy
    (nrev$a)
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))
    (list-fix nrev$a))
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$c-copy
    (nrev$c)
    (declare (xargs <span class="keyword">:stobjs</span> nrev$c))
    (<a class="sym-link system" href="../../../axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (nrev$c-acc nrev$c))))</pre>
  </div>

<div class="form-block other" id="form-13" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-set-hint
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Set a candidate list to try and preserve existing conses when finishing an nrev."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;box&gt;&lt;p&gt;&lt;b&gt;Signature:&lt;/b&gt; @(&#39;(nrev-set-hint a nrev)&#39;) &amp;rarr;
@(&#39;nrev&#39;&#39;)&lt;/p&gt;&lt;/box&gt;

&lt;p&gt;In the common use case where an nrev is accumulating a transformed list (as
in a @(see std::defprojection)), sometimes it may be the case that few of the
list elements are actually transformed.  In these cases it may be desirable to
return a list that has as many conses shared with the original list as
possible.  This way, fewer total conses are in your working footprint.&lt;/p&gt;

&lt;p&gt;To support this, nrev allows setting a hint, which in such a case should
just be the original, untransformed list.&lt;/p&gt;

&lt;p&gt;In the logical story, this doesn&#39;t do anything but return the unchanged
nrev.  In the pure ACL2 implementation, it just sets an extra stobj field to
the hint.  However, in the optimized implementation, when there is a hint set,
then before returning the final list, we check to see if it has a suffix in
common with the hint, and if so, replace that suffix with the one from the
hint.  Therefore, we return something equal to the list we&#39;ve accumulated, but
with as many of the conses from the hint as possible.&lt;/p&gt;"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$a-set-hint
    (a nrev$a)
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)
      (ignore a))
    (list-fix nrev$a))
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$c-set-hint
    (a nrev$c)
    (declare (xargs <span class="keyword">:stobjs</span> nrev$c))
    (update-nrev$c-hint a nrev$c)))</pre>
  </div>

<div class="form-block other" id="form-14" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-finish
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Final step to extract the elements from an @(&#39;nrev&#39;)."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;box&gt;&lt;p&gt;&lt;b&gt;Signature:&lt;/b&gt; @(&#39;(nrev-finish nrev)&#39;) &amp;rarr; @(&#39;(mv list
nrev&#39;)&#39;)&lt;/p&gt;&lt;/box&gt;

&lt;p&gt;In the logic, this returns @(&#39;(list-fix nrev)&#39;) as @(&#39;list&#39;), and also
updates @(&#39;nrev&#39; := nil&#39;).&lt;/p&gt;

&lt;p&gt;In the pure ACL2 implementation, this function is very much like @(see
nrev-copy).  The underlying representation of @(&#39;nrev&#39;) keeps the elements in
reverse order, so @(&#39;nrev-finish&#39;) has to reverse them, e.g., via @(see
reverse), which of course is O(n).&lt;/p&gt;

&lt;p&gt;In the optimized implementation, we have already constructed the list in
reverse order, so we can simply return it, saving all that consing.  For this
to be sound, we must simultaneously clear out @(&#39;nrev&#39;)&amp;mdash;otherwise, a
subsequent @(see nrev-push) would be destructively modifying conses that are
visible elsewhere in the program.&lt;/p&gt;"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$a-finish
    (nrev$a)
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))
    (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((elems (list-fix nrev$a)))
      (<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> elems nil)))
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev$c-finish
    (nrev$c)
    (declare (xargs <span class="keyword">:stobjs</span> nrev$c))
    (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((elems (<a class="sym-link system" href="../../../axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (nrev$c-acc nrev$c))) (nrev$c (update-nrev$c-acc nil nrev$c)))
      (<a class="sym-link system" href="../../../axioms.html#def-mv" data-sym="MV">mv</a> elems nrev$c))))</pre>
  </div>

<div class="form-block other" id="form-15" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-stobj
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Definition of the @(&#39;nrev&#39;) abstract stobj."</span>
  <span class="keyword">:long</span> <span class="string">"@(def nrev)"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> create-nrev$a
    nil
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>))
    nil)
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev-corr
    (nrev$c nrev$a)
    (declare (xargs <span class="keyword">:stobjs</span> nrev$c))
    (equal (nrev$c-copy nrev$c)
      (nrev$a-copy nrev$a))))</pre>
  </div>

<div class="form-block other" id="form-16" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defabsstobj-events nrev
  <span class="keyword">:foundation</span> nrev$c
  <span class="keyword">:recognizer</span> (nrev$p <span class="keyword">:logic</span> <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a> <span class="keyword">:exec</span> nrev$cp)
  <span class="keyword">:creator</span> (create-nrev <span class="keyword">:logic</span> create-nrev$a
    <span class="keyword">:exec</span> create-nrev$c)
  <span class="keyword">:corr-fn</span> nrev-corr
  <span class="keyword">:exports</span> ((nrev-fix <span class="keyword">:logic</span> nrev$a-fix
     <span class="keyword">:exec</span> nrev$c-fix$inline) (nrev-copy <span class="keyword">:logic</span> nrev$a-copy
      <span class="keyword">:exec</span> nrev$c-copy)
    (nrev-push <span class="keyword">:logic</span> nrev$a-push
      <span class="keyword">:exec</span> nrev$c-push)
    (nrev-set-hint <span class="keyword">:logic</span> nrev$a-set-hint
      <span class="keyword">:exec</span> nrev$c-set-hint)
    (nrev-finish <span class="keyword">:logic</span> nrev$a-finish
      <span class="keyword">:exec</span> nrev$c-finish)))</pre>
  </div>

<div class="form-block other" id="form-17" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-push-untouchable" data-sym="PUSH-UNTOUCHABLE">push-untouchable</a> nrev$c-acc <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-18" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-push-untouchable" data-sym="PUSH-UNTOUCHABLE">push-untouchable</a> update-nrev$c-acc <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-19" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection with-local-nrev
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Wrapper for @(see with-local-stobj) for common cases of using @(see
nrev)."</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defmacro" data-sym="DEFMACRO">defmacro</a> with-local-nrev
    (form)
    `(with-local-stobj nrev
      (<a class="sym-link system" href="../../../axioms.html#def-mv-let" data-sym="MV-LET">mv-let</a> (elems nrev)
        (let ((nrev ,NREV::FORM))
          (nrev-finish nrev))
        elems))))</pre>
  </div>

<div class="form-block other" id="form-20" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev2
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"An extra @(see nrev) created with @(see acl2::defstobj-clone)."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;p&gt;This may be useful if you need two @(see nrev) stobjs at once.&lt;/p&gt;
@(def nrev2)"</span>
  <span class="keyword">:autodoc</span> nil
  (defstobj-clone nrev2 nrev <span class="keyword">:suffix</span> <span class="string">"2"</span>))</pre>
  </div>

<div class="form-block other" id="form-21" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection nrev-append
  <span class="keyword">:parents</span> (nrev)
  <span class="keyword">:short</span> <span class="string">"Add several elements into @(&#39;nrev&#39;) at once."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;p&gt;We just leave this enabled.&lt;/p&gt;"</span>
  (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> nrev-append
    (x nrev)
    (declare (xargs <span class="keyword">:guard</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> <span class="keyword">:stobjs</span> nrev))
    (<a class="sym-link system" href="../../../axioms.html#def-mbe" data-sym="MBE">mbe</a> <span class="keyword">:logic</span> (<a class="sym-link system" href="../../../axioms.html#def-non-exec" data-sym="NON-EXEC">non-exec</a> (<a class="sym-link system" href="../../../axioms.html#def-append" data-sym="APPEND">append</a> nrev (list-fix x)))
      <span class="keyword">:exec</span> (if (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)
        (nrev-fix nrev)
        (let ((nrev (nrev-push (car x) nrev)))
          (nrev-append (cdr x) nrev))))))</pre>
  </div>


  </main>
  
<script>
// ACL2 Book HTML Documentation - Interactive Features
// Generated by cert2 - build2 system

// State
let activeFilter = null;
let activePartFilter = null;
let activeNameFilter = null;
let currentFontSize = 14;

// Theme management
function getStoredTheme() {
  return localStorage.getItem('acl2-theme') || 'dark';
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('theme-toggle').textContent = 'üåô';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
  }
  localStorage.setItem('acl2-theme', theme);
}

function toggleTheme() {
  const current = getStoredTheme();
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Font size management
function getStoredFontSize() {
  return parseInt(localStorage.getItem('acl2-fontsize') || '14', 10);
}

function setFontSize(size) {
  size = Math.max(10, Math.min(24, size)); // Clamp between 10-24
  currentFontSize = size;
  document.body.style.fontSize = size + 'px';
  localStorage.setItem('acl2-fontsize', size.toString());
}

function increaseFontSize() {
  setFontSize(currentFontSize + 2);
}

function decreaseFontSize() {
  setFontSize(currentFontSize - 2);
}

// Get all form blocks
function getFormBlocks() {
  return document.querySelectorAll('.form-block');
}

// Clear all filters
function clearFilter() {
  activeFilter = null;
  activePartFilter = null;
  activeNameFilter = null;
  getFormBlocks().forEach(b => {
    b.classList.remove('hidden', 'dimmed');
  });
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  const status = document.querySelector('.filter-status');
  status.classList.remove('active');
  // Slide name filter back to original position
  document.querySelector('.controls-left').style.transform = '';
  // Clear the name filter input
  const nameInput = document.getElementById('name-filter');
  if (nameInput) nameInput.value = '';
}

// Show filter status and slide name filter right
function showFilterStatus(text) {
  const status = document.querySelector('.filter-status');
  status.classList.add('active');
  status.querySelector('.filter-text').textContent = text;
  // Slide name filter to the right to make room
  setTimeout(() => {
    const statusWidth = status.offsetWidth;
    document.querySelector('.controls-left').style.transform = `translateX(${statusWidth + 15}px)`;
  }, 10);
}

// Filter to show only forms that define or reference a symbol
function filterBySymbol(symName, showUsedBy) {
  clearFilter();
  activeFilter = symName;
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines;
    const references = (block.dataset.references || '').split(',');
    const usedBy = (block.dataset.usedBy || '').split(',');
    
    let show = false;
    if (showUsedBy) {
      // Show forms that USE this symbol
      show = references.includes(symName) || definesName === symName;
    } else {
      // Show forms that this symbol USES
      show = usedBy.includes(symName) || definesName === symName;
    }
    
    if (show) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering by: ${symName} (${visibleCount} items)`);
}

// Filter by defthm part (term, hints, rule-classes, etc.)
function filterByPart(formId, partName) {
  clearFilter();
  activePartFilter = { formId, partName };
  
  // Get the part's referenced symbols
  // data-part-term becomes dataset.partTerm, data-part-hints becomes dataset.partHints, etc.
  const block = document.getElementById(formId);
  const datasetKey = 'part' + partName.charAt(0).toUpperCase() + partName.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase());
  const partData = block.dataset[datasetKey];
  if (!partData) return;
  
  const partSyms = partData.split(',').filter(s => s);
  
  // Highlight the button
  block.querySelector(`.part-btn[data-part="${partName}"]`).classList.add('active');
  
  // Hide forms not referenced by this part
  getFormBlocks().forEach(b => {
    const definesName = b.dataset.defines;
    if (b.id === formId || partSyms.includes(definesName)) {
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering ${formId} :${partName} (${partSyms.length} references)`);
}

// Filter by name (substring or regex)
function filterByName(pattern, useRegex) {
  // Clear other filters but keep the input value
  activeFilter = null;
  activePartFilter = null;
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  
  if (!pattern || pattern.trim() === '') {
    // Empty pattern - show all
    activeNameFilter = null;
    getFormBlocks().forEach(b => b.classList.remove('hidden'));
    const status = document.querySelector('.filter-status');
    status.classList.remove('active');
    document.querySelector('.controls-left').style.transform = '';
    return;
  }
  
  activeNameFilter = pattern;
  
  let matcher;
  let isValidRegex = true;
  
  if (useRegex) {
    try {
      matcher = new RegExp(pattern, 'i');
    } catch (e) {
      // Invalid regex - show error in status and don't filter
      showFilterStatus(`Invalid regex: ${e.message}`);
      return;
    }
  } else {
    // Plain substring match (case-insensitive)
    const lowerPattern = pattern.toLowerCase();
    matcher = { test: (s) => s.toLowerCase().includes(lowerPattern) };
  }
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines || '';
    if (matcher.test(definesName)) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  const modeText = useRegex ? 'regex' : 'name';
  showFilterStatus(`Filtering by ${modeText}: "${pattern}" (${visibleCount} matches)`);
}

// Click on a name to show what references it
function handleNameClick(symName) {
  if (activeFilter === symName) {
    clearFilter();
  } else {
    filterBySymbol(symName, true);
  }
}

// Navigate to a definition (same file or different)
function navigateTo(symName, file) {
  if (file) {
    // External file - navigate
    window.location.href = file + '.html#def-' + symName.toLowerCase();
  } else {
    // Same file - scroll
    const target = document.getElementById('def-' + symName.toLowerCase());
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('highlight');
      setTimeout(() => target.classList.remove('highlight'), 400);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Part buttons
  document.querySelectorAll('.part-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const formId = btn.closest('.form-block').id;
      const partName = btn.dataset.part;
      if (activePartFilter && activePartFilter.formId === formId && 
          activePartFilter.partName === partName) {
        clearFilter();
      } else {
        filterByPart(formId, partName);
      }
    });
  });
  
  // Clear filter button
  document.querySelector('.clear-filter').addEventListener('click', clearFilter);
  
  // Name filter input
  const nameFilter = document.getElementById('name-filter');
  const regexToggle = document.getElementById('regex-toggle');
  
  let filterTimeout = null;
  nameFilter.addEventListener('input', () => {
    // Debounce the filter to avoid excessive updates while typing
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      filterByName(nameFilter.value, regexToggle.checked);
    }, 150);
  });
  
  // Re-filter when regex toggle changes
  regexToggle.addEventListener('change', () => {
    if (nameFilter.value) {
      filterByName(nameFilter.value, regexToggle.checked);
    }
  });
  
  // Allow Escape key to clear filter when in input
  nameFilter.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearFilter();
      nameFilter.blur();
    }
  });
  
  // Symbol references (old span-based refs)
  document.querySelectorAll('.sym-ref').forEach(ref => {
    ref.addEventListener('click', (e) => {
      e.stopPropagation();
      const sym = ref.dataset.sym;
      const file = ref.dataset.file;
      if (file) {
        navigateTo(sym, file);
      } else {
        handleNameClick(sym);
      }
    });
  });
  
  // Symbol links (new anchor-based links)
  // These use standard <a> tags so navigation happens automatically
  // But we need to clear filters if target would be hidden
  document.querySelectorAll('.sym-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('#')) {
        // Local link - check if target is hidden by filter
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          // If target is hidden, clear the filter first
          if (target.classList.contains('hidden')) {
            clearFilter();
          }
          // Add highlight effect after a short delay
          setTimeout(() => {
            target.classList.add('highlight');
            setTimeout(() => target.classList.remove('highlight'), 400);
          }, 100);
        }
      }
      // For external links, default behavior handles navigation
    });
  });
  
  // Form names (show what uses them)
  document.querySelectorAll('.form-name').forEach(name => {
    name.addEventListener('click', (e) => {
      handleNameClick(name.dataset.sym);
    });
  });
  
  // Handle hash navigation (when arriving at page with #anchor)
  if (window.location.hash) {
    const target = document.querySelector(window.location.hash);
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.classList.add('highlight');
        setTimeout(() => target.classList.remove('highlight'), 400);
      }, 200);
    }
  }
  
  // Initialize theme from storage
  setTheme(getStoredTheme());
  
  // Initialize font size from storage
  currentFontSize = getStoredFontSize();
  setFontSize(currentFontSize);
  
  // Theme toggle button
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  
  // Font size buttons
  document.getElementById('font-larger').addEventListener('click', increaseFontSize);
  document.getElementById('font-smaller').addEventListener('click', decreaseFontSize);
});

</script>

</body>
</html>