<!DOCTYPE html>
<html lang="en" vocab="http://schema.org/" typeof="SoftwareSourceCode">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>to-json - ACL2 Book</title>
  <meta property="name" content="to-json">
  <meta property="programmingLanguage" content="ACL2">
  
<style>
/* ACL2 Book HTML Documentation Styles */
/* Generated by cert2 - build2 system */

/* Dark theme (default) */
:root {
  --bg: #1e1e2e;
  --fg: #cdd6f4;
  --comment: #6c7086;
  --keyword: #cba6f7;
  --string: #a6e3a1;
  --function: #89b4fa;
  --type: #f9e2af;
  --link: #89dceb;
  --link-hover: #f5c2e7;
  --highlight: rgba(137, 180, 250, 0.2);
  --border: #313244;
  --block-bg: rgba(49, 50, 68, 0.5);
  --btn-bg: #313244;
  --btn-hover: rgba(137, 180, 250, 0.2);
}

/* Light theme */
[data-theme="light"] {
  --bg: #eff1f5;
  --fg: #4c4f69;
  --comment: #6c6f85;
  --keyword: #8839ef;
  --string: #40a02b;
  --function: #1e66f5;
  --type: #df8e1d;
  --link: #04a5e5;
  --link-hover: #ea76cb;
  --highlight: rgba(30, 102, 245, 0.15);
  --border: #ccd0da;
  --block-bg: rgba(204, 208, 218, 0.3);
  --btn-bg: #ccd0da;
  --btn-hover: rgba(30, 102, 245, 0.15);
}

body {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  padding: 20px;
  line-height: 1.6;
  font-size: 14px;
  transition: background 0.1s, color 0.1s;
}

/* Controls toolbar */
.controls-left {
  position: fixed;
  top: 10px;
  left: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
  transition: transform 0.1s ease;
}

.controls-right {
  position: fixed;
  top: 10px;
  right: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
}

.control-btn {
  padding: 6px 12px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  transition: all 0.1s;
}

.control-btn:hover {
  background: var(--btn-hover);
  border-color: var(--link);
}

.name-filter {
  padding: 6px 10px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  width: 150px;
  transition: all 0.1s;
}

.name-filter:focus {
  outline: none;
  border-color: var(--link);
  width: 200px;
}

.name-filter::placeholder {
  color: var(--comment);
}

.regex-label {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--comment);
  font-size: 12px;
  cursor: pointer;
}

.regex-label input {
  cursor: pointer;
}

.book-header {
  border-bottom: 2px solid var(--border);
  padding-bottom: 20px;
  margin-bottom: 20px;
}

.book-header h1 {
  color: var(--keyword);
  margin: 0;
}

.book-header .path {
  color: var(--comment);
  font-size: 0.9em;
}

.book-header .path .source-link {
  color: var(--comment);
  text-decoration: none;
}

.book-header .path .source-link:hover {
  color: var(--link);
  text-decoration: underline;
}

.form-block {
  margin: 10px 0;
  padding: 15px;
  background: var(--block-bg);
  border-radius: 8px;
  border-left: 3px solid var(--border);
}

.form-block.theorem { border-left-color: var(--keyword); }
.form-block.function { border-left-color: var(--function); }
.form-block.macro { border-left-color: var(--type); }
.form-block.include-book { border-left-color: var(--string); }

.form-block.hidden { display: none; }
.form-block.dimmed { opacity: 0.3; }

.form-block.highlight {
  animation: highlight-pulse 0.4s ease-out;
}

@keyframes highlight-pulse {
  0% { background: var(--highlight); box-shadow: 0 0 20px var(--link); }
  100% { background: rgba(49, 50, 68, 0.5); box-shadow: none; }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.form-name {
  color: var(--function);
  font-weight: bold;
  cursor: pointer;
}

.form-name:hover {
  color: var(--link-hover);
  text-decoration: underline;
}

.form-type {
  color: var(--comment);
  font-size: 0.85em;
}

pre.code {
  margin: 0;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.sym-ref {
  color: var(--link);
  cursor: pointer;
  border-radius: 2px;
}

.sym-ref:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.sym-ref.local-def { color: var(--function); font-weight: bold; }
.sym-ref.external { color: var(--type); }

/* Symbol links (clickable hyperlinks) */
.sym-link {
  color: var(--link);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.sym-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

.sym-link.local-def {
  color: var(--function);
  font-weight: bold;
}

.sym-link.external {
  color: var(--type);
}

/* Tooltips using title attribute with custom styling */
.sym-link[title] {
  /* Browser will show title on hover */
}

/* Syntax highlighting in code blocks */
.keyword {
  color: var(--keyword);
}

.string {
  color: var(--string);
}

.number {
  color: #f77524; /* orange */
}

/* Include-book path links */
.include-path {
  color: var(--string);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
}

.include-path:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

/* Part buttons for defthm */
.part-buttons {
  display: flex;
  gap: 5px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.part-btn {
  padding: 4px 10px;
  background: var(--border);
  border: 1px solid var(--comment);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
}

.part-btn:hover {
  background: var(--highlight);
  border-color: var(--link);
}

.part-btn.active {
  background: var(--link);
  color: var(--bg);
  border-color: var(--link);
}

/* References panel */
.refs-panel {
  margin-top: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  display: none;
}

.refs-panel.visible { display: block; }

.refs-panel h4 {
  margin: 0 0 5px 0;
  color: var(--comment);
  font-size: 0.9em;
}

.refs-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* Included books section */
.includes-section {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(49, 50, 68, 0.3);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.includes-section h2 {
  margin: 0 0 10px 0;
  color: var(--comment);
  font-size: 1em;
  font-weight: normal;
}

.includes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.include-link {
  padding: 6px 12px;
  background: var(--border);
  border-radius: 4px;
  color: var(--link);
  text-decoration: none;
  font-size: 0.9em;
  transition: all 0.1s;
}

.include-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.include-link.local {
  border-left: 2px solid var(--comment);
}

/* Filter status */
.filter-status {
  position: fixed;
  top: 10px;
  left: 20px;
  background: var(--bg);
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  z-index: 201;
  display: none;
  align-items: center;
  gap: 10px;
}

.filter-status.active {
  display: flex;
  align-items: center;
  gap: 10px;
}

.clear-filter {
  padding: 5px 15px;
  background: var(--keyword);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* RDFa vocab indicator */
[vocab] { /* semantic web annotations present */ }

</style>

</head>
<body>
  <div class="controls-left">
    <input type="text" id="name-filter" class="name-filter" placeholder="Filter by name..." title="Filter definitions by name">
    <label class="regex-label"><input type="checkbox" id="regex-toggle"> regex</label>
  </div>

  <div class="controls-right">
    <button class="control-btn" id="theme-toggle" title="Toggle light/dark theme">☀️</button>
    <button class="control-btn" id="font-smaller" title="Decrease font size">A-</button>
    <button class="control-btn" id="font-larger" title="Increase font size">A+</button>
  </div>

  <div class="filter-status">
    <span class="filter-text">Filtering...</span>
    <button class="clear-filter">Clear Filter</button>
  </div>
  
  <div class="book-header">
    <h1 property="name">to-json</h1>
    <div class="path"><a href="to-json.lisp" class="source-link">books/centaur/bridge/to-json</a></div>
  </div>
  
  <main property="text">
<div class="form-block other" id="form-0" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-in-package" data-sym="IN-PACKAGE">in-package</a> <span class="string">"BRIDGE"</span>)</pre>
  </div>

<div class="form-block other" id="form-1" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/util/defines.html" title="Open std/util/defines">"std/util/defines"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-2" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/strings/cat.html" title="Open std/strings/cat">"std/strings/cat"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-3" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/strings/decimal.html" title="Open std/strings/decimal">"std/strings/decimal"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-4" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/basic/two-nats-measure.html" title="Open std/basic/two-nats-measure">"std/basic/two-nats-measure"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>)</pre>
  </div>

<div class="form-block other" id="form-5" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/strings/explode-atom.html" title="Open std/strings/explode-atom">"std/strings/explode-atom"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-6" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/strings/strtok.html" title="Open std/strings/strtok">"std/strings/strtok"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-7" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../centaur/bitops/ihsext-basics.html" title="Open centaur/bitops/ihsext-basics">"centaur/bitops/ihsext-basics"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-8" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/testing/assert-bang.html" title="Open std/testing/assert-bang">"std/testing/assert-bang"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-9" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/typed-lists/character-listp.html" title="Open std/typed-lists/character-listp">"std/typed-lists/character-listp"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))</pre>
  </div>

<div class="form-block other" id="form-10" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defsection json-encoding
  <span class="keyword">:parents</span> (bridge)
  <span class="keyword">:short</span> <span class="string">"Simple encoder to convert ACL2 Objects into JSON Objects."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;h3&gt;Introduction&lt;/h3&gt;

&lt;p&gt;Sensibly converting ACL2 objects into JSON is not at all
straightforward.&lt;/p&gt;

&lt;p&gt;On one hand, JSON is very rich.  Should we try to map association lists into
JSON objects, or should we just treat all cons trees the same and use arrays?
Since JSON has distinct NULL and FALSE values, which should we map NIL
into?&lt;/p&gt;

&lt;p&gt;On the other, JSON is missing some types that we would like.  Should we just
map ACL2 symbols and strings into strings, and lose the distinction between
them?  What on earth should we do with rationals and complex numbers?  Should
we assume that the JSON consumer supports bignums, or use a separate bignum
encoding?&lt;/p&gt;

&lt;p&gt;Arguably, the &quot;safe&quot; approach would be: develop a reliable JSON encoding
that ensures a unique interpretation of each ACL2 object.  For instance, we
should keep symbols and strings separate, record the name/package of each
symbol separately, etc.&lt;/p&gt;

&lt;p&gt;But that would suck.  The resulting JSON objects would be full of unwieldy
type information, which most of the time we wouldn&#39;t care about.  Usually, we
are hooking up ACL2 to web pages or other interfaces that want to get some
simple, small fragments of data.  In this context, I&#39;d prefer a simple
representation that is easy to work with, even at the cost of losing some
precision.&lt;/p&gt;

&lt;h3&gt;Atoms&lt;/h3&gt;

&lt;p&gt;I encode every ACL2 atom as a JSON string.  For example:&lt;/p&gt;

@({
      Lisp Atom           JSON
    ---------------------------------------
       NIL                &quot;NIL&quot;
       T                  &quot;T&quot;
       FOO                &quot;FOO&quot;
       :FOO               &quot;:FOO&quot;
       &quot;foo&quot;              &quot;foo&quot;
       #\f                &quot;f&quot;
       123                &quot;123&quot;
       -123               &quot;-123&quot;
       -1/2               &quot;-1/2&quot;
       #c(17/2 -3/8)      &quot;#C(17/2 -3/8)&quot;
    ---------------------------------------
})

&lt;p&gt;This has many quirks.  The main weirdness is that there are many ACL2
objects which, although they are not EQUAL, cannot be told apart from one
another in the JSON world.  For instance, the atoms on each line below have
identical JSON encodings:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;@(&#39;ACL2::FOO,    VL::FOO,     &quot;FOO&quot;          &#39;)&lt;/li&gt;
&lt;li&gt;@(&#39;ACL2::F,      VL::F,       &quot;F&quot;,      #\F &#39;)&lt;/li&gt;
&lt;li&gt;@(&#39;ACL2::|123|,  VL::|123|,   &quot;123&quot;,    123  &#39;)&lt;/li&gt;
&lt;li&gt;@(&#39;:FOO,         &quot;:FOO&quot;,    ACL2::|:FOO|     &#39;)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Some motivation behind this approach:&lt;/p&gt;

&lt;ul&gt;

&lt;li&gt;Why use &quot;NIL&quot; and &quot;T&quot; instead of, e.g., JSON&#39;s null (or false) and
true?  The main reason is that null/true can&#39;t be used as keys in JSON objects,
so this would lead to either special handling of alists with nil/t keys, or
alists that have different encoding depending on their keys, and it just seems
simpler to use strings for all atoms.&lt;/li&gt;

&lt;li&gt;Why use &quot;123&quot; when JSON has integers?  The same reason as for NIL and T
applies, but also: the JSON &quot;spec&quot; doesn&#39;t mandate what ranges of numbers its
implementations have to support, and practically speaking many of its
implementations don&#39;t use bignums.  So, what are the options?  (1) Use integers
for small numbers and do something special for bignums.  But this would be
quite error prone when programming the client.  (2) Assume bignums are
supported and just accept that clients will see garbage in some cases.  But
that is just terrible.  So given all this, just using strings seems like the
best thing to do.&lt;/li&gt;

&lt;/ul&gt;

&lt;h3&gt;Conses&lt;/h3&gt;

&lt;p&gt;With one exception (see below), I encode any true-lists as a JSON arrays
containing its encoded elements, and I encode any &quot;improper&quot; list as a JSON
array containing its encoded elements AND its final cdr.  For example:&lt;/p&gt;

@({
       Lisp Object                     JSON
    -------------------------------------------------------------
       (a . nil)                       [&quot;A&quot;]
       (a . b)                         [&quot;A&quot;,&quot;B&quot;]
       (a b . nil)                     [&quot;A&quot;,&quot;B&quot;]
       (a b . c)                       [&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]
       (a b c . nil)                   [&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]
       ((a . b) (c . d) . e)           [[&quot;A&quot;,&quot;B&quot;],[&quot;C&quot;,&quot;D&quot;],&quot;E&quot;]
})

&lt;p&gt;This has its own quirks.  For instance, as with atoms, you can&#39;t tell the
difference between Lisp objects like: (A B C) and (A B . C).&lt;/p&gt;

&lt;p&gt;The exception is that, for proper ALISTS whose every key is an atom, I
instead generate the corresponding JSON Object.  For example:&lt;/p&gt;

@({
       Lisp Object                     JSON
    -------------------------------------------------------------
       ((a . b))                      {&quot;A&quot;:&quot;B&quot;}
       ((a . b) (c . d))              {&quot;A&quot;:&quot;B&quot;,&quot;C&quot;:&quot;D&quot;}
       ((a . b) (c . d) . e)          [[&quot;A&quot;,&quot;B&quot;],[&quot;C&quot;,&quot;D&quot;],&quot;E&quot;]
})

&lt;p&gt;In certain cases, this runs the risk that you might see a different encoding
for an alist, depending on whether or not you have inserted a cons.  But many
alists have atoms as keys, and it seems nice to use a real JSON object here
instead of a nested array of arrays.&lt;/p&gt;


&lt;h3&gt;Note about Top-Level JSON Objects&lt;/h3&gt;

&lt;p&gt;Earlier versions of the JSON grammar required top-level @(&#39;JSON-text&#39;)
instances to be either JSON Objects or Arrays.  This is no longer the case: the
latest JSON grammar allows any values at the top level.  If the object we&#39;re
given is an ordinary ACL2 atom, we just encode it as a JSON string.&lt;/p&gt;

&lt;p&gt;We found this to be useful in our client code.  It&#39;s nice to create a JSON
object that says: the return value is such and so, the standard output was such
and so, and the error value was such and so.  In this context, we just want to
stitch our ACL2 object into a larger piece of JSON text, and strings are
okay.&lt;/p&gt;"</span>)</pre>
  </div>

<div class="form-block other" id="form-11" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (set-default-parents json-encoding))</pre>
  </div>

<div class="form-block other" id="form-12" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode-weird-char
  <span class="keyword">:short</span> <span class="string">"Convert special characters into @(&#39;\uXXXX&#39;) sequences."</span>
  ((code <span class="keyword">:type</span> (unsigned-byte <span class="number">8</span>)) acc)
  <span class="keyword">:returns</span> (new-acc <a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a>
    <span class="keyword">:hyp</span> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc))
  <span class="keyword">:long</span> <span class="string">"&lt;p&gt;This lets us properly encode weird things like control
characters.&lt;/p&gt;

&lt;p&gt;BOZO we could use more readable encoding like @(&#39;\n&#39;) and @(&#39;\t&#39;) in some
cases.  For now we do it dumbly.&lt;/p&gt;"</span>
  <span class="keyword">:prepwork</span> ((<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> crock
       (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> (loghead <span class="number">4</span> code) <span class="number">15</span>)
       <span class="keyword">:rule-classes</span> ((<span class="keyword">:rewrite</span>) (<span class="keyword">:linear</span>))
       <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (disable unsigned-byte-p-of-loghead)
          <span class="keyword">:use</span> ((<span class="keyword">:instance</span> unsigned-byte-p-of-loghead
             (size <span class="number">4</span>)
             (size1 <span class="number">4</span>)
             (i code))))))) (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> crock2
        (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (integerp code)
            (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> <span class="number">0</span> code)
            (&lt; code <span class="number">256</span>))
          (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> (logtail <span class="number">4</span> code) <span class="number">15</span>))
        <span class="keyword">:rule-classes</span> ((<span class="keyword">:rewrite</span>) (<span class="keyword">:linear</span>))
        <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (disable unsigned-byte-p-of-logtail)
           <span class="keyword">:use</span> ((<span class="keyword">:instance</span> unsigned-byte-p-of-logtail
              (size <span class="number">4</span>)
              (size1 <span class="number">4</span>)
              (i code))))))))
  (b* ((lo (<a class="sym-link system" href="../../../axioms.html#def-logand" data-sym="LOGAND">logand</a> code <span class="number">15</span>)) (hi (<a class="sym-link system" href="../../../axioms.html#def-logand" data-sym="LOGAND">logand</a> (ash code <span class="number">-4</span>) <span class="number">15</span>))
      (acc (cons #\\ acc))
      (acc (cons #\u acc))
      (acc (cons #\0 acc))
      (acc (cons #\0 acc))
      (acc (cons (<a class="sym-link system" href="../../../axioms.html#def-digit-to-char" data-sym="DIGIT-TO-CHAR">digit-to-char</a> hi) acc))
      (acc (cons (<a class="sym-link system" href="../../../axioms.html#def-digit-to-char" data-sym="DIGIT-TO-CHAR">digit-to-char</a> lo) acc)))
    acc)
  ///
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> test
      (x)
      (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((acc (<a class="sym-link system" href="../../../axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (explode <span class="string">"abc "</span>))) (acc (json-encode-weird-char x acc)))
        (rchars-to-string acc))))
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-progn" data-sym="PROGN">progn</a> (assert! (equal (test <span class="number">0</span>) <span class="string">"abc \u0000"</span>))
      (assert! (equal (test <span class="number">1</span>) <span class="string">"abc \u0001"</span>))
      (assert! (equal (test <span class="number">2</span>) <span class="string">"abc \u0002"</span>))
      (assert! (equal (test <span class="number">15</span>) <span class="string">"abc \u000F"</span>))
      (assert! (equal (test <span class="number">16</span>) <span class="string">"abc \u0010"</span>))
      (assert! (equal (test <span class="number">17</span>) <span class="string">"abc \u0011"</span>))
      (assert! (equal (test <span class="number">18</span>) <span class="string">"abc \u0012"</span>))
      (assert! (equal (test <span class="number">253</span>) <span class="string">"abc \u00FD"</span>))
      (assert! (equal (test <span class="number">254</span>) <span class="string">"abc \u00FE"</span>))
      (assert! (equal (test <span class="number">255</span>) <span class="string">"abc \u00FF"</span>)))))</pre>
  </div>

<div class="form-block other" id="form-13" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode-char
  <span class="keyword">:parents</span> (json-encoding)
  ((x <span class="keyword">:type</span> character) acc)
  <span class="keyword">:returns</span> (new-acc <a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a>
    <span class="keyword">:hyp</span> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (characterp x)
      (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc)))
  <span class="keyword">:inline</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
  (b* (((when (<a class="sym-link system" href="../../../axioms.html#def-eql" data-sym="EQL">eql</a> x #\\)) (cons #\\ (cons #\\ acc))) ((when (<a class="sym-link system" href="../../../axioms.html#def-eql" data-sym="EQL">eql</a> x #\&quot;)) (cons #\&quot; (cons #\\ acc)))
      ((<a class="sym-link system" href="../../../axioms.html#def-the" data-sym="THE">the</a> (unsigned-byte <span class="number">8</span>) code) (char-code x))
      ((when (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> code <span class="number">31</span>) (<a class="sym-link system" href="../../../axioms.html#def-_3E_3D" data-sym="&gt;=">&gt;=</a> code <span class="number">127</span>))) (json-encode-weird-char code acc)))
    (cons x acc)))</pre>
  </div>

<div class="form-block other" id="form-14" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode-chars
  ((x <a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a>) acc)
  <span class="keyword">:returns</span> (new-acc <a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a>
    <span class="keyword">:hyp</span> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> x)
      (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc)))
  (b* (((when (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)) acc) (acc (json-encode-char (car x) acc)))
    (json-encode-chars (cdr x) acc)))</pre>
  </div>

<div class="form-block other" id="form-15" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode-str-aux
  <span class="keyword">:parents</span> (json-encode-str)
  ((x stringp <span class="keyword">:type</span> <a class="sym-link system" href="../../../axioms.html#def-string" data-sym="STRING">string</a>) (n <a class="sym-link system" href="../../../axioms.html#def-natp" data-sym="NATP">natp</a> <span class="keyword">:type</span> (integer <span class="number">0</span> <a class="sym-link system" href="../../../axioms.html#def-_2A" data-sym="*">*</a>))
    (xl (equal xl (<a class="sym-link system" href="../../../axioms.html#def-length" data-sym="LENGTH">length</a> x))
      <span class="keyword">:type</span> (integer <span class="number">0</span> <a class="sym-link system" href="../../../axioms.html#def-_2A" data-sym="*">*</a>))
    acc)
  <span class="keyword">:measure</span> (<a class="sym-link system" href="../../../axioms.html#def-nfix" data-sym="NFIX">nfix</a> (<a class="sym-link system" href="../../../axioms.html#def--" data-sym="-">-</a> (<a class="sym-link system" href="../../../axioms.html#def-nfix" data-sym="NFIX">nfix</a> xl) (<a class="sym-link system" href="../../../axioms.html#def-nfix" data-sym="NFIX">nfix</a> n)))
  <span class="keyword">:guard</span> (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> n xl)
  <span class="keyword">:split-types</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
  (b* (((when (<a class="sym-link system" href="../../../axioms.html#def-mbe" data-sym="MBE">mbe</a> <span class="keyword">:logic</span> (<a class="sym-link system" href="../../../axioms.html#def-zp" data-sym="ZP">zp</a> (<a class="sym-link system" href="../../../axioms.html#def--" data-sym="-">-</a> (<a class="sym-link system" href="../../../axioms.html#def-nfix" data-sym="NFIX">nfix</a> xl) (<a class="sym-link system" href="../../../axioms.html#def-nfix" data-sym="NFIX">nfix</a> n)))
          <span class="keyword">:exec</span> (<a class="sym-link system" href="../../../axioms.html#def-eql" data-sym="EQL">eql</a> n xl))) acc) (acc (json-encode-char (<a class="sym-link system" href="../../../axioms.html#def-char" data-sym="CHAR">char</a> x n)
          acc))
      ((<a class="sym-link system" href="../../../axioms.html#def-the" data-sym="THE">the</a> (integer <span class="number">0</span> <a class="sym-link system" href="../../../axioms.html#def-_2A" data-sym="*">*</a>) n) (<a class="sym-link system" href="../../../axioms.html#def-_2B" data-sym="+">+</a> <span class="number">1</span> (<a class="sym-link system" href="../../../axioms.html#def-the" data-sym="THE">the</a> (integer <span class="number">0</span> <a class="sym-link system" href="../../../axioms.html#def-_2A" data-sym="*">*</a>) (lnfix n)))))
    (json-encode-str-aux x
      n
      xl
      acc))
  ///
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../std/lists/nthcdr.html" title="Open std/lists/nthcdr">"std/lists/nthcdr"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-include-book" data-sym="INCLUDE-BOOK">include-book</a> <a class="include-path" href="../../../arithmetic/top.html" title="Open arithmetic/top">"arithmetic/top"</a> <span class="keyword">:dir</span> <span class="keyword">:system</span>))
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> nthcdr-of-increment
      (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-natp" data-sym="NATP">natp</a> n)
        (equal (<a class="sym-link system" href="../../../axioms.html#def-nthcdr" data-sym="NTHCDR">nthcdr</a> (<a class="sym-link system" href="../../../axioms.html#def-_2B" data-sym="+">+</a> <span class="number">1</span> n) x)
          (cdr (<a class="sym-link system" href="../../../axioms.html#def-nthcdr" data-sym="NTHCDR">nthcdr</a> n x))))
      <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable <a class="sym-link system" href="../../../axioms.html#def-nthcdr" data-sym="NTHCDR">nthcdr</a>)))))
  (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> json-encode-str-aux-redef
    (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (stringp x)
        (<a class="sym-link system" href="../../../axioms.html#def-natp" data-sym="NATP">natp</a> n)
        (<a class="sym-link system" href="../../../axioms.html#def-natp" data-sym="NATP">natp</a> xl)
        (<a class="sym-link system" href="../../../axioms.html#def-_3C_3D" data-sym="&lt;=">&lt;=</a> n xl)
        (<a class="sym-link system" href="../../../axioms.html#def-eql" data-sym="EQL">eql</a> xl (<a class="sym-link system" href="../../../axioms.html#def-length" data-sym="LENGTH">length</a> x)))
      (equal (json-encode-str-aux x
          n
          xl
          acc)
        (json-encode-chars (<a class="sym-link system" href="../../../axioms.html#def-nthcdr" data-sym="NTHCDR">nthcdr</a> n (explode x))
          acc)))
    <span class="keyword">:hints</span> ((<span class="string">"Goal"</span> <span class="keyword">:in-theory</span> (enable json-encode-str-aux
         json-encode-chars)
       <span class="keyword">:induct</span> (json-encode-str-aux x
         n
         xl
         acc)
       <span class="keyword">:expand</span> (json-encode-chars (<a class="sym-link system" href="../../../axioms.html#def-nthcdr" data-sym="NTHCDR">nthcdr</a> n (explode x))
         acc)))))</pre>
  </div>

<div class="form-block other" id="form-16" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode-str
  <span class="keyword">:short</span> <span class="string">"Fast string encoder that doesn&#39;t @(see coerce) the string into a
character list."</span>
  <span class="keyword">:inline</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
  <span class="keyword">:enabled</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
  ((x <span class="keyword">:type</span> <a class="sym-link system" href="../../../axioms.html#def-string" data-sym="STRING">string</a>) acc)
  (<a class="sym-link system" href="../../../axioms.html#def-mbe" data-sym="MBE">mbe</a> <span class="keyword">:logic</span> (json-encode-chars (explode x)
      acc)
    <span class="keyword">:exec</span> (json-encode-str-aux x
      <span class="number">0</span>
      (<a class="sym-link system" href="../../../axioms.html#def-length" data-sym="LENGTH">length</a> x)
      acc)))</pre>
  </div>

<div class="form-block other" id="form-17" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode-atom
  ((x <a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a>) acc)
  <span class="keyword">:returns</span> (new-acc <a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a>
    <span class="keyword">:hyp</span> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc))
  (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((acc (cons #\&quot; acc)) (acc (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((symbolp x) (json-encode-str (symbol-name x)
              (if (<a class="sym-link system" href="../../../axioms.html#def-keywordp" data-sym="KEYWORDP">keywordp</a> x)
                (cons #\: acc)
                acc)))
          ((integerp x) (if (&lt; x <span class="number">0</span>)
              (<a class="sym-link system" href="../../../axioms.html#def-revappend" data-sym="REVAPPEND">revappend</a> (nat-to-dec-chars (<a class="sym-link system" href="../../../axioms.html#def--" data-sym="-">-</a> x))
                (cons #\- acc))
              (<a class="sym-link system" href="../../../axioms.html#def-revappend" data-sym="REVAPPEND">revappend</a> (nat-to-dec-chars x) acc)))
          ((characterp x) (json-encode-char x acc))
          ((stringp x) (json-encode-str x acc))
          ((acl2-numberp x) (json-encode-chars (<a class="sym-link system" href="../../../axioms.html#def-explode-atom" data-sym="EXPLODE-ATOM">explode-atom</a> x <span class="number">10</span>)
              acc))
          (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="../../../axioms.html#def-progn_24" data-sym="PROGN$">progn$</a> (raise <span class="string">"Bad ACL2 object: ~x0"</span> x)
              acc)))))
    (cons #\&quot; acc))
  ///
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> test
      (x)
      (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((acc (<a class="sym-link system" href="../../../axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (explode <span class="string">"abc "</span>))) (acc (json-encode-atom x acc)))
        (rchars-to-string acc))))
  (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-progn" data-sym="PROGN">progn</a> (assert! (equal (test nil) <span class="string">"abc &quot;NIL&quot;"</span>))
      (assert! (equal (test <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>) <span class="string">"abc &quot;T&quot;"</span>))
      (assert! (equal (test 'foo) <span class="string">"abc &quot;FOO&quot;"</span>))
      (assert! (equal (test <span class="keyword">:foo</span>) <span class="string">"abc &quot;:FOO&quot;"</span>))
      (assert! (equal (test <span class="string">"foo"</span>) <span class="string">"abc &quot;foo&quot;"</span>))
      (assert! (equal (test #\f) <span class="string">"abc &quot;f&quot;"</span>))
      (assert! (equal (test <span class="number">123</span>) <span class="string">"abc &quot;123&quot;"</span>))
      (assert! (equal (test <span class="number">0</span>) <span class="string">"abc &quot;0&quot;"</span>))
      (assert! (equal (test <span class="number">-123</span>) <span class="string">"abc &quot;-123&quot;"</span>))
      (assert! (equal (test <span class="number">-1/2</span>) <span class="string">"abc &quot;-1/2&quot;"</span>))
      (assert! (equal (test <span class="number">#C(17/2 -3/8)</span>) <span class="string">"abc &quot;#C(17/2 -3/8)&quot;"</span>)))))</pre>
  </div>

<div class="form-block other" id="form-18" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-simple-alist-p
  (x)
  <span class="keyword">:short</span> <span class="string">"A proper alist whose every key is an atom."</span>
  (if (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)
    (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> x)
    (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (consp (car x))
      (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> (<a class="sym-link system" href="../../../axioms.html#def-caar" data-sym="CAAR">caar</a> x))
      (json-simple-alist-p (cdr x)))))</pre>
  </div>

<div class="form-block other" id="form-19" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-comma-and-maybe-newline
  (acc)
  (if (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (consp acc)
      (<a class="sym-link system" href="../../../axioms.html#def-or" data-sym="OR">or</a> (<a class="sym-link system" href="../../../axioms.html#def-eql" data-sym="EQL">eql</a> (car acc) #\]) (<a class="sym-link system" href="../../../axioms.html#def-eql" data-sym="EQL">eql</a> (car acc) #\})))
    (cons #\
 (cons #\, acc))
    (cons #\, acc)))</pre>
  </div>

<div class="form-block other" id="form-20" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defines json-encode-main
  <span class="keyword">:short</span> <span class="string">"Main function for JSON encoding."</span>
  <span class="keyword">:long</span> <span class="string">"&lt;p&gt;@(call json-encode) accumulates the JSON encoding of @(&#39;x&#39;) onto
@(&#39;acc&#39;).  That is, @(&#39;acc&#39;) is extended with the reverse-order characters for
@(&#39;x&#39;)&#39;s encoding in reverse order.&lt;/p&gt;

&lt;p&gt;This function &lt;b&gt;does not&lt;/b&gt; necessarily produce a valid JSON object.  Per
the JSON RFC, plain JSON values other than arrays and objects are not valid
JSON text.  See @(see json-encode) instead, for a function that does something
to fix up atoms.&lt;/p&gt;"</span>
  <span class="keyword">:prepwork</span> ((<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-in-theory" data-sym="IN-THEORY">in-theory</a> (enable json-simple-alist-p
         json-comma-and-maybe-newline))))
  (define json-encode-main
    ((x <span class="string">"Any arbitrary ACL2 object."</span>) (acc <span class="string">"Accumulator, characters in reverse order."</span>))
    <span class="keyword">:flag</span> <span class="keyword">:main</span> <span class="keyword">:guard-debug</span> <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>
    <span class="keyword">:measure</span> (two-nats-measure (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> x) <span class="number">1</span>)
    (<a class="sym-link system" href="../../../axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x) (json-encode-atom x acc))
      ((json-simple-alist-p x) (json-encode-simple-alist x
          (cons #\{ acc)))
      ((<a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a> x) (json-encode-true-list x
          (cons #\[ acc)))
      (<a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a> (json-encode-improper-cons-list x
          (cons #\[ acc)))))
  (define json-encode-simple-alist
    ((x json-simple-alist-p) acc)
    <span class="keyword">:flag</span> <span class="keyword">:alist</span> <span class="keyword">:measure</span> (two-nats-measure (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> x) <span class="number">0</span>)
    (b* (((when (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)) (cons #\} acc)) (acc (json-encode-atom (<a class="sym-link system" href="../../../axioms.html#def-caar" data-sym="CAAR">caar</a> x) acc))
        (acc (cons #\: acc))
        (acc (json-encode-main (<a class="sym-link system" href="../../../axioms.html#def-cdar" data-sym="CDAR">cdar</a> x) acc))
        (acc (if (consp (cdr x))
            (json-comma-and-maybe-newline acc)
            acc)))
      (json-encode-simple-alist (cdr x)
        acc)))
  (define json-encode-true-list
    ((x <a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a>) acc)
    <span class="keyword">:flag</span> <span class="keyword">:true-list</span> <span class="keyword">:measure</span> (two-nats-measure (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> x) <span class="number">0</span>)
    (b* (((when (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)) (cons #\] acc)) (acc (json-encode-main (car x) acc))
        (acc (if (consp (cdr x))
            (json-comma-and-maybe-newline acc)
            acc)))
      (json-encode-true-list (cdr x) acc)))
  (define json-encode-improper-cons-list
    ((x (<a class="sym-link system" href="../../../axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link system" href="../../../axioms.html#def-true-listp" data-sym="TRUE-LISTP">true-listp</a> x))) acc)
    <span class="keyword">:flag</span> <span class="keyword">:improper</span> <span class="keyword">:measure</span> (two-nats-measure (<a class="sym-link system" href="../../../axioms.html#def-acl2-count" data-sym="ACL2-COUNT">acl2-count</a> x) <span class="number">0</span>)
    (b* (((when (<a class="sym-link system" href="../../../axioms.html#def-atom" data-sym="ATOM">atom</a> x)) (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((acc (json-encode-atom x acc)))
           (cons #\] acc))) (acc (json-encode-main (car x) acc))
        (acc (json-comma-and-maybe-newline acc)))
      (json-encode-improper-cons-list (cdr x)
        acc)))
  ///
  (defthm-json-encode-main-flag (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> character-listp-of-json-encode-main
      (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc)
        (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> (json-encode-main x acc)))
      <span class="keyword">:flag</span> <span class="keyword">:main</span>)
    (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> character-listp-of-json-encode-simple-alist
      (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc))
        (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> (json-encode-simple-alist x acc)))
      <span class="keyword">:flag</span> <span class="keyword">:alist</span>)
    (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> character-listp-of-json-encode-true-list
      (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc)
        (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> (json-encode-true-list x acc)))
      <span class="keyword">:flag</span> <span class="keyword">:true-list</span>)
    (<a class="sym-link system" href="../../../axioms.html#def-defthm" data-sym="DEFTHM">defthm</a> character-listp-of-json-encode-improper-cons-list
      (<a class="sym-link system" href="../../../axioms.html#def-implies" data-sym="IMPLIES">implies</a> (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> acc)
        (<a class="sym-link system" href="../../../axioms.html#def-character-listp" data-sym="CHARACTER-LISTP">character-listp</a> (json-encode-improper-cons-list x
            acc)))
      <span class="keyword">:flag</span> <span class="keyword">:improper</span>)))</pre>
  </div>

<div class="form-block other" id="form-21" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (defsection basic-test
    (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> collapse-newlines
      (x)
      (<a class="sym-link system" href="../../../axioms.html#def-string-append-lst" data-sym="STRING-APPEND-LST">string-append-lst</a> (strtok x '(#\
))))
    (<a class="sym-link system" href="../../../axioms.html#def-defun" data-sym="DEFUN">defun</a> test
      (x)
      (<a class="sym-link system" href="../../../axioms.html#def-let_2A" data-sym="LET*">let*</a> ((acc (<a class="sym-link system" href="../../../axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (explode <span class="string">"abc "</span>))) (acc (json-encode-main x acc)))
        (collapse-newlines (rchars-to-string acc))))
    (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-progn" data-sym="PROGN">progn</a> (assert! (equal (test nil) <span class="string">"abc &quot;NIL&quot;"</span>))
        (assert! (equal (test <a class="sym-link system" href="../../../axioms.html#def-t" data-sym="T">t</a>) <span class="string">"abc &quot;T&quot;"</span>))
        (assert! (equal (test 'foo) <span class="string">"abc &quot;FOO&quot;"</span>))
        (assert! (equal (test <span class="keyword">:foo</span>) <span class="string">"abc &quot;:FOO&quot;"</span>))
        (assert! (equal (test <span class="string">"foo"</span>) <span class="string">"abc &quot;foo&quot;"</span>))
        (assert! (equal (test #\f) <span class="string">"abc &quot;f&quot;"</span>))
        (assert! (equal (test <span class="number">123</span>) <span class="string">"abc &quot;123&quot;"</span>))
        (assert! (equal (test <span class="number">0</span>) <span class="string">"abc &quot;0&quot;"</span>))
        (assert! (equal (test <span class="number">-123</span>) <span class="string">"abc &quot;-123&quot;"</span>))
        (assert! (equal (test <span class="number">-1/2</span>) <span class="string">"abc &quot;-1/2&quot;"</span>))
        (assert! (equal (test <span class="number">#C(17/2 -3/8)</span>) <span class="string">"abc &quot;#C(17/2 -3/8)&quot;"</span>))))
    (<a class="sym-link system" href="../../../axioms.html#def-local" data-sym="LOCAL">local</a> (<a class="sym-link system" href="../../../axioms.html#def-progn" data-sym="PROGN">progn</a> (assert! (equal (test '(a)) <span class="string">"abc [&quot;A&quot;]"</span>))
        (assert! (equal (test '(a . b))
            <span class="string">"abc [&quot;A&quot;,&quot;B&quot;]"</span>))
        (assert! (equal (test '(a b))
            <span class="string">"abc [&quot;A&quot;,&quot;B&quot;]"</span>))
        (assert! (equal (test '(a b . c))
            <span class="string">"abc [&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]"</span>))
        (assert! (equal (test '(a b c))
            <span class="string">"abc [&quot;A&quot;,&quot;B&quot;,&quot;C&quot;]"</span>))
        (assert! (equal (test '((a . b) (c . d) . e))
            <span class="string">"abc [[&quot;A&quot;,&quot;B&quot;],[&quot;C&quot;,&quot;D&quot;],&quot;E&quot;]"</span>))
        (assert! (equal (test '((a . b)))
            <span class="string">"abc {&quot;A&quot;:&quot;B&quot;}"</span>))
        (assert! (equal (test '((a . b) (c . d)))
            <span class="string">"abc {&quot;A&quot;:&quot;B&quot;,&quot;C&quot;:&quot;D&quot;}"</span>))
        (assert! (equal (test '(a ((<span class="number">1</span> . <span class="keyword">:foo</span>) (<span class="number">2</span> <span class="keyword">:foo</span> <span class="keyword">:bar</span> <span class="keyword">:baz</span>)
                  (<span class="number">3</span> (<span class="keyword">:foo</span> . a) (<span class="keyword">:bar</span> . b) (<span class="keyword">:baz</span> . c)))
                <span class="number">15</span>
                <span class="number">17/2</span> . <span class="keyword">:end</span>))
            (<a class="sym-link system" href="../../../axioms.html#def-concatenate" data-sym="CONCATENATE">concatenate</a> '<a class="sym-link system" href="../../../axioms.html#def-string" data-sym="STRING">string</a>
              <span class="string">"abc [&quot;A&quot;,"</span>
              <span class="string">"{"</span>
              <span class="string">"&quot;1&quot;:&quot;:FOO&quot;,"</span>
              <span class="string">"&quot;2&quot;:[&quot;:FOO&quot;,&quot;:BAR&quot;,&quot;:BAZ&quot;],"</span>
              <span class="string">"&quot;3&quot;:"</span>
              <span class="string">"{"</span>
              <span class="string">"&quot;:FOO&quot;:&quot;A&quot;,"</span>
              <span class="string">"&quot;:BAR&quot;:&quot;B&quot;,"</span>
              <span class="string">"&quot;:BAZ&quot;:&quot;C&quot;"</span>
              <span class="string">"}"</span>
              <span class="string">"},"</span>
              <span class="string">"&quot;15&quot;,"</span>
              <span class="string">"&quot;17/2&quot;,"</span>
              <span class="string">"&quot;:END&quot;]"</span>)))))))</pre>
  </div>

<div class="form-block other" id="form-22" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define json-encode
  <span class="keyword">:short</span> <span class="string">"Top level wrapper for @(see json-encode-main)."</span>
  ((x <span class="string">"Any ACL2 object."</span>))
  <span class="keyword">:returns</span> (x-json <span class="string">"The JSON-encoded version of @(&#39;x&#39;)."</span>
    stringp
    <span class="keyword">:rule-classes</span> <span class="keyword">:type-prescription</span>)
  <span class="keyword">:long</span> <span class="string">"&lt;p&gt;This wraps up the accumulator used by @(see json-encode-main) and
deals with getting the characters into the right order.&lt;/p&gt;"</span>
  (let ((acc (json-encode-main x nil)))
    (rchars-to-string acc)))</pre>
  </div>


  </main>
  
<script>
// ACL2 Book HTML Documentation - Interactive Features
// Generated by cert2 - build2 system

// State
let activeFilter = null;
let activePartFilter = null;
let activeNameFilter = null;
let currentFontSize = 14;

// Theme management
function getStoredTheme() {
  return localStorage.getItem('acl2-theme') || 'dark';
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('theme-toggle').textContent = '🌙';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('theme-toggle').textContent = '☀️';
  }
  localStorage.setItem('acl2-theme', theme);
}

function toggleTheme() {
  const current = getStoredTheme();
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Font size management
function getStoredFontSize() {
  return parseInt(localStorage.getItem('acl2-fontsize') || '14', 10);
}

function setFontSize(size) {
  size = Math.max(10, Math.min(24, size)); // Clamp between 10-24
  currentFontSize = size;
  document.body.style.fontSize = size + 'px';
  localStorage.setItem('acl2-fontsize', size.toString());
}

function increaseFontSize() {
  setFontSize(currentFontSize + 2);
}

function decreaseFontSize() {
  setFontSize(currentFontSize - 2);
}

// Get all form blocks
function getFormBlocks() {
  return document.querySelectorAll('.form-block');
}

// Clear all filters
function clearFilter() {
  activeFilter = null;
  activePartFilter = null;
  activeNameFilter = null;
  getFormBlocks().forEach(b => {
    b.classList.remove('hidden', 'dimmed');
  });
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  const status = document.querySelector('.filter-status');
  status.classList.remove('active');
  // Slide name filter back to original position
  document.querySelector('.controls-left').style.transform = '';
  // Clear the name filter input
  const nameInput = document.getElementById('name-filter');
  if (nameInput) nameInput.value = '';
}

// Show filter status and slide name filter right
function showFilterStatus(text) {
  const status = document.querySelector('.filter-status');
  status.classList.add('active');
  status.querySelector('.filter-text').textContent = text;
  // Slide name filter to the right to make room
  setTimeout(() => {
    const statusWidth = status.offsetWidth;
    document.querySelector('.controls-left').style.transform = `translateX(${statusWidth + 15}px)`;
  }, 10);
}

// Filter to show only forms that define or reference a symbol
function filterBySymbol(symName, showUsedBy) {
  clearFilter();
  activeFilter = symName;
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines;
    const references = (block.dataset.references || '').split(',');
    const usedBy = (block.dataset.usedBy || '').split(',');
    
    let show = false;
    if (showUsedBy) {
      // Show forms that USE this symbol
      show = references.includes(symName) || definesName === symName;
    } else {
      // Show forms that this symbol USES
      show = usedBy.includes(symName) || definesName === symName;
    }
    
    if (show) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering by: ${symName} (${visibleCount} items)`);
}

// Filter by defthm part (term, hints, rule-classes, etc.)
function filterByPart(formId, partName) {
  clearFilter();
  activePartFilter = { formId, partName };
  
  // Get the part's referenced symbols
  // data-part-term becomes dataset.partTerm, data-part-hints becomes dataset.partHints, etc.
  const block = document.getElementById(formId);
  const datasetKey = 'part' + partName.charAt(0).toUpperCase() + partName.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase());
  const partData = block.dataset[datasetKey];
  if (!partData) return;
  
  const partSyms = partData.split(',').filter(s => s);
  
  // Highlight the button
  block.querySelector(`.part-btn[data-part="${partName}"]`).classList.add('active');
  
  // Hide forms not referenced by this part
  getFormBlocks().forEach(b => {
    const definesName = b.dataset.defines;
    if (b.id === formId || partSyms.includes(definesName)) {
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering ${formId} :${partName} (${partSyms.length} references)`);
}

// Filter by name (substring or regex)
function filterByName(pattern, useRegex) {
  // Clear other filters but keep the input value
  activeFilter = null;
  activePartFilter = null;
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  
  if (!pattern || pattern.trim() === '') {
    // Empty pattern - show all
    activeNameFilter = null;
    getFormBlocks().forEach(b => b.classList.remove('hidden'));
    const status = document.querySelector('.filter-status');
    status.classList.remove('active');
    document.querySelector('.controls-left').style.transform = '';
    return;
  }
  
  activeNameFilter = pattern;
  
  let matcher;
  let isValidRegex = true;
  
  if (useRegex) {
    try {
      matcher = new RegExp(pattern, 'i');
    } catch (e) {
      // Invalid regex - show error in status and don't filter
      showFilterStatus(`Invalid regex: ${e.message}`);
      return;
    }
  } else {
    // Plain substring match (case-insensitive)
    const lowerPattern = pattern.toLowerCase();
    matcher = { test: (s) => s.toLowerCase().includes(lowerPattern) };
  }
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines || '';
    if (matcher.test(definesName)) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  const modeText = useRegex ? 'regex' : 'name';
  showFilterStatus(`Filtering by ${modeText}: "${pattern}" (${visibleCount} matches)`);
}

// Click on a name to show what references it
function handleNameClick(symName) {
  if (activeFilter === symName) {
    clearFilter();
  } else {
    filterBySymbol(symName, true);
  }
}

// Navigate to a definition (same file or different)
function navigateTo(symName, file) {
  if (file) {
    // External file - navigate
    window.location.href = file + '.html#def-' + symName.toLowerCase();
  } else {
    // Same file - scroll
    const target = document.getElementById('def-' + symName.toLowerCase());
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('highlight');
      setTimeout(() => target.classList.remove('highlight'), 400);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Part buttons
  document.querySelectorAll('.part-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const formId = btn.closest('.form-block').id;
      const partName = btn.dataset.part;
      if (activePartFilter && activePartFilter.formId === formId && 
          activePartFilter.partName === partName) {
        clearFilter();
      } else {
        filterByPart(formId, partName);
      }
    });
  });
  
  // Clear filter button
  document.querySelector('.clear-filter').addEventListener('click', clearFilter);
  
  // Name filter input
  const nameFilter = document.getElementById('name-filter');
  const regexToggle = document.getElementById('regex-toggle');
  
  let filterTimeout = null;
  nameFilter.addEventListener('input', () => {
    // Debounce the filter to avoid excessive updates while typing
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      filterByName(nameFilter.value, regexToggle.checked);
    }, 150);
  });
  
  // Re-filter when regex toggle changes
  regexToggle.addEventListener('change', () => {
    if (nameFilter.value) {
      filterByName(nameFilter.value, regexToggle.checked);
    }
  });
  
  // Allow Escape key to clear filter when in input
  nameFilter.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearFilter();
      nameFilter.blur();
    }
  });
  
  // Symbol references (old span-based refs)
  document.querySelectorAll('.sym-ref').forEach(ref => {
    ref.addEventListener('click', (e) => {
      e.stopPropagation();
      const sym = ref.dataset.sym;
      const file = ref.dataset.file;
      if (file) {
        navigateTo(sym, file);
      } else {
        handleNameClick(sym);
      }
    });
  });
  
  // Symbol links (new anchor-based links)
  // These use standard <a> tags so navigation happens automatically
  // But we need to clear filters if target would be hidden
  document.querySelectorAll('.sym-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('#')) {
        // Local link - check if target is hidden by filter
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          // If target is hidden, clear the filter first
          if (target.classList.contains('hidden')) {
            clearFilter();
          }
          // Add highlight effect after a short delay
          setTimeout(() => {
            target.classList.add('highlight');
            setTimeout(() => target.classList.remove('highlight'), 400);
          }, 100);
        }
      }
      // For external links, default behavior handles navigation
    });
  });
  
  // Form names (show what uses them)
  document.querySelectorAll('.form-name').forEach(name => {
    name.addEventListener('click', (e) => {
      handleNameClick(name.dataset.sym);
    });
  });
  
  // Handle hash navigation (when arriving at page with #anchor)
  if (window.location.hash) {
    const target = document.querySelector(window.location.hash);
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.classList.add('highlight');
        setTimeout(() => target.classList.remove('highlight'), 400);
      }, 200);
    }
  }
  
  // Initialize theme from storage
  setTheme(getStoredTheme());
  
  // Initialize font size from storage
  currentFontSize = getStoredFontSize();
  setFontSize(currentFontSize);
  
  // Theme toggle button
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  
  // Font size buttons
  document.getElementById('font-larger').addEventListener('click', increaseFontSize);
  document.getElementById('font-smaller').addEventListener('click', decreaseFontSize);
});

</script>

</body>
</html>