<!DOCTYPE html>
<html lang="en" vocab="http://schema.org/" typeof="SoftwareSourceCode">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>futures-raw - ACL2 Book</title>
  <meta property="name" content="futures-raw">
  <meta property="programmingLanguage" content="ACL2">
  
<style>
/* ACL2 Book HTML Documentation Styles */
/* Generated by cert2 - build2 system */

/* Dark theme (default) */
:root {
  --bg: #1e1e2e;
  --fg: #cdd6f4;
  --comment: #6c7086;
  --keyword: #cba6f7;
  --string: #a6e3a1;
  --function: #89b4fa;
  --type: #f9e2af;
  --link: #89dceb;
  --link-hover: #f5c2e7;
  --highlight: rgba(137, 180, 250, 0.2);
  --border: #313244;
  --block-bg: rgba(49, 50, 68, 0.5);
  --btn-bg: #313244;
  --btn-hover: rgba(137, 180, 250, 0.2);
}

/* Light theme */
[data-theme="light"] {
  --bg: #eff1f5;
  --fg: #4c4f69;
  --comment: #6c6f85;
  --keyword: #8839ef;
  --string: #40a02b;
  --function: #1e66f5;
  --type: #df8e1d;
  --link: #04a5e5;
  --link-hover: #ea76cb;
  --highlight: rgba(30, 102, 245, 0.15);
  --border: #ccd0da;
  --block-bg: rgba(204, 208, 218, 0.3);
  --btn-bg: #ccd0da;
  --btn-hover: rgba(30, 102, 245, 0.15);
}

body {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  padding: 20px;
  line-height: 1.6;
  font-size: 14px;
  transition: background 0.1s, color 0.1s;
}

/* Controls toolbar */
.controls-left {
  position: fixed;
  top: 10px;
  left: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
  transition: transform 0.1s ease;
}

.controls-right {
  position: fixed;
  top: 10px;
  right: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 200;
}

.control-btn {
  padding: 6px 12px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  transition: all 0.1s;
}

.control-btn:hover {
  background: var(--btn-hover);
  border-color: var(--link);
}

.name-filter {
  padding: 6px 10px;
  background: var(--btn-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--fg);
  font-family: inherit;
  font-size: 13px;
  width: 150px;
  transition: all 0.1s;
}

.name-filter:focus {
  outline: none;
  border-color: var(--link);
  width: 200px;
}

.name-filter::placeholder {
  color: var(--comment);
}

.regex-label {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--comment);
  font-size: 12px;
  cursor: pointer;
}

.regex-label input {
  cursor: pointer;
}

.book-header {
  border-bottom: 2px solid var(--border);
  padding-bottom: 20px;
  margin-bottom: 20px;
}

.book-header h1 {
  color: var(--keyword);
  margin: 0;
}

.book-header .path {
  color: var(--comment);
  font-size: 0.9em;
}

.book-header .path .source-link {
  color: var(--comment);
  text-decoration: none;
}

.book-header .path .source-link:hover {
  color: var(--link);
  text-decoration: underline;
}

.form-block {
  margin: 10px 0;
  padding: 15px;
  background: var(--block-bg);
  border-radius: 8px;
  border-left: 3px solid var(--border);
}

.form-block.theorem { border-left-color: var(--keyword); }
.form-block.function { border-left-color: var(--function); }
.form-block.macro { border-left-color: var(--type); }
.form-block.include-book { border-left-color: var(--string); }

.form-block.hidden { display: none; }
.form-block.dimmed { opacity: 0.3; }

.form-block.highlight {
  animation: highlight-pulse 0.4s ease-out;
}

@keyframes highlight-pulse {
  0% { background: var(--highlight); box-shadow: 0 0 20px var(--link); }
  100% { background: rgba(49, 50, 68, 0.5); box-shadow: none; }
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.form-name {
  color: var(--function);
  font-weight: bold;
  cursor: pointer;
}

.form-name:hover {
  color: var(--link-hover);
  text-decoration: underline;
}

.form-type {
  color: var(--comment);
  font-size: 0.85em;
}

pre.code {
  margin: 0;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.sym-ref {
  color: var(--link);
  cursor: pointer;
  border-radius: 2px;
}

.sym-ref:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.sym-ref.local-def { color: var(--function); font-weight: bold; }
.sym-ref.external { color: var(--type); }

/* Symbol links (clickable hyperlinks) */
.sym-link {
  color: var(--link);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.sym-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

.sym-link.local-def {
  color: var(--function);
  font-weight: bold;
}

.sym-link.external {
  color: var(--type);
}

/* Tooltips using title attribute with custom styling */
.sym-link[title] {
  /* Browser will show title on hover */
}

/* Syntax highlighting in code blocks */
.keyword {
  color: var(--keyword);
}

.string {
  color: var(--string);
}

.number {
  color: #f77524; /* orange */
}

/* Include-book path links */
.include-path {
  color: var(--string);
  text-decoration: none;
  border-radius: 2px;
  cursor: pointer;
}

.include-path:hover {
  background: var(--highlight);
  color: var(--link-hover);
  text-decoration: underline;
}

/* Part buttons for defthm */
.part-buttons {
  display: flex;
  gap: 5px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.part-btn {
  padding: 4px 10px;
  background: var(--border);
  border: 1px solid var(--comment);
  border-radius: 4px;
  color: var(--fg);
  cursor: pointer;
  font-size: 0.85em;
  font-family: inherit;
}

.part-btn:hover {
  background: var(--highlight);
  border-color: var(--link);
}

.part-btn.active {
  background: var(--link);
  color: var(--bg);
  border-color: var(--link);
}

/* References panel */
.refs-panel {
  margin-top: 10px;
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  display: none;
}

.refs-panel.visible { display: block; }

.refs-panel h4 {
  margin: 0 0 5px 0;
  color: var(--comment);
  font-size: 0.9em;
}

.refs-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

/* Included books section */
.includes-section {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(49, 50, 68, 0.3);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.includes-section h2 {
  margin: 0 0 10px 0;
  color: var(--comment);
  font-size: 1em;
  font-weight: normal;
}

.includes-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.include-link {
  padding: 6px 12px;
  background: var(--border);
  border-radius: 4px;
  color: var(--link);
  text-decoration: none;
  font-size: 0.9em;
  transition: all 0.1s;
}

.include-link:hover {
  background: var(--highlight);
  color: var(--link-hover);
}

.include-link.local {
  border-left: 2px solid var(--comment);
}

/* Filter status */
.filter-status {
  position: fixed;
  top: 10px;
  left: 20px;
  background: var(--bg);
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  z-index: 201;
  display: none;
  align-items: center;
  gap: 10px;
}

.filter-status.active {
  display: flex;
  align-items: center;
  gap: 10px;
}

.clear-filter {
  padding: 5px 15px;
  background: var(--keyword);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* RDFa vocab indicator */
[vocab] { /* semantic web annotations present */ }

</style>

</head>
<body>
  <div class="controls-left">
    <input type="text" id="name-filter" class="name-filter" placeholder="Filter by name..." title="Filter definitions by name">
    <label class="regex-label"><input type="checkbox" id="regex-toggle"> regex</label>
  </div>

  <div class="controls-right">
    <button class="control-btn" id="theme-toggle" title="Toggle light/dark theme">☀️</button>
    <button class="control-btn" id="font-smaller" title="Decrease font size">A-</button>
    <button class="control-btn" id="font-larger" title="Increase font size">A+</button>
  </div>

  <div class="filter-status">
    <span class="filter-text">Filtering...</span>
    <button class="clear-filter">Clear Filter</button>
  </div>
  
  <div class="book-header">
    <h1 property="name">futures-raw</h1>
    <div class="path"><a href="futures-raw.lisp" class="source-link">futures-raw</a></div>
  </div>
  
  <main property="text">
<div class="form-block other" id="form-0" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-in-package" data-sym="IN-PACKAGE">in-package</a> <span class="string">"ACL2"</span>)</pre>
  </div>

<div class="form-block other" id="form-1" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defstruct <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>
  (<a class="sym-link system" href="axioms.html#def-value" data-sym="VALUE">value</a> nil)
  (valid nil)
  (<a class="sym-link system" href="axioms.html#def-closure" data-sym="CLOSURE">closure</a> nil)
  (aborted nil))</pre>
  </div>

<div class="form-block macro" id="def-st-future" data-defines="ST-FUTURE" data-references="ST-FUTURE-VALID,LAMBDA,ST-FUTURE-CLOSURE,SETF,MAKE-ST-FUTURE,LET,QUASIQUOTE,X,DEFMACRO" data-used-by="MT-FUTURE,ST-FUTURE-ABORT,ST-FUTURE-READ" typeof="Code">
    <div class="form-header"><span class="form-name" property="name" data-sym="ST-FUTURE">st-future</span><span class="form-type">macro</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defmacro" data-sym="DEFMACRO">defmacro</a> <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>
  (x)
  `(let ((<a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a> (make-st-future)))
    (setf (st-future-closure <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>) (lambda nil ,X))
    (setf (st-future-valid <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>) nil)
    <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>))</pre>
  </div>

<div class="form-block function" id="def-st-future-read" data-defines="ST-FUTURE-READ" data-references="T,ST-FUTURE-CLOSURE,FUNCALL,MULTIPLE-VALUE-LIST,SETF,PROGN,ST-FUTURE-VALUE,VALUES-LIST,ST-FUTURE-VALID,IF,ST-FUTURE-P,ASSERT,ST-FUTURE,DEFUN" data-used-by="MT-FUTURE-READ" data-part-name="ST-FUTURE-READ" data-part-args="ST-FUTURE" data-part-body="ST-FUTURE,ST-FUTURE-P,ASSERT" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="ST-FUTURE-READ">st-future-read</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-st-future-read" data-sym="ST-FUTURE-READ" title="(defun st-future-read (st-future)
  (assert (st-future-p st-future))
  (if (st-future-valid st-future)
      (values-list (st-future-value st-future))
      (progn
...">st-future-read</a>
  (<a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>)
  (assert (st-future-p <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>))
  (if (st-future-valid <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>)
    (values-list (st-future-value <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>))
    (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf (st-future-value <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>)
        (multiple-value-list (funcall (st-future-closure <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>))))
      (setf (st-future-valid <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
      (values-list (st-future-value <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>)))))</pre>
  </div>

<div class="form-block function" id="def-st-future-abort" data-defines="ST-FUTURE-ABORT" data-references="ST-FUTURE-CLOSURE,T,ST-FUTURE-ABORTED,SETF,ST-FUTURE-P,ASSERT,ST-FUTURE,DEFUN" data-used-by="MT-FUTURE-ABORT" data-part-name="ST-FUTURE-ABORT" data-part-args="ST-FUTURE" data-part-body="ST-FUTURE,ST-FUTURE-P,ASSERT" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="ST-FUTURE-ABORT">st-future-abort</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-st-future-abort" data-sym="ST-FUTURE-ABORT" title="(defun st-future-abort (st-future)
  (assert (st-future-p st-future))
  (setf (st-future-aborted st-future) t)
  (setf (st-future-closure st-future) nil)
  st-future)">st-future-abort</a>
  (<a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>)
  (assert (st-future-p <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>))
  (setf (st-future-aborted <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
  (setf (st-future-closure <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>) nil)
  <a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a>)</pre>
  </div>

<div class="form-block other" id="form-5" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(push <span class="keyword">:skip-resource-availability-test</span> *features*)</pre>
  </div>

<div class="form-block other" id="form-6" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defstruct atomic-notification (<a class="sym-link system" href="axioms.html#def-value" data-sym="VALUE">value</a> nil))</pre>
  </div>

<div class="form-block other" id="form-7" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defstruct barrier
  (<a class="sym-link system" href="axioms.html#def-value" data-sym="VALUE">value</a> nil)
  (lock (make-lock))
  (wait-count <span class="number">0</span>)
  (sem (make-semaphore)))</pre>
  </div>

<div class="form-block function" id="def-broadcast-barrier" data-defines="BROADCAST-BARRIER" data-references="DECF,BARRIER-SEM,SIGNAL-SEMAPHORE,DO,TO,FROM,I,FOR,LOOP,BARRIER-WAIT-COUNT,COUNT,LET,BARRIER-LOCK,WITH-LOCK,T,BARRIER-VALUE,SETF,WITHOUT-INTERRUPTS,BARRIER,DEFUN" data-used-by="EVAL-A-CLOSURE,SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" data-part-name="BROADCAST-BARRIER" data-part-args="BARRIER" data-part-body="DECF,BARRIER-SEM,SIGNAL-SEMAPHORE,DO,TO,FROM,I,FOR,LOOP,BARRIER-WAIT-COUNT,COUNT,LET,BARRIER-LOCK,WITH-LOCK,T,BARRIER,BARRIER-VALUE,SETF,WITHOUT-INTERRUPTS" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="BROADCAST-BARRIER">broadcast-barrier</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-broadcast-barrier" data-sym="BROADCAST-BARRIER" title="(defun broadcast-barrier (barrier)
  (without-interrupts (setf (barrier-value barrier) t)
                      (with-lock (barrier-lock barrier)
                                 (let ((count (barrier-wait-count barrier)))
                                   (loop for i from 0 to
...">broadcast-barrier</a>
  (barrier)
  (without-interrupts (setf (barrier-value barrier) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
    (<a class="sym-link system" href="axioms.html#def-with-lock" data-sym="WITH-LOCK">with-lock</a> (barrier-lock barrier)
      (let ((<a class="sym-link system" href="axioms.html#def-count" data-sym="COUNT">count</a> (barrier-wait-count barrier)))
        (loop for
          i
          from
          <span class="number">0</span>
          to
          <a class="sym-link system" href="axioms.html#def-count" data-sym="COUNT">count</a>
          do
          (signal-semaphore (barrier-sem barrier))
          (decf (barrier-wait-count barrier)))))))</pre>
  </div>

<div class="form-block function" id="def-wait-on-barrier" data-defines="WAIT-ON-BARRIER" data-references="BARRIER-SEM,WAIT-ON-SEMAPHORE,NOT,WHEN,BARRIER-WAIT-COUNT,INCF,BARRIER-LOCK,WITH-LOCK,PROGN,T,BARRIER-VALUE,IF,BARRIER,DEFUN" data-used-by="MT-FUTURE-READ" data-part-name="WAIT-ON-BARRIER" data-part-args="BARRIER" data-part-body="BARRIER-SEM,WAIT-ON-SEMAPHORE,NOT,WHEN,BARRIER-WAIT-COUNT,INCF,BARRIER-LOCK,WITH-LOCK,PROGN,T,BARRIER,BARRIER-VALUE,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="WAIT-ON-BARRIER">wait-on-barrier</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-wait-on-barrier" data-sym="WAIT-ON-BARRIER" title="(defun wait-on-barrier (barrier)
  (if (barrier-value barrier)
      t
      (progn
       (with-lock (barrier-lock barrier) (incf (barrier-wait-count barrier)))
...">wait-on-barrier</a>
  (barrier)
  (if (barrier-value barrier)
    <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>
    (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (<a class="sym-link system" href="axioms.html#def-with-lock" data-sym="WITH-LOCK">with-lock</a> (barrier-lock barrier)
        (incf (barrier-wait-count barrier)))
      (when (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (barrier-value barrier))
        (wait-on-semaphore (barrier-sem barrier))))))</pre>
  </div>

<div class="form-block other" id="form-10" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defstruct <a class="sym-link local-def" href="#def-mt-future" data-sym="MT-FUTURE" title="(defmacro mt-future (x)
  `(cond
    ((not (futures-resources-available))
     (incf *futures-resources-unavailable-count*) (st-future ,x))
    (t (incf *futures-resources-available-count*)
...">mt-future</a>
  (index nil)
  (<a class="sym-link system" href="axioms.html#def-value" data-sym="VALUE">value</a> nil)
  (valid (make-barrier))
  (<a class="sym-link system" href="axioms.html#def-closure" data-sym="CLOSURE">closure</a> nil)
  (aborted nil)
  (thrown-tag nil))</pre>
  </div>

<div class="form-block other" id="form-11" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define-atomically-modifiable-counter *last-slot-saved* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-12" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define-atomically-modifiable-counter *last-slot-taken* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-13" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *future-array*)</pre>
  </div>

<div class="form-block other" id="form-14" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *thread-array*)</pre>
  </div>

<div class="form-block other" id="form-15" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *future-dependencies*)</pre>
  </div>

<div class="form-block other" id="form-16" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defparameter *future-queue-length-history* nil)</pre>
  </div>

<div class="form-block other" id="form-17" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *current-thread-index* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-18" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defconstant *starting-core* 'start)</pre>
  </div>

<div class="form-block other" id="form-19" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defconstant *resumptive-core* 'resumptive)</pre>
  </div>

<div class="form-block other" id="form-20" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *allocated-core* *resumptive-core*)</pre>
  </div>

<div class="form-block other" id="form-21" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *decremented-idle-future-thread-count* nil)</pre>
  </div>

<div class="form-block other" id="form-22" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *idle-future-core-count*
  (make-atomically-modifiable-counter *core-count*))</pre>
  </div>

<div class="form-block other" id="form-23" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *idle-future-resumptive-core-count*
  (make-atomically-modifiable-counter (<a class="sym-link system" href="axioms.html#def-1-" data-sym="1-">1-</a> *core-count*)))</pre>
  </div>

<div class="form-block other" id="form-24" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *idle-core* (make-semaphore))</pre>
  </div>

<div class="form-block other" id="form-25" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define-atomically-modifiable-counter *idle-future-thread-count*
  <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-26" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *future-added* (make-semaphore))</pre>
  </div>

<div class="form-block other" id="form-27" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *idle-resumptive-core* (make-semaphore))</pre>
  </div>

<div class="form-block other" id="form-28" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *threads-spawned* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-29" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define-atomically-modifiable-counter *unassigned-and-active-future-count*
  <span class="number">1</span>)</pre>
  </div>

<div class="form-block other" id="form-30" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define-atomically-modifiable-counter *total-future-count*
  <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-31" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defconstant *future-array-size* <span class="number">200000</span>)</pre>
  </div>

<div class="form-block macro" id="def-faref" data-defines="FAREF" data-references="*FUTURE-ARRAY-SIZE*,1-,MOD,1+,EQUAL,IF,AREF,QUASIQUOTE,SUBSCRIPT,ARRAY,DEFMACRO" data-used-by="PRINT-NON-NILS-IN-ARRAY,ABORT-FUTURE-INDICES,MT-FUTURE-ABORT,ADD-FUTURE-TO-QUEUE,MAKE-FUTURE-WITH-CLOSURE,EVAL-A-CLOSURE,SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL,EARLY-TERMINATE-CHILDREN" typeof="Code">
    <div class="form-header"><span class="form-name" property="name" data-sym="FAREF">faref</span><span class="form-type">macro</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defmacro" data-sym="DEFMACRO">defmacro</a> <a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a>
  (array subscript)
  `(aref ,ARRAY
    (if (equal <span class="number">0</span> ,SUBSCRIPT)
      <span class="number">0</span>
      (<a class="sym-link system" href="axioms.html#def-1_2B" data-sym="1+">1+</a> (mod ,SUBSCRIPT (<a class="sym-link system" href="axioms.html#def-1-" data-sym="1-">1-</a> *future-array-size*))))))</pre>
  </div>

<div class="form-block other" id="form-33" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *resource-and-timing-based-parallelizations*
  <span class="number">0</span>
  <span class="string">"Tracks the number of times that we parallelize execution when
  waterfall-parallelism is set to :resource-and-timing-based"</span>)</pre>
  </div>

<div class="form-block other" id="form-34" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *resource-and-timing-based-serializations*
  <span class="number">0</span>
  <span class="string">"Tracks the number of times that we do not parallelize execution when
  waterfall-parallelism is set to :resource-and-timing-based"</span>)</pre>
  </div>

<div class="form-block other" id="form-35" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *resource-based-parallelizations*
  <span class="number">0</span>
  <span class="string">"Tracks the number of times that we parallelize execution when
  waterfall-parallelism is set to :resource-based"</span>)</pre>
  </div>

<div class="form-block other" id="form-36" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *resource-based-serializations*
  <span class="number">0</span>
  <span class="string">"Tracks the number of times that we do not parallelize execution when
  waterfall-parallelism is set to :resource-based"</span>)</pre>
  </div>

<div class="form-block function" id="def-reset-future-queue-length-history" data-defines="RESET-FUTURE-QUEUE-LENGTH-HISTORY" data-references="*FUTURE-QUEUE-LENGTH-HISTORY*,SETF,DEFUN" data-used-by="RESET-FUTURE-PARALLELISM-VARIABLES" data-part-name="RESET-FUTURE-QUEUE-LENGTH-HISTORY" data-part-body="*FUTURE-QUEUE-LENGTH-HISTORY*,SETF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="RESET-FUTURE-QUEUE-LENGTH-HISTORY">reset-future-queue-length-history</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-reset-future-queue-length-history" data-sym="RESET-FUTURE-QUEUE-LENGTH-HISTORY" title="(defun reset-future-queue-length-history ()
  (setf *future-queue-length-history* nil))">reset-future-queue-length-history</a>
  nil
  (setf *future-queue-length-history* nil))</pre>
  </div>

<div class="form-block function" id="def-reset-future-parallelism-variables" data-defines="RESET-FUTURE-PARALLELISM-VARIABLES" data-references="T,RESET-FUTURE-QUEUE-LENGTH-HISTORY,*RESOURCE-BASED-SERIALIZATIONS*,*RESOURCE-BASED-PARALLELIZATIONS*,*RESOURCE-AND-TIMING-BASED-SERIALIZATIONS*,*RESOURCE-AND-TIMING-BASED-PARALLELIZATIONS*,*IDLE-FUTURE-THREAD-COUNT*,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,*TOTAL-FUTURE-COUNT*,*THREADS-SPAWNED*,*LAST-SLOT-SAVED*,*LAST-SLOT-TAKEN*,SIGNAL-SEMAPHORE,I,DOTIMES,*IDLE-RESUMPTIVE-CORE*,*IDLE-CORE*,1-,*IDLE-FUTURE-RESUMPTIVE-CORE-COUNT*,*CORE-COUNT*,MAKE-ATOMICALLY-MODIFIABLE-COUNTER,*IDLE-FUTURE-CORE-COUNT*,MAKE-SEMAPHORE,*FUTURE-ADDED*,*FUTURE-DEPENDENCIES*,*FUTURE-ARRAY*,*FUTURE-ARRAY-SIZE*,MAKE-ARRAY,*THREAD-ARRAY*,SETF,DEFUN" data-used-by="RESET-ALL-PARALLELISM-VARIABLES" data-part-name="RESET-FUTURE-PARALLELISM-VARIABLES" data-part-body="*FUTURE-ARRAY-SIZE*,MAKE-ARRAY,*THREAD-ARRAY*,SETF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="RESET-FUTURE-PARALLELISM-VARIABLES">reset-future-parallelism-variables</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-reset-future-parallelism-variables" data-sym="RESET-FUTURE-PARALLELISM-VARIABLES" title="(defun reset-future-parallelism-variables ()
  (setf *thread-array* (make-array *future-array-size* :initial-element nil))
  (setf *future-array* (make-array *future-array-size* :initial-element nil))
  (setf *future-dependencies*
          (make-array *future-array-size* :initial-element nil))
...">reset-future-parallelism-variables</a>
  nil
  (setf *thread-array*
    (make-array *future-array-size* <span class="keyword">:initial-element</span> nil))
  (setf *future-array*
    (make-array *future-array-size* <span class="keyword">:initial-element</span> nil))
  (setf *future-dependencies*
    (make-array *future-array-size* <span class="keyword">:initial-element</span> nil))
  (setf *future-added* (make-semaphore))
  (setf *idle-future-core-count*
    (make-atomically-modifiable-counter *core-count*))
  (setf *idle-future-resumptive-core-count*
    (make-atomically-modifiable-counter (<a class="sym-link system" href="axioms.html#def-1-" data-sym="1-">1-</a> *core-count*)))
  (setf *idle-core* (make-semaphore))
  (setf *idle-resumptive-core* (make-semaphore))
  (dotimes (i *core-count*) (signal-semaphore *idle-core*))
  (dotimes (i (<a class="sym-link system" href="axioms.html#def-1-" data-sym="1-">1-</a> *core-count*))
    (signal-semaphore *idle-resumptive-core*))
  (setf *last-slot-taken*
    (make-atomically-modifiable-counter <span class="number">0</span>))
  (setf *last-slot-saved*
    (make-atomically-modifiable-counter <span class="number">0</span>))
  (setf *threads-spawned* <span class="number">0</span>)
  (setf *total-future-count*
    (make-atomically-modifiable-counter <span class="number">0</span>))
  (setf *unassigned-and-active-future-count*
    (make-atomically-modifiable-counter <span class="number">1</span>))
  (setf *idle-future-thread-count*
    (make-atomically-modifiable-counter <span class="number">0</span>))
  (setf *resource-and-timing-based-parallelizations* <span class="number">0</span>)
  (setf *resource-and-timing-based-serializations* <span class="number">0</span>)
  (setf *resource-based-parallelizations* <span class="number">0</span>)
  (setf *resource-based-serializations* <span class="number">0</span>)
  (<a class="sym-link local-def" href="#def-reset-future-queue-length-history" data-sym="RESET-FUTURE-QUEUE-LENGTH-HISTORY" title="(defun reset-future-queue-length-history ()
  (setf *future-queue-length-history* nil))">reset-future-queue-length-history</a>)
  <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)</pre>
  </div>

<div class="form-block other" id="form-39" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(<a class="sym-link local-def" href="#def-reset-future-parallelism-variables" data-sym="RESET-FUTURE-PARALLELISM-VARIABLES" title="(defun reset-future-parallelism-variables ()
  (setf *thread-array* (make-array *future-array-size* :initial-element nil))
  (setf *future-array* (make-array *future-array-size* :initial-element nil))
  (setf *future-dependencies*
          (make-array *future-array-size* :initial-element nil))
...">reset-future-parallelism-variables</a>)</pre>
  </div>

<div class="form-block function" id="def-reset-all-parallelism-variables" data-defines="RESET-ALL-PARALLELISM-VARIABLES" data-references="RESET-FUTURE-PARALLELISM-VARIABLES,RESET-PARALLELISM-VARIABLES,T,FORMAT,DEFUN" data-part-name="RESET-ALL-PARALLELISM-VARIABLES" data-part-body="T,FORMAT" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="RESET-ALL-PARALLELISM-VARIABLES">reset-all-parallelism-variables</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-reset-all-parallelism-variables" data-sym="RESET-ALL-PARALLELISM-VARIABLES" title="(defun reset-all-parallelism-variables ()
  (format t &quot;Resetting parallelism and futures variables.  This may take a ~
             few seconds (often either~% 0 or 15).~%&quot;)
  (reset-parallelism-variables)
  (reset-future-parallelism-variables)">reset-all-parallelism-variables</a>
  nil
  (format <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>
    <span class="string">"Resetting parallelism and futures variables.  This may take a ~
             few seconds (often either~% 0 or 15).~%"</span>)
  (reset-parallelism-variables)
  (<a class="sym-link local-def" href="#def-reset-future-parallelism-variables" data-sym="RESET-FUTURE-PARALLELISM-VARIABLES" title="(defun reset-future-parallelism-variables ()
  (setf *thread-array* (make-array *future-array-size* :initial-element nil))
  (setf *future-array* (make-array *future-array-size* :initial-element nil))
  (setf *future-dependencies*
          (make-array *future-array-size* :initial-element nil))
...">reset-future-parallelism-variables</a>)
  (format <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>
    <span class="string">"Done resetting parallelism and futures variables.~%"</span>))</pre>
  </div>

<div class="form-block function" id="def-futures-parallelism-buffer-has-space-available" data-defines="FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE" data-references="*UNASSIGNED-AND-ACTIVE-WORK-COUNT-LIMIT*,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,<,DEFUN" data-used-by="FUTURES-RESOURCES-AVAILABLE" data-part-name="FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE" data-part-body="*UNASSIGNED-AND-ACTIVE-WORK-COUNT-LIMIT*,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,<" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE">futures-parallelism-buffer-has-space-available</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-futures-parallelism-buffer-has-space-available" data-sym="FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE" title="(defun futures-parallelism-buffer-has-space-available ()
  (&lt; (atomically-modifiable-counter-read *unassigned-and-active-future-count*)
     *unassigned-and-active-work-count-limit*))">futures-parallelism-buffer-has-space-available</a>
  nil
  (&lt; (atomically-modifiable-counter-read *unassigned-and-active-future-count*)
    *unassigned-and-active-work-count-limit*))</pre>
  </div>

<div class="form-block function" id="def-not-too-many-futures-already-in-existence" data-defines="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE" data-references="NULL,HARD,ER,TOTAL-PARALLELISM-WORK-LIMIT-ERROR,*TOTAL-FUTURE-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,<,T,EQUAL,COND,*THE-LIVE-STATE*,QUOTE,F-GET-GLOBAL,TOTAL-PARALLELISM-WORK-LIMIT,LET,DEFUN" data-used-by="FUTURES-RESOURCES-AVAILABLE" data-part-name="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE" data-part-body="NULL,NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE,HARD,ER,TOTAL-PARALLELISM-WORK-LIMIT-ERROR,*TOTAL-FUTURE-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,<,T,EQUAL,COND,*THE-LIVE-STATE*,QUOTE,F-GET-GLOBAL,TOTAL-PARALLELISM-WORK-LIMIT,LET" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE">not-too-many-futures-already-in-existence</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-not-too-many-futures-already-in-existence" data-sym="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE" title="(defun not-too-many-futures-already-in-existence ()
  (let ((total-parallelism-work-limit
         (f-get-global &#39;total-parallelism-work-limit *the-live-state*)))
    (cond ((equal total-parallelism-work-limit :none) t)
          ((&lt; (atomically-modifiable-counter-read *total-future-count*)
...">not-too-many-futures-already-in-existence</a>
  nil
  (let ((total-parallelism-work-limit (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'total-parallelism-work-limit
         *the-live-state*)))
    (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((equal total-parallelism-work-limit <span class="keyword">:none</span>) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
      ((&lt; (atomically-modifiable-counter-read *total-future-count*)
         total-parallelism-work-limit) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
      (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> (let ((total-parallelism-work-limit-error (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'total-parallelism-work-limit-error
               *the-live-state*)))
          (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((equal total-parallelism-work-limit-error <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>) (<a class="sym-link system" href="axioms.html#def-er" data-sym="ER">er</a> hard
                '<a class="sym-link local-def" href="#def-not-too-many-futures-already-in-existence" data-sym="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE" title="(defun not-too-many-futures-already-in-existence ()
  (let ((total-parallelism-work-limit
         (f-get-global &#39;total-parallelism-work-limit *the-live-state*)))
    (cond ((equal total-parallelism-work-limit :none) t)
          ((&lt; (atomically-modifiable-counter-read *total-future-count*)
...">not-too-many-futures-already-in-existence</a>
                <span class="string">"The system has encountered the limit placed upon the ~
                         total amount of parallelism work allowed.  Either ~
                         the limit must be increased, or this error must be ~
                         disabled.  See :DOC set-total-parallelism-work-limit ~
                         and :DOC set-total-parallelism-work-limit-error for ~
                         more information."</span>))
            ((<a class="sym-link system" href="axioms.html#def-null" data-sym="NULL">null</a> total-parallelism-work-limit-error) nil)
            (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link system" href="axioms.html#def-er" data-sym="ER">er</a> hard
                '<a class="sym-link local-def" href="#def-not-too-many-futures-already-in-existence" data-sym="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE" title="(defun not-too-many-futures-already-in-existence ()
  (let ((total-parallelism-work-limit
         (f-get-global &#39;total-parallelism-work-limit *the-live-state*)))
    (cond ((equal total-parallelism-work-limit :none) t)
          ((&lt; (atomically-modifiable-counter-read *total-future-count*)
...">not-too-many-futures-already-in-existence</a>
                <span class="string">"The value for global variable ~
                           total-parallelism-work-limit-error must be one of ~
                           t or nil.  Please change the value of this global ~
                           variable to either of those values."</span>))))))))</pre>
  </div>

<div class="form-block function" id="def-futures-resources-available" data-defines="FUTURES-RESOURCES-AVAILABLE" data-references="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE,FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE,*THE-LIVE-STATE*,PARALLEL-EXECUTION-ENABLED,QUOTE,F-GET-GLOBAL,AND,DEFUN" data-used-by="MT-FUTURE" data-part-name="FUTURES-RESOURCES-AVAILABLE" data-part-body="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE,FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE,*THE-LIVE-STATE*,PARALLEL-EXECUTION-ENABLED,QUOTE,F-GET-GLOBAL,AND" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="FUTURES-RESOURCES-AVAILABLE">futures-resources-available</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-futures-resources-available" data-sym="FUTURES-RESOURCES-AVAILABLE" title="(defun futures-resources-available ()
  (and (f-get-global &#39;parallel-execution-enabled *the-live-state*)
       (futures-parallelism-buffer-has-space-available)
       (not-too-many-futures-already-in-existence)))">futures-resources-available</a>
  nil
  (<a class="sym-link system" href="axioms.html#def-and" data-sym="AND">and</a> (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'parallel-execution-enabled *the-live-state*)
    (<a class="sym-link local-def" href="#def-futures-parallelism-buffer-has-space-available" data-sym="FUTURES-PARALLELISM-BUFFER-HAS-SPACE-AVAILABLE" title="(defun futures-parallelism-buffer-has-space-available ()
  (&lt; (atomically-modifiable-counter-read *unassigned-and-active-future-count*)
     *unassigned-and-active-work-count-limit*))">futures-parallelism-buffer-has-space-available</a>)
    (<a class="sym-link local-def" href="#def-not-too-many-futures-already-in-existence" data-sym="NOT-TOO-MANY-FUTURES-ALREADY-IN-EXISTENCE" title="(defun not-too-many-futures-already-in-existence ()
  (let ((total-parallelism-work-limit
         (f-get-global &#39;total-parallelism-work-limit *the-live-state*)))
    (cond ((equal total-parallelism-work-limit :none) t)
          ((&lt; (atomically-modifiable-counter-read *total-future-count*)
...">not-too-many-futures-already-in-existence</a>)))</pre>
  </div>

<div class="form-block other" id="form-44" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(define-atomically-modifiable-counter *threads-waiting-for-starting-core*
  <span class="number">0</span>)</pre>
  </div>

<div class="form-block function" id="def-claim-starting-core" data-defines="CLAIM-STARTING-CORE" data-references="*IDLE-FUTURE-THREAD-COUNT*,T,*DECREMENTED-IDLE-FUTURE-THREAD-COUNT*,*IDLE-FUTURE-CORE-COUNT*,ATOMIC-DECF,*STARTING-CORE*,*ALLOCATED-CORE*,SETF,SEMAPHORE-NOTIFICATION-STATUS,WHEN,PROGN,*IDLE-CORE*,WAIT-ON-SEMAPHORE,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,MAKE-SEMAPHORE-NOTIFICATION,NOTIFICATION,LET,*THREADS-WAITING-FOR-STARTING-CORE*,ATOMIC-INCF,DEFUN" data-used-by="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" data-part-name="CLAIM-STARTING-CORE" data-part-body="*THREADS-WAITING-FOR-STARTING-CORE*,ATOMIC-INCF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="CLAIM-STARTING-CORE">claim-starting-core</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-claim-starting-core" data-sym="CLAIM-STARTING-CORE" title="(defun claim-starting-core ()
  (atomic-incf *threads-waiting-for-starting-core*)
  (let ((notification (make-semaphore-notification)))
    (unwind-protect-disable-interrupts-during-cleanup
     (wait-on-semaphore *idle-core* :notification notification)
...">claim-starting-core</a>
  nil
  (atomic-incf *threads-waiting-for-starting-core*)
  (let ((notification (make-semaphore-notification)))
    (unwind-protect-disable-interrupts-during-cleanup (wait-on-semaphore *idle-core* <span class="keyword">:notification</span> notification)
      (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (when (semaphore-notification-status notification)
          (setf *allocated-core* *starting-core*)
          (atomic-decf *idle-future-core-count*)
          (setf *decremented-idle-future-thread-count* <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
          (atomic-decf *idle-future-thread-count*))
        (atomic-decf *threads-waiting-for-starting-core*)))))</pre>
  </div>

<div class="form-block function" id="def-claim-resumptive-core" data-defines="CLAIM-RESUMPTIVE-CORE" data-references="*IDLE-FUTURE-RESUMPTIVE-CORE-COUNT*,ATOMIC-DECF,*RESUMPTIVE-CORE*,*ALLOCATED-CORE*,SETF,SEMAPHORE-NOTIFICATION-STATUS,WHEN,*IDLE-RESUMPTIVE-CORE*,WAIT-ON-SEMAPHORE,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,MAKE-SEMAPHORE-NOTIFICATION,NOTIFICATION,LET,DEFUN" data-used-by="MT-FUTURE-READ" data-part-name="CLAIM-RESUMPTIVE-CORE" data-part-body="*IDLE-FUTURE-RESUMPTIVE-CORE-COUNT*,ATOMIC-DECF,*RESUMPTIVE-CORE*,*ALLOCATED-CORE*,SETF,SEMAPHORE-NOTIFICATION-STATUS,WHEN,*IDLE-RESUMPTIVE-CORE*,WAIT-ON-SEMAPHORE,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,MAKE-SEMAPHORE-NOTIFICATION,NOTIFICATION,LET" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="CLAIM-RESUMPTIVE-CORE">claim-resumptive-core</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-claim-resumptive-core" data-sym="CLAIM-RESUMPTIVE-CORE" title="(defun claim-resumptive-core ()
  (let ((notification (make-semaphore-notification)))
    (unwind-protect-disable-interrupts-during-cleanup
     (wait-on-semaphore *idle-resumptive-core* :notification notification)
     (when (semaphore-notification-status notification)
...">claim-resumptive-core</a>
  nil
  (let ((notification (make-semaphore-notification)))
    (unwind-protect-disable-interrupts-during-cleanup (wait-on-semaphore *idle-resumptive-core*
        <span class="keyword">:notification</span> notification)
      (when (semaphore-notification-status notification)
        (setf *allocated-core* *resumptive-core*)
        (atomic-decf *idle-future-resumptive-core-count*)))))</pre>
  </div>

<div class="form-block function" id="def-free-allocated-core" data-defines="FREE-ALLOCATED-CORE" data-references="T,*IDLE-RESUMPTIVE-CORE*,*IDLE-FUTURE-RESUMPTIVE-CORE-COUNT*,*RESUMPTIVE-CORE*,SETF,*IDLE-CORE*,SIGNAL-SEMAPHORE,*IDLE-FUTURE-CORE-COUNT*,ATOMIC-INCF,*STARTING-CORE*,*ALLOCATED-CORE*,EQ,COND,WITHOUT-INTERRUPTS,DEFUN" data-used-by="MT-FUTURE-READ,SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" data-part-name="FREE-ALLOCATED-CORE" data-part-body="T,*IDLE-RESUMPTIVE-CORE*,*IDLE-FUTURE-RESUMPTIVE-CORE-COUNT*,*RESUMPTIVE-CORE*,SETF,*IDLE-CORE*,SIGNAL-SEMAPHORE,*IDLE-FUTURE-CORE-COUNT*,ATOMIC-INCF,*STARTING-CORE*,*ALLOCATED-CORE*,EQ,COND,WITHOUT-INTERRUPTS" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="FREE-ALLOCATED-CORE">free-allocated-core</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-free-allocated-core" data-sym="FREE-ALLOCATED-CORE" title="(defun free-allocated-core ()
  (without-interrupts
   (cond
    ((eq *allocated-core* *starting-core*)
     (atomic-incf *idle-future-core-count*) (signal-semaphore *idle-core*)
...">free-allocated-core</a>
  nil
  (without-interrupts (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="axioms.html#def-eq" data-sym="EQ">eq</a> *allocated-core* *starting-core*) (atomic-incf *idle-future-core-count*)
        (signal-semaphore *idle-core*)
        (setf *allocated-core* nil))
      ((<a class="sym-link system" href="axioms.html#def-eq" data-sym="EQ">eq</a> *allocated-core* *resumptive-core*) (atomic-incf *idle-future-resumptive-core-count*)
        (signal-semaphore *idle-resumptive-core*)
        (setf *allocated-core* nil))
      (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> nil))
    <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>))</pre>
  </div>

<div class="form-block function" id="def-early-terminate-children" data-defines="EARLY-TERMINATE-CHILDREN" data-references="SETF,*FUTURE-DEPENDENCIES*,FAREF,ABORT-FUTURE-INDICES,INDEX,DEFUN" data-used-by="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" data-part-name="EARLY-TERMINATE-CHILDREN" data-part-args="INDEX" data-part-body="INDEX,*FUTURE-DEPENDENCIES*,FAREF,ABORT-FUTURE-INDICES" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="EARLY-TERMINATE-CHILDREN">early-terminate-children</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-early-terminate-children" data-sym="EARLY-TERMINATE-CHILDREN" title="(defun early-terminate-children (index)
  (abort-future-indices (faref *future-dependencies* index))
  (setf (faref *future-dependencies* index) nil))">early-terminate-children</a>
  (index)
  (<a class="sym-link local-def" href="#def-abort-future-indices" data-sym="ABORT-FUTURE-INDICES" title="(defun abort-future-indices (indices)
  (if (endp indices)
      t
      (progn
       (mt-future-abort (faref *future-array* (car indices)))">abort-future-indices</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-dependencies* index))
  (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-dependencies* index) nil))</pre>
  </div>

<div class="form-block other" id="form-49" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *aborted-futures-via-flag* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-50" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *aborted-futures-total* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-51" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *futures-resources-available-count* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-52" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *futures-resources-unavailable-count* <span class="number">0</span>)</pre>
  </div>

<div class="form-block function" id="def-set-thread-check-for-abort-and-funcall" data-defines="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" data-references="*FUTURE-ARRAY*,FREE-ALLOCATED-CORE,*IDLE-FUTURE-THREAD-COUNT*,ATOMIC-INCF,*FUTURE-DEPENDENCIES*,EARLY-TERMINATE-CHILDREN,WHEN,MT-FUTURE-VALID,BROADCAST-BARRIER,SETQ,FUNCALL,MULTIPLE-VALUE-LIST,MT-FUTURE-VALUE,*ABORTED-FUTURES-VIA-FLAG*,INCF,MT-FUTURE-ABORTED,IF,CURRENT-THREAD,*THREAD-ARRAY*,FAREF,SETF,CLAIM-STARTING-CORE,PROGN,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,T,EARLY-TERMINATED,*DECREMENTED-IDLE-FUTURE-THREAD-COUNT*,*CURRENT-THREAD-INDEX*,*ALLOCATED-CORE*,MT-FUTURE-CLOSURE,CLOSURE,MT-FUTURE-INDEX,INDEX,LET*,FUTURE,DEFUN" data-used-by="EVAL-A-CLOSURE" data-part-name="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" data-part-args="FUTURE" data-part-body="*FUTURE-ARRAY*,FREE-ALLOCATED-CORE,*IDLE-FUTURE-THREAD-COUNT*,ATOMIC-INCF,*FUTURE-DEPENDENCIES*,EARLY-TERMINATE-CHILDREN,WHEN,MT-FUTURE-VALID,BROADCAST-BARRIER,SETQ,FUNCALL,MULTIPLE-VALUE-LIST,MT-FUTURE-VALUE,*ABORTED-FUTURES-VIA-FLAG*,INCF,MT-FUTURE-ABORTED,IF,CURRENT-THREAD,*THREAD-ARRAY*,FAREF,SETF,CLAIM-STARTING-CORE,PROGN,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,T,EARLY-TERMINATED,*DECREMENTED-IDLE-FUTURE-THREAD-COUNT*,*CURRENT-THREAD-INDEX*,*ALLOCATED-CORE*,MT-FUTURE-CLOSURE,CLOSURE,FUTURE,MT-FUTURE-INDEX,INDEX,LET*" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL">set-thread-check-for-abort-and-funcall</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-set-thread-check-for-abort-and-funcall" data-sym="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" title="(defun set-thread-check-for-abort-and-funcall (future)
  (let* ((index (mt-future-index future))
         (closure (mt-future-closure future))
         (*allocated-core* nil)
         (*current-thread-index* index)
...">set-thread-check-for-abort-and-funcall</a>
  (<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
  (<a class="sym-link system" href="axioms.html#def-let_2A" data-sym="LET*">let*</a> ((index (mt-future-index <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)) (<a class="sym-link system" href="axioms.html#def-closure" data-sym="CLOSURE">closure</a> (mt-future-closure <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
      (*allocated-core* nil)
      (*current-thread-index* index)
      (*decremented-idle-future-thread-count* nil)
      (early-terminated <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>))
    (unwind-protect-disable-interrupts-during-cleanup (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (<a class="sym-link local-def" href="#def-claim-starting-core" data-sym="CLAIM-STARTING-CORE" title="(defun claim-starting-core ()
  (atomic-incf *threads-waiting-for-starting-core*)
  (let ((notification (make-semaphore-notification)))
    (unwind-protect-disable-interrupts-during-cleanup
     (wait-on-semaphore *idle-core* :notification notification)
...">claim-starting-core</a>)
        (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *thread-array* index) (current-thread))
        (if (mt-future-aborted <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
          (incf *aborted-futures-via-flag*)
          (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf (mt-future-value <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
              (multiple-value-list (funcall <a class="sym-link system" href="axioms.html#def-closure" data-sym="CLOSURE">closure</a>)))
            (setq early-terminated nil)
            (<a class="sym-link local-def" href="#def-broadcast-barrier" data-sym="BROADCAST-BARRIER" title="(defun broadcast-barrier (barrier)
  (without-interrupts (setf (barrier-value barrier) t)
                      (with-lock (barrier-lock barrier)
                                 (let ((count (barrier-wait-count barrier)))
                                   (loop for i from 0 to
...">broadcast-barrier</a> (mt-future-valid <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)))))
      (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *thread-array* index) nil)
        (when early-terminated (<a class="sym-link local-def" href="#def-early-terminate-children" data-sym="EARLY-TERMINATE-CHILDREN" title="(defun early-terminate-children (index)
  (abort-future-indices (faref *future-dependencies* index))
  (setf (faref *future-dependencies* index) nil))">early-terminate-children</a> index))
        (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-dependencies* index) nil)
        (when *decremented-idle-future-thread-count*
          (atomic-incf *idle-future-thread-count*))
        (<a class="sym-link local-def" href="#def-free-allocated-core" data-sym="FREE-ALLOCATED-CORE" title="(defun free-allocated-core ()
  (without-interrupts
   (cond
    ((eq *allocated-core* *starting-core*)
     (atomic-incf *idle-future-core-count*) (signal-semaphore *idle-core*)
...">free-allocated-core</a>)
        (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-array* index) nil)))))</pre>
  </div>

<div class="form-block other" id="form-54" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *throwable-future-worker-thread* nil)</pre>
  </div>

<div class="form-block function" id="def-wait-for-a-closure" data-defines="WAIT-FOR-A-CLOSURE" data-references="THROW,*FUTURE-ADDED*,WAIT-ON-SEMAPHORE,NOT,WHEN,RANDOM,+,RANDOM-AMOUNT-OF-TIME,LET,DO,*LAST-SLOT-SAVED*,*LAST-SLOT-TAKEN*,ATOMICALLY-MODIFIABLE-COUNTER-READ,>=,WHILE,LOOP,DEFUN" data-used-by="EVAL-CLOSURES" data-part-name="WAIT-FOR-A-CLOSURE" data-part-body="THROW,*FUTURE-ADDED*,WAIT-ON-SEMAPHORE,NOT,WHEN,RANDOM,+,RANDOM-AMOUNT-OF-TIME,LET,DO,*LAST-SLOT-SAVED*,*LAST-SLOT-TAKEN*,ATOMICALLY-MODIFIABLE-COUNTER-READ,>=,WHILE,LOOP" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="WAIT-FOR-A-CLOSURE">wait-for-a-closure</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-wait-for-a-closure" data-sym="WAIT-FOR-A-CLOSURE" title="(defun wait-for-a-closure ()
  (loop while (&gt;= (atomically-modifiable-counter-read *last-slot-taken*)
                  (atomically-modifiable-counter-read *last-slot-saved*))
        do (let ((random-amount-of-time (+ 10 (random 110.0))))
             (when
...">wait-for-a-closure</a>
  nil
  (loop while
    (<a class="sym-link system" href="axioms.html#def-_3E_3D" data-sym="&gt;=">&gt;=</a> (atomically-modifiable-counter-read *last-slot-taken*)
      (atomically-modifiable-counter-read *last-slot-saved*))
    do
    (let ((random-amount-of-time (<a class="sym-link system" href="axioms.html#def-_2B" data-sym="+">+</a> <span class="number">10</span> (random <span class="number">110.0</span>))))
      (when (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (wait-on-semaphore *future-added*
            <span class="keyword">:timeout</span> random-amount-of-time))
        (throw <span class="keyword">:worker-thread-no-longer-needed</span> nil)))))</pre>
  </div>

<div class="form-block other" id="form-56" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *busy-wait-var* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-57" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *current-waiting-thread* nil)</pre>
  </div>

<div class="form-block other" id="form-58" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *fresh-waiting-threads* <span class="number">0</span>)</pre>
  </div>

<div class="form-block function" id="def-make-tclet-thrown-symbol1" data-defines="MAKE-TCLET-THROWN-SYMBOL1" data-references="CDR,CAR,SYMBOL-NAME,STRING,QUOTE,CONCATENATE,ENDP,IF,FIRST-TAG,TAGS,DEFUN" data-used-by="MAKE-TCLET-THROWN-SYMBOL" data-part-name="MAKE-TCLET-THROWN-SYMBOL1" data-part-args="FIRST-TAG,TAGS" data-part-body="CDR,MAKE-TCLET-THROWN-SYMBOL1,CAR,SYMBOL-NAME,FIRST-TAG,STRING,QUOTE,CONCATENATE,TAGS,ENDP,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-THROWN-SYMBOL1">make-tclet-thrown-symbol1</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-thrown-symbol1" data-sym="MAKE-TCLET-THROWN-SYMBOL1" title="(defun make-tclet-thrown-symbol1 (tags first-tag)
  (if (endp tags)
      &quot;&quot;
      (concatenate &#39;string
                   (if first-tag
...">make-tclet-thrown-symbol1</a>
  (tags first-tag)
  (if (<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> tags)
    <span class="string">""</span>
    (<a class="sym-link system" href="axioms.html#def-concatenate" data-sym="CONCATENATE">concatenate</a> '<a class="sym-link system" href="axioms.html#def-string" data-sym="STRING">string</a>
      (if first-tag
        <span class="string">""</span>
        <span class="string">"-OR-"</span>)
      (symbol-name (car tags))
      <span class="string">"-THROWN"</span>
      (<a class="sym-link local-def" href="#def-make-tclet-thrown-symbol1" data-sym="MAKE-TCLET-THROWN-SYMBOL1" title="(defun make-tclet-thrown-symbol1 (tags first-tag)
  (if (endp tags)
      &quot;&quot;
      (concatenate &#39;string
                   (if first-tag
...">make-tclet-thrown-symbol1</a> (cdr tags) nil))))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-thrown-symbol" data-defines="MAKE-TCLET-THROWN-SYMBOL" data-references="T,MAKE-TCLET-THROWN-SYMBOL1,INTERN,TAGS,DEFUN" data-used-by="MAKE-TCLET-THROWN-TAGS1,MAKE-TCLET-BINDINGS1" data-part-name="MAKE-TCLET-THROWN-SYMBOL" data-part-args="TAGS" data-part-body="T,TAGS,MAKE-TCLET-THROWN-SYMBOL1,INTERN" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-THROWN-SYMBOL">make-tclet-thrown-symbol</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-thrown-symbol" data-sym="MAKE-TCLET-THROWN-SYMBOL" title="(defun make-tclet-thrown-symbol (tags)
  (intern (make-tclet-thrown-symbol1 tags t) &quot;ACL2&quot;))">make-tclet-thrown-symbol</a>
  (tags)
  (<a class="sym-link system" href="axioms.html#def-intern" data-sym="INTERN">intern</a> (<a class="sym-link local-def" href="#def-make-tclet-thrown-symbol1" data-sym="MAKE-TCLET-THROWN-SYMBOL1" title="(defun make-tclet-thrown-symbol1 (tags first-tag)
  (if (endp tags)
      &quot;&quot;
      (concatenate &#39;string
                   (if first-tag
...">make-tclet-thrown-symbol1</a> tags <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>) <span class="string">"ACL2"</span>))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-bindings1" data-defines="MAKE-TCLET-BINDINGS1" data-references="CDR,T,REVERSE,MAKE-TCLET-THROWN-SYMBOL,LIST,CONS,ENDP,IF,TAGS,DEFUN" data-used-by="MAKE-TCLET-BINDINGS" data-part-name="MAKE-TCLET-BINDINGS1" data-part-args="TAGS" data-part-body="CDR,MAKE-TCLET-BINDINGS1,T,REVERSE,MAKE-TCLET-THROWN-SYMBOL,LIST,CONS,TAGS,ENDP,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-BINDINGS1">make-tclet-bindings1</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-bindings1" data-sym="MAKE-TCLET-BINDINGS1" title="(defun make-tclet-bindings1 (tags)
  (if (endp tags)
      nil
      (cons (list (make-tclet-thrown-symbol (reverse tags)) t)
            (make-tclet-bindings1 (cdr tags)))))">make-tclet-bindings1</a>
  (tags)
  (if (<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> tags)
    nil
    (cons (<a class="sym-link system" href="axioms.html#def-list" data-sym="LIST">list</a> (<a class="sym-link local-def" href="#def-make-tclet-thrown-symbol" data-sym="MAKE-TCLET-THROWN-SYMBOL" title="(defun make-tclet-thrown-symbol (tags)
  (intern (make-tclet-thrown-symbol1 tags t) &quot;ACL2&quot;))">make-tclet-thrown-symbol</a> (<a class="sym-link system" href="axioms.html#def-reverse" data-sym="REVERSE">reverse</a> tags)) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
      (<a class="sym-link local-def" href="#def-make-tclet-bindings1" data-sym="MAKE-TCLET-BINDINGS1" title="(defun make-tclet-bindings1 (tags)
  (if (endp tags)
      nil
      (cons (list (make-tclet-thrown-symbol (reverse tags)) t)
            (make-tclet-bindings1 (cdr tags)))))">make-tclet-bindings1</a> (cdr tags)))))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-bindings" data-defines="MAKE-TCLET-BINDINGS" data-references="MAKE-TCLET-BINDINGS1,REVERSE,TAGS,DEFUN" data-part-name="MAKE-TCLET-BINDINGS" data-part-args="TAGS" data-part-body="TAGS,MAKE-TCLET-BINDINGS1,REVERSE" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-BINDINGS">make-tclet-bindings</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-bindings" data-sym="MAKE-TCLET-BINDINGS" title="(defun make-tclet-bindings (tags)
  (reverse (make-tclet-bindings1 (reverse tags))))">make-tclet-bindings</a>
  (tags)
  (<a class="sym-link system" href="axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (<a class="sym-link local-def" href="#def-make-tclet-bindings1" data-sym="MAKE-TCLET-BINDINGS1" title="(defun make-tclet-bindings1 (tags)
  (if (endp tags)
      nil
      (cons (list (make-tclet-thrown-symbol (reverse tags)) t)
            (make-tclet-bindings1 (cdr tags)))))">make-tclet-bindings1</a> (<a class="sym-link system" href="axioms.html#def-reverse" data-sym="REVERSE">reverse</a> tags))))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-thrown-tags1" data-defines="MAKE-TCLET-THROWN-TAGS1" data-references="CDR,REVERSE,MAKE-TCLET-THROWN-SYMBOL,CONS,ENDP,IF,TAGS,DEFUN" data-used-by="MAKE-TCLET-THROWN-TAGS" data-part-name="MAKE-TCLET-THROWN-TAGS1" data-part-args="TAGS" data-part-body="CDR,MAKE-TCLET-THROWN-TAGS1,REVERSE,MAKE-TCLET-THROWN-SYMBOL,CONS,TAGS,ENDP,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-THROWN-TAGS1">make-tclet-thrown-tags1</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-thrown-tags1" data-sym="MAKE-TCLET-THROWN-TAGS1" title="(defun make-tclet-thrown-tags1 (tags)
  (if (endp tags)
      nil
      (cons (make-tclet-thrown-symbol (reverse tags))
            (make-tclet-thrown-tags1 (cdr tags)))))">make-tclet-thrown-tags1</a>
  (tags)
  (if (<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> tags)
    nil
    (cons (<a class="sym-link local-def" href="#def-make-tclet-thrown-symbol" data-sym="MAKE-TCLET-THROWN-SYMBOL" title="(defun make-tclet-thrown-symbol (tags)
  (intern (make-tclet-thrown-symbol1 tags t) &quot;ACL2&quot;))">make-tclet-thrown-symbol</a> (<a class="sym-link system" href="axioms.html#def-reverse" data-sym="REVERSE">reverse</a> tags))
      (<a class="sym-link local-def" href="#def-make-tclet-thrown-tags1" data-sym="MAKE-TCLET-THROWN-TAGS1" title="(defun make-tclet-thrown-tags1 (tags)
  (if (endp tags)
      nil
      (cons (make-tclet-thrown-symbol (reverse tags))
            (make-tclet-thrown-tags1 (cdr tags)))))">make-tclet-thrown-tags1</a> (cdr tags)))))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-thrown-tags" data-defines="MAKE-TCLET-THROWN-TAGS" data-references="MAKE-TCLET-THROWN-TAGS1,REVERSE,TAGS,DEFUN" data-used-by="THROW-CATCH-LET" data-part-name="MAKE-TCLET-THROWN-TAGS" data-part-args="TAGS" data-part-body="TAGS,MAKE-TCLET-THROWN-TAGS1,REVERSE" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-THROWN-TAGS">make-tclet-thrown-tags</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-thrown-tags" data-sym="MAKE-TCLET-THROWN-TAGS" title="(defun make-tclet-thrown-tags (tags)
  (reverse (make-tclet-thrown-tags1 (reverse tags))))">make-tclet-thrown-tags</a>
  (tags)
  (<a class="sym-link system" href="axioms.html#def-reverse" data-sym="REVERSE">reverse</a> (<a class="sym-link local-def" href="#def-make-tclet-thrown-tags1" data-sym="MAKE-TCLET-THROWN-TAGS1" title="(defun make-tclet-thrown-tags1 (tags)
  (if (endp tags)
      nil
      (cons (make-tclet-thrown-symbol (reverse tags))
            (make-tclet-thrown-tags1 (cdr tags)))))">make-tclet-thrown-tags1</a> (<a class="sym-link system" href="axioms.html#def-reverse" data-sym="REVERSE">reverse</a> tags))))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-catches" data-defines="MAKE-TCLET-CATCHES" data-references="SETQ,QUASIQUOTE,CDR,PROG1,CAR,CATCH,QUOTE,LIST,ENDP,IF,THROWN-TAG-BINDINGS,BODY,RTAGS,DEFUN" data-part-name="MAKE-TCLET-CATCHES" data-part-args="THROWN-TAG-BINDINGS,BODY,RTAGS" data-part-body="SETQ,QUASIQUOTE,THROWN-TAG-BINDINGS,CDR,MAKE-TCLET-CATCHES,PROG1,CAR,CATCH,QUOTE,LIST,BODY,RTAGS,ENDP,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-CATCHES">make-tclet-catches</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-catches" data-sym="MAKE-TCLET-CATCHES" title="(defun make-tclet-catches (rtags body thrown-tag-bindings)
  (if (endp rtags)
      body
      (list &#39;catch (list &#39;quote (car rtags))
            (list &#39;prog1
...">make-tclet-catches</a>
  (rtags <a class="sym-link system" href="basis-b.html#def-body" data-sym="BODY">body</a> thrown-tag-bindings)
  (if (<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> rtags)
    <a class="sym-link system" href="basis-b.html#def-body" data-sym="BODY">body</a>
    (<a class="sym-link system" href="axioms.html#def-list" data-sym="LIST">list</a> 'catch
      (<a class="sym-link system" href="axioms.html#def-list" data-sym="LIST">list</a> 'quote (car rtags))
      (<a class="sym-link system" href="axioms.html#def-list" data-sym="LIST">list</a> 'prog1
        (<a class="sym-link local-def" href="#def-make-tclet-catches" data-sym="MAKE-TCLET-CATCHES" title="(defun make-tclet-catches (rtags body thrown-tag-bindings)
  (if (endp rtags)
      body
      (list &#39;catch (list &#39;quote (car rtags))
            (list &#39;prog1
...">make-tclet-catches</a> (cdr rtags)
          <a class="sym-link system" href="basis-b.html#def-body" data-sym="BODY">body</a>
          (cdr thrown-tag-bindings))
        `(setq ,(CAR THROWN-TAG-BINDINGS) nil)))))</pre>
  </div>

<div class="form-block function" id="def-make-tclet-cleanups" data-defines="MAKE-TCLET-CLEANUPS" data-references="CDR,CAR,LIST,CONS,T,QUOTE,ENDP,IF,CLEANUPS,THROWN-TAGS,DEFUN" data-part-name="MAKE-TCLET-CLEANUPS" data-part-args="CLEANUPS,THROWN-TAGS" data-part-body="CDR,MAKE-TCLET-CLEANUPS,CLEANUPS,CAR,LIST,CONS,T,QUOTE,THROWN-TAGS,ENDP,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-TCLET-CLEANUPS">make-tclet-cleanups</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-tclet-cleanups" data-sym="MAKE-TCLET-CLEANUPS" title="(defun make-tclet-cleanups (thrown-tags cleanups)
  (if (endp thrown-tags)
      &#39;((t nil))
      (cons (list (car thrown-tags) (car cleanups))
            (make-tclet-cleanups (cdr thrown-tags) (cdr cleanups)))))">make-tclet-cleanups</a>
  (thrown-tags cleanups)
  (if (<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> thrown-tags)
    '((<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> nil))
    (cons (<a class="sym-link system" href="axioms.html#def-list" data-sym="LIST">list</a> (car thrown-tags) (car cleanups))
      (<a class="sym-link local-def" href="#def-make-tclet-cleanups" data-sym="MAKE-TCLET-CLEANUPS" title="(defun make-tclet-cleanups (thrown-tags cleanups)
  (if (endp thrown-tags)
      &#39;((t nil))
      (cons (list (car thrown-tags) (car cleanups))
            (make-tclet-cleanups (cdr thrown-tags) (cdr cleanups)))))">make-tclet-cleanups</a> (cdr thrown-tags) (cdr cleanups)))))</pre>
  </div>

<div class="form-block macro" id="def-throw-catch-let" data-defines="THROW-CATCH-LET" data-references="COND,PROG2,TCLET-RESULT,LET,QUASIQUOTE,MAKE-TCLET-THROWN-TAGS,THROWN-TAGS,LET*,CLEANUPS,BODY,TAGS,DEFMACRO" data-used-by="EVAL-A-CLOSURE" typeof="Code">
    <div class="form-header"><span class="form-name" property="name" data-sym="THROW-CATCH-LET">throw-catch-let</span><span class="form-type">macro</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defmacro" data-sym="DEFMACRO">defmacro</a> <a class="sym-link local-def" href="#def-throw-catch-let" data-sym="THROW-CATCH-LET" title="(defmacro throw-catch-let (tags body cleanups)
  (let* ((thrown-tags (make-tclet-thrown-tags tags)))
    `(let ,(make-tclet-bindings tags)
       (let ((tclet-result ,(make-tclet-catches tags body thrown-tags)))
         (prog2 (cond ,@(make-tclet-cleanups thrown-tags cleanups))">throw-catch-let</a>
  (tags <a class="sym-link system" href="basis-b.html#def-body" data-sym="BODY">body</a> cleanups)
  (<a class="sym-link system" href="axioms.html#def-let_2A" data-sym="LET*">let*</a> ((thrown-tags (<a class="sym-link local-def" href="#def-make-tclet-thrown-tags" data-sym="MAKE-TCLET-THROWN-TAGS" title="(defun make-tclet-thrown-tags (tags)
  (reverse (make-tclet-thrown-tags1 (reverse tags))))">make-tclet-thrown-tags</a> tags)))
    `(let ,(MAKE-TCLET-BINDINGS TAGS)
      (let ((tclet-result ,(MAKE-TCLET-CATCHES TAGS BODY THROWN-TAGS)))
        (prog2 (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ,@(MAKE-TCLET-CLEANUPS THROWN-TAGS CLEANUPS))
          tclet-result)))))</pre>
  </div>

<div class="form-block function" id="def-eval-a-closure" data-defines="EVAL-A-CLOSURE" data-references="MT-FUTURE-VALID,BROADCAST-BARRIER,CONS,MT-FUTURE-THROWN-TAG,*TOTAL-FUTURE-COUNT*,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMIC-DECF,TCLET-RESULT,QUOTE,SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL,SETQ,PROGN,T,*THROWABLE-FUTURE-WORKER-THREAD*,LET,CATCH,STEP-LIMIT-TAG,TIME-LIMIT5-TAG,LOCAL-TOP-LEVEL,RAW-EV-FNCALL,THROW-CATCH-LET,*FRESH-WAITING-THREADS*,SETF,*CURRENT-WAITING-THREAD*,CURRENT-THREAD,EQUAL,WHEN,*BUSY-WAIT-VAR*,INCF,DO,*FUTURE-ARRAY*,FAREF,NOT,WHILE,LOOP,FUTURE,THROWN-VAL,THROWN-TAG,*CURRENT-THREAD-INDEX*,*LAST-SLOT-TAKEN*,ATOMIC-INCF,INDEX,LET*,DEFUN" data-used-by="EVAL-CLOSURES" data-part-name="EVAL-A-CLOSURE" data-part-body="MT-FUTURE-VALID,BROADCAST-BARRIER,CONS,MT-FUTURE-THROWN-TAG,*TOTAL-FUTURE-COUNT*,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMIC-DECF,TCLET-RESULT,QUOTE,SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL,SETQ,PROGN,T,*THROWABLE-FUTURE-WORKER-THREAD*,LET,CATCH,STEP-LIMIT-TAG,TIME-LIMIT5-TAG,LOCAL-TOP-LEVEL,RAW-EV-FNCALL,THROW-CATCH-LET,*FRESH-WAITING-THREADS*,SETF,*CURRENT-WAITING-THREAD*,CURRENT-THREAD,EQUAL,WHEN,*BUSY-WAIT-VAR*,INCF,DO,*FUTURE-ARRAY*,FAREF,NOT,WHILE,LOOP,FUTURE,THROWN-VAL,THROWN-TAG,*CURRENT-THREAD-INDEX*,*LAST-SLOT-TAKEN*,ATOMIC-INCF,INDEX,LET*" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="EVAL-A-CLOSURE">eval-a-closure</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-eval-a-closure" data-sym="EVAL-A-CLOSURE" title="(defun eval-a-closure ()
  (let* ((index (atomic-incf *last-slot-taken*))
         (*current-thread-index* index)
         (thrown-tag nil)
         (thrown-val nil)
...">eval-a-closure</a>
  nil
  (<a class="sym-link system" href="axioms.html#def-let_2A" data-sym="LET*">let*</a> ((index (atomic-incf *last-slot-taken*)) (*current-thread-index* index)
      (thrown-tag nil)
      (thrown-val nil)
      (<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a> nil))
    (loop while
      (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-array* index))
      do
      (incf *busy-wait-var*)
      (when (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (equal (current-thread) *current-waiting-thread*))
        (setf *current-waiting-thread* (current-thread))
        (incf *fresh-waiting-threads*)))
    (<a class="sym-link local-def" href="#def-throw-catch-let" data-sym="THROW-CATCH-LET" title="(defmacro throw-catch-let (tags body cleanups)
  (let* ((thrown-tags (make-tclet-thrown-tags tags)))
    `(let ,(make-tclet-bindings tags)
       (let ((tclet-result ,(make-tclet-catches tags body thrown-tags)))
         (prog2 (cond ,@(make-tclet-cleanups thrown-tags cleanups))">throw-catch-let</a> (raw-ev-fncall local-top-level
        time-limit5-tag
        step-limit-tag)
      (catch <span class="keyword">:result-no-longer-needed</span> (let ((*throwable-future-worker-thread* <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>))
          (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setq <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-array* index))
            (<a class="sym-link local-def" href="#def-set-thread-check-for-abort-and-funcall" data-sym="SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" title="(defun set-thread-check-for-abort-and-funcall (future)
  (let* ((index (mt-future-index future))
         (closure (mt-future-closure future))
         (*allocated-core* nil)
         (*current-thread-index* index)
...">set-thread-check-for-abort-and-funcall</a> <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))))
      ((<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf thrown-tag 'raw-ev-fncall)
         (setf thrown-val tclet-result)) (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf thrown-tag 'local-top-level)
          (setf thrown-val tclet-result))
        (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf thrown-tag 'time-limit5-tag)
          (setf thrown-val tclet-result))
        (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (setf thrown-tag 'step-limit-tag)
          (setf thrown-val tclet-result))))
    (atomic-decf *unassigned-and-active-future-count*)
    (atomic-decf *total-future-count*)
    (when thrown-tag
      (setf (mt-future-thrown-tag <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
        (cons thrown-tag thrown-val))
      (<a class="sym-link local-def" href="#def-broadcast-barrier" data-sym="BROADCAST-BARRIER" title="(defun broadcast-barrier (barrier)
  (without-interrupts (setf (barrier-value barrier) t)
                      (with-lock (barrier-lock barrier)
                                 (let ((count (barrier-wait-count barrier)))
                                   (loop for i from 0 to
...">broadcast-barrier</a> (mt-future-valid <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)))))</pre>
  </div>

<div class="form-block function" id="def-eval-closures" data-defines="EVAL-CLOSURES" data-references="*IDLE-FUTURE-THREAD-COUNT*,ATOMIC-DECF,EVAL-A-CLOSURE,WAIT-FOR-A-CLOSURE,LOOP,SPECIAL,DECLARE,*DEFAULT-HS*,T,*THROWABLE-WORKER-THREAD*,LET,CATCH,DEFUN" data-used-by="SPAWN-CLOSURE-CONSUMERS" data-part-name="EVAL-CLOSURES" data-part-body="EVAL-A-CLOSURE,WAIT-FOR-A-CLOSURE,LOOP,SPECIAL,DECLARE,*DEFAULT-HS*,T,*THROWABLE-WORKER-THREAD*,LET,CATCH" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="EVAL-CLOSURES">eval-closures</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-eval-closures" data-sym="EVAL-CLOSURES" title="(defun eval-closures ()
  (catch :worker-thread-no-longer-needed
    (let ((*throwable-worker-thread* t) (*default-hs* nil))
      (declare (special *default-hs*))
      (loop (wait-for-a-closure)
...">eval-closures</a>
  nil
  (catch <span class="keyword">:worker-thread-no-longer-needed</span> (let ((*throwable-worker-thread* <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>) (*default-hs* nil))
      (declare (special *default-hs*))
      (loop (<a class="sym-link local-def" href="#def-wait-for-a-closure" data-sym="WAIT-FOR-A-CLOSURE" title="(defun wait-for-a-closure ()
  (loop while (&gt;= (atomically-modifiable-counter-read *last-slot-taken*)
                  (atomically-modifiable-counter-read *last-slot-saved*))
        do (let ((random-amount-of-time (+ 10 (random 110.0))))
             (when
...">wait-for-a-closure</a>)
        (<a class="sym-link local-def" href="#def-eval-a-closure" data-sym="EVAL-A-CLOSURE" title="(defun eval-a-closure ()
  (let* ((index (atomic-incf *last-slot-taken*))
         (*current-thread-index* index)
         (thrown-tag nil)
         (thrown-val nil)
...">eval-a-closure</a>))))
  (atomic-decf *idle-future-thread-count*))</pre>
  </div>

<div class="form-block function" id="def-number-of-idle-threads-and-threads-waiting-for-a-starting-core" data-defines="NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE" data-references="*THREADS-WAITING-FOR-STARTING-CORE*,*IDLE-FUTURE-THREAD-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,+,DEFUN" data-used-by="SPAWN-CLOSURE-CONSUMERS" data-part-name="NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE" data-part-body="*THREADS-WAITING-FOR-STARTING-CORE*,*IDLE-FUTURE-THREAD-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,+" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE">number-of-idle-threads-and-threads-waiting-for-a-starting-core</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-number-of-idle-threads-and-threads-waiting-for-a-starting-core" data-sym="NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE" title="(defun number-of-idle-threads-and-threads-waiting-for-a-starting-core ()
  (+ (atomically-modifiable-counter-read *idle-future-thread-count*)
     (atomically-modifiable-counter-read *threads-waiting-for-starting-core*)))">number-of-idle-threads-and-threads-waiting-for-a-starting-core</a>
  nil
  (<a class="sym-link system" href="axioms.html#def-_2B" data-sym="+">+</a> (atomically-modifiable-counter-read *idle-future-thread-count*)
    (atomically-modifiable-counter-read *threads-waiting-for-starting-core*)))</pre>
  </div>

<div class="form-block function" id="def-spawn-closure-consumers" data-defines="SPAWN-CLOSURE-CONSUMERS" data-references="EVAL-CLOSURES,QUOTE,RUN-THREAD,*THREADS-SPAWNED*,INCF,*IDLE-FUTURE-THREAD-COUNT*,ATOMIC-INCF,PROGN,DO,*MAX-IDLE-THREAD-COUNT*,NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE,<,WHILE,LOOP,WITHOUT-INTERRUPTS,DEFUN" data-used-by="ADD-FUTURE-TO-QUEUE" data-part-name="SPAWN-CLOSURE-CONSUMERS" data-part-body="EVAL-CLOSURES,QUOTE,RUN-THREAD,*THREADS-SPAWNED*,INCF,*IDLE-FUTURE-THREAD-COUNT*,ATOMIC-INCF,PROGN,DO,*MAX-IDLE-THREAD-COUNT*,NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE,<,WHILE,LOOP,WITHOUT-INTERRUPTS" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="SPAWN-CLOSURE-CONSUMERS">spawn-closure-consumers</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-spawn-closure-consumers" data-sym="SPAWN-CLOSURE-CONSUMERS" title="(defun spawn-closure-consumers ()
  (without-interrupts
   (loop while (&lt;
                (number-of-idle-threads-and-threads-waiting-for-a-starting-core)
                *max-idle-thread-count*)
...">spawn-closure-consumers</a>
  nil
  (without-interrupts (loop while
      (&lt; (<a class="sym-link local-def" href="#def-number-of-idle-threads-and-threads-waiting-for-a-starting-core" data-sym="NUMBER-OF-IDLE-THREADS-AND-THREADS-WAITING-FOR-A-STARTING-CORE" title="(defun number-of-idle-threads-and-threads-waiting-for-a-starting-core ()
  (+ (atomically-modifiable-counter-read *idle-future-thread-count*)
     (atomically-modifiable-counter-read *threads-waiting-for-starting-core*)))">number-of-idle-threads-and-threads-waiting-for-a-starting-core</a>)
        *max-idle-thread-count*)
      do
      (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (atomic-incf *idle-future-thread-count*)
        (incf *threads-spawned*)
        (run-thread <span class="string">"Worker thread"</span> '<a class="sym-link local-def" href="#def-eval-closures" data-sym="EVAL-CLOSURES" title="(defun eval-closures ()
  (catch :worker-thread-no-longer-needed
    (let ((*throwable-worker-thread* t) (*default-hs* nil))
      (declare (special *default-hs*))
      (loop (wait-for-a-closure)
...">eval-closures</a>)))))</pre>
  </div>

<div class="form-block function" id="def-make-future-with-closure" data-defines="MAKE-FUTURE-WITH-CLOSURE" data-references="MT-FUTURE-CLOSURE,CONS,*CURRENT-THREAD-INDEX*,MT-FUTURE-INDEX,SETF,*FUTURE-DEPENDENCIES*,*FUTURE-ARRAY*,*THREAD-ARRAY*,FAREF,NOT,ASSERT,*LAST-SLOT-SAVED*,ATOMIC-INCF,INDEX,MAKE-MT-FUTURE,FUTURE,LET,CLOSURE,DEFUN" data-used-by="MT-FUTURE" data-part-name="MAKE-FUTURE-WITH-CLOSURE" data-part-args="CLOSURE" data-part-body="CLOSURE,MT-FUTURE-CLOSURE,CONS,*CURRENT-THREAD-INDEX*,MT-FUTURE-INDEX,SETF,*FUTURE-DEPENDENCIES*,*FUTURE-ARRAY*,*THREAD-ARRAY*,FAREF,NOT,ASSERT,*LAST-SLOT-SAVED*,ATOMIC-INCF,INDEX,MAKE-MT-FUTURE,FUTURE,LET" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-FUTURE-WITH-CLOSURE">make-future-with-closure</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-future-with-closure" data-sym="MAKE-FUTURE-WITH-CLOSURE" title="(defun make-future-with-closure (closure)
  (let ((future (make-mt-future)) (index (atomic-incf *last-slot-saved*)))
    (assert (not (faref *thread-array* index)))
    (assert (not (faref *future-array* index)))
    (assert (not (faref *future-dependencies* index)))
...">make-future-with-closure</a>
  (<a class="sym-link system" href="axioms.html#def-closure" data-sym="CLOSURE">closure</a>)
  (let ((<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a> (make-mt-future)) (index (atomic-incf *last-slot-saved*)))
    (assert (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *thread-array* index)))
    (assert (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-array* index)))
    (assert (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-dependencies* index)))
    (setf (mt-future-index <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) index)
    (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-dependencies* *current-thread-index*)
      (cons index
        (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-dependencies* *current-thread-index*)))
    (setf (mt-future-closure <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) <a class="sym-link system" href="axioms.html#def-closure" data-sym="CLOSURE">closure</a>)
    <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))</pre>
  </div>

<div class="form-block function" id="def-add-future-to-queue" data-defines="ADD-FUTURE-TO-QUEUE" data-references="*FUTURE-ADDED*,SIGNAL-SEMAPHORE,SPAWN-CLOSURE-CONSUMERS,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,*TOTAL-FUTURE-COUNT*,ATOMIC-INCF,MT-FUTURE-INDEX,*FUTURE-ARRAY*,FAREF,SETF,FUTURE,DEFUN" data-used-by="MT-FUTURE" data-part-name="ADD-FUTURE-TO-QUEUE" data-part-args="FUTURE" data-part-body="FUTURE,MT-FUTURE-INDEX,*FUTURE-ARRAY*,FAREF,SETF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="ADD-FUTURE-TO-QUEUE">add-future-to-queue</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-add-future-to-queue" data-sym="ADD-FUTURE-TO-QUEUE" title="(defun add-future-to-queue (future)
  (setf (faref *future-array* (mt-future-index future)) future)
  (atomic-incf *total-future-count*)
  (atomic-incf *unassigned-and-active-future-count*)
  (spawn-closure-consumers)
...">add-future-to-queue</a>
  (<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
  (setf (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-array* (mt-future-index <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
    <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
  (atomic-incf *total-future-count*)
  (atomic-incf *unassigned-and-active-future-count*)
  (<a class="sym-link local-def" href="#def-spawn-closure-consumers" data-sym="SPAWN-CLOSURE-CONSUMERS" title="(defun spawn-closure-consumers ()
  (without-interrupts
   (loop while (&lt;
                (number-of-idle-threads-and-threads-waiting-for-a-starting-core)
                *max-idle-thread-count*)
...">spawn-closure-consumers</a>)
  (signal-semaphore *future-added*)
  <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)</pre>
  </div>

<div class="form-block function" id="def-make-closure-expr-with-acl2-bindings" data-defines="MAKE-CLOSURE-EXPR-WITH-ACL2-BINDINGS" data-references="STATE-FREE-GLOBAL-LET*,LAMBDA,GUARD-CHECKING-ON,SAFE-MODE,*WORMHOLEP*,*ACL2-UNWIND-PROTECT-STACK*,ACL2-UNWIND-PROTECT-STACK,*THE-LIVE-STATE*,LD-LEVEL,QUOTE,F-GET-GLOBAL,EQUAL,ASSERT$,*LD-LEVEL*,LET*,QUASIQUOTE,LOCAL-GC-ON-SYM,LOCAL-SAFE-MODE-SYM,WORMHOLEP-SYM,LD-LEVEL-STATE-SYM,GENSYM,LD-LEVEL-SYM,LET,BODY,DEFUN" data-part-name="MAKE-CLOSURE-EXPR-WITH-ACL2-BINDINGS" data-part-args="BODY" data-part-body="STATE-FREE-GLOBAL-LET*,LAMBDA,GUARD-CHECKING-ON,SAFE-MODE,*WORMHOLEP*,*ACL2-UNWIND-PROTECT-STACK*,ACL2-UNWIND-PROTECT-STACK,*THE-LIVE-STATE*,LD-LEVEL,QUOTE,F-GET-GLOBAL,EQUAL,ASSERT$,*LD-LEVEL*,LET*,QUASIQUOTE,LOCAL-GC-ON-SYM,LOCAL-SAFE-MODE-SYM,WORMHOLEP-SYM,LD-LEVEL-STATE-SYM,GENSYM,LD-LEVEL-SYM,LET" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MAKE-CLOSURE-EXPR-WITH-ACL2-BINDINGS">make-closure-expr-with-acl2-bindings</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-make-closure-expr-with-acl2-bindings" data-sym="MAKE-CLOSURE-EXPR-WITH-ACL2-BINDINGS" title="(defun make-closure-expr-with-acl2-bindings (body)
  (let ((ld-level-sym (gensym))
        (ld-level-state-sym (gensym))
        (wormholep-sym (gensym))
        (local-safe-mode-sym (gensym))
...">make-closure-expr-with-acl2-bindings</a>
  (<a class="sym-link system" href="basis-b.html#def-body" data-sym="BODY">body</a>)
  (let ((ld-level-sym (gensym)) (ld-level-state-sym (gensym))
      (wormholep-sym (gensym))
      (local-safe-mode-sym (gensym))
      (local-gc-on-sym (gensym)))
    `(<a class="sym-link system" href="axioms.html#def-let_2A" data-sym="LET*">let*</a> ((,LD-LEVEL-SYM *ld-level*) (,LD-LEVEL-STATE-SYM (<a class="sym-link system" href="axioms.html#def-assert_24" data-sym="ASSERT$">assert$</a> (equal *ld-level* (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'ld-level *the-live-state*))
            (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'ld-level *the-live-state*)))
        (acl2-unwind-protect-stack *acl2-unwind-protect-stack*)
        (,WORMHOLEP-SYM *wormholep*)
        (,LOCAL-SAFE-MODE-SYM (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'safe-mode *the-live-state*))
        (,LOCAL-GC-ON-SYM (<a class="sym-link system" href="axioms.html#def-f-get-global" data-sym="F-GET-GLOBAL">f-get-global</a> 'guard-checking-on *the-live-state*)))
      (lambda nil
        (let ((*ld-level* ,LD-LEVEL-SYM) (*acl2-unwind-protect-stack* acl2-unwind-protect-stack)
            (*wormholep* ,WORMHOLEP-SYM))
          (state-free-global-let* ((ld-level ,LD-LEVEL-STATE-SYM) (safe-mode ,LOCAL-SAFE-MODE-SYM)
              (guard-checking-on ,LOCAL-GC-ON-SYM))
            ,BODY))))))</pre>
  </div>

<div class="form-block macro" id="def-mt-future" data-defines="MT-FUTURE" data-references="ADD-FUTURE-TO-QUEUE,MAKE-FUTURE-WITH-CLOSURE,FUTURE,LET,WITHOUT-INTERRUPTS,*FUTURES-RESOURCES-AVAILABLE-COUNT*,T,ST-FUTURE,*FUTURES-RESOURCES-UNAVAILABLE-COUNT*,INCF,FUTURES-RESOURCES-AVAILABLE,NOT,COND,QUASIQUOTE,X,DEFMACRO" data-used-by="FUTURE" typeof="Code">
    <div class="form-header"><span class="form-name" property="name" data-sym="MT-FUTURE">mt-future</span><span class="form-type">macro</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defmacro" data-sym="DEFMACRO">defmacro</a> <a class="sym-link local-def" href="#def-mt-future" data-sym="MT-FUTURE" title="(defmacro mt-future (x)
  `(cond
    ((not (futures-resources-available))
     (incf *futures-resources-unavailable-count*) (st-future ,x))
    (t (incf *futures-resources-available-count*)
...">mt-future</a>
  (x)
  `(<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (<a class="sym-link local-def" href="#def-futures-resources-available" data-sym="FUTURES-RESOURCES-AVAILABLE" title="(defun futures-resources-available ()
  (and (f-get-global &#39;parallel-execution-enabled *the-live-state*)
       (futures-parallelism-buffer-has-space-available)
       (not-too-many-futures-already-in-existence)))">futures-resources-available</a>)) (incf *futures-resources-unavailable-count*)
      (<a class="sym-link local-def" href="#def-st-future" data-sym="ST-FUTURE" title="(defmacro st-future (x)
  `(let ((st-future (make-st-future)))
     (setf (st-future-closure st-future) (lambda () ,x))
     (setf (st-future-valid st-future) nil)
     st-future))">st-future</a> ,X))
    (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> (incf *futures-resources-available-count*)
      (without-interrupts (let ((<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a> (<a class="sym-link local-def" href="#def-make-future-with-closure" data-sym="MAKE-FUTURE-WITH-CLOSURE" title="(defun make-future-with-closure (closure)
  (let ((future (make-mt-future)) (index (atomic-incf *last-slot-saved*)))
    (assert (not (faref *thread-array* index)))
    (assert (not (faref *future-array* index)))
    (assert (not (faref *future-dependencies* index)))
...">make-future-with-closure</a> ,(MAKE-CLOSURE-EXPR-WITH-ACL2-BINDINGS X))))
          (without-interrupts (<a class="sym-link local-def" href="#def-add-future-to-queue" data-sym="ADD-FUTURE-TO-QUEUE" title="(defun add-future-to-queue (future)
  (setf (faref *future-array* (mt-future-index future)) future)
  (atomic-incf *total-future-count*)
  (atomic-incf *unassigned-and-active-future-count*)
  (spawn-closure-consumers)
...">add-future-to-queue</a> <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
          <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)))))</pre>
  </div>

<div class="form-block function" id="def-mt-future-read" data-defines="MT-FUTURE-READ" data-references="ERROR,MT-FUTURE-VALUE,VALUES-LIST,CDR,CAR,THROW,MT-FUTURE-THROWN-TAG,ATOMIC-INCF,CLAIM-RESUMPTIVE-CORE,WAIT-ON-BARRIER,T,SETQ,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMIC-DECF,FREE-ALLOCATED-CORE,WITHOUT-INTERRUPTS,PROGN,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,NOTIF,LET,MT-FUTURE-VALID,BARRIER-VALUE,NOT,WHEN,MT-FUTURE-P,ST-FUTURE-READ,ST-FUTURE-P,COND,FUTURE,DEFUN" data-used-by="FUTURE-READ" data-part-name="MT-FUTURE-READ" data-part-args="FUTURE" data-part-body="ERROR,MT-FUTURE-VALUE,VALUES-LIST,CDR,CAR,THROW,MT-FUTURE-THROWN-TAG,ATOMIC-INCF,CLAIM-RESUMPTIVE-CORE,WAIT-ON-BARRIER,T,SETQ,*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMIC-DECF,FREE-ALLOCATED-CORE,WITHOUT-INTERRUPTS,PROGN,UNWIND-PROTECT-DISABLE-INTERRUPTS-DURING-CLEANUP,NOTIF,LET,MT-FUTURE-VALID,BARRIER-VALUE,NOT,WHEN,MT-FUTURE-P,ST-FUTURE-READ,FUTURE,ST-FUTURE-P,COND" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MT-FUTURE-READ">mt-future-read</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-mt-future-read" data-sym="MT-FUTURE-READ" title="(defun mt-future-read (future)
  (cond ((st-future-p future) (st-future-read future))
        ((mt-future-p future)
         (when (not (barrier-value (mt-future-valid future)))
           (let ((notif nil))
...">mt-future-read</a>
  (<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
  (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((st-future-p <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) (<a class="sym-link local-def" href="#def-st-future-read" data-sym="ST-FUTURE-READ" title="(defun st-future-read (st-future)
  (assert (st-future-p st-future))
  (if (st-future-valid st-future)
      (values-list (st-future-value st-future))
      (progn
...">st-future-read</a> <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
    ((mt-future-p <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) (when (<a class="sym-link system" href="axioms.html#def-not" data-sym="NOT">not</a> (barrier-value (mt-future-valid <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)))
        (let ((notif nil))
          (unwind-protect-disable-interrupts-during-cleanup (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (without-interrupts (<a class="sym-link local-def" href="#def-free-allocated-core" data-sym="FREE-ALLOCATED-CORE" title="(defun free-allocated-core ()
  (without-interrupts
   (cond
    ((eq *allocated-core* *starting-core*)
     (atomic-incf *idle-future-core-count*) (signal-semaphore *idle-core*)
...">free-allocated-core</a>)
                (atomic-decf *unassigned-and-active-future-count*)
                (setq notif <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>))
              (<a class="sym-link local-def" href="#def-wait-on-barrier" data-sym="WAIT-ON-BARRIER" title="(defun wait-on-barrier (barrier)
  (if (barrier-value barrier)
      t
      (progn
       (with-lock (barrier-lock barrier) (incf (barrier-wait-count barrier)))
...">wait-on-barrier</a> (mt-future-valid <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
              (<a class="sym-link local-def" href="#def-claim-resumptive-core" data-sym="CLAIM-RESUMPTIVE-CORE" title="(defun claim-resumptive-core ()
  (let ((notification (make-semaphore-notification)))
    (unwind-protect-disable-interrupts-during-cleanup
     (wait-on-semaphore *idle-resumptive-core* :notification notification)
     (when (semaphore-notification-status notification)
...">claim-resumptive-core</a>))
            (when notif
              (atomic-incf *unassigned-and-active-future-count*)))))
      (when (mt-future-thrown-tag <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
        (throw (car (mt-future-thrown-tag <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
          (cdr (mt-future-thrown-tag <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))))
      (values-list (mt-future-value <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)))
    (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> (error <span class="string">"future-read was given a non-future argument"</span>))))</pre>
  </div>

<div class="form-block other" id="form-77" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *aborted-futures-via-throw* <span class="number">0</span>)</pre>
  </div>

<div class="form-block other" id="form-78" typeof="Code">
    <div class="form-header"><span class="form-type">other</span></div>
    <pre class="code" property="text">(defvar *almost-aborted-future-count* <span class="number">0</span>)</pre>
  </div>

<div class="form-block function" id="def-mt-future-abort" data-defines="MT-FUTURE-ABORT" data-references="ERROR,NULL,*ALMOST-ABORTED-FUTURE-COUNT*,THROW,*ABORTED-FUTURES-VIA-THROW*,*THROWABLE-FUTURE-WORKER-THREAD*,*CURRENT-THREAD-INDEX*,EQUAL,IF,LAMBDA,INTERRUPT-THREAD,WHEN,*THREAD-ARRAY*,FAREF,THREAD,T,MT-FUTURE-ABORTED,SETF,ASSERT,MT-FUTURE-INDEX,INDEX,LET,WITHOUT-INTERRUPTS,MT-FUTURE-P,ST-FUTURE-ABORT,ST-FUTURE-P,COND,*ABORTED-FUTURES-TOTAL*,INCF,FUTURE,DEFUN" data-used-by="FUTURE-ABORT,ABORT-FUTURE-INDICES" data-part-name="MT-FUTURE-ABORT" data-part-args="FUTURE" data-part-body="*ABORTED-FUTURES-TOTAL*,INCF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="MT-FUTURE-ABORT">mt-future-abort</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-mt-future-abort" data-sym="MT-FUTURE-ABORT" title="(defun mt-future-abort (future)
  (incf *aborted-futures-total*)
  (cond ((st-future-p future) (st-future-abort future))
        ((mt-future-p future)
         (without-interrupts
...">mt-future-abort</a>
  (<a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)
  (incf *aborted-futures-total*)
  (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((st-future-p <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) (<a class="sym-link local-def" href="#def-st-future-abort" data-sym="ST-FUTURE-ABORT" title="(defun st-future-abort (st-future)
  (assert (st-future-p st-future))
  (setf (st-future-aborted st-future) t)
  (setf (st-future-closure st-future) nil)
  st-future)">st-future-abort</a> <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>))
    ((mt-future-p <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) (without-interrupts (let ((index (mt-future-index <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)))
          (assert index)
          (setf (mt-future-aborted <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
          (let ((thread (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *thread-array* index)))
            (when thread
              (interrupt-thread thread
                (lambda nil
                  (if (equal (mt-future-index <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) *current-thread-index*)
                    (when *throwable-future-worker-thread*
                      (incf *aborted-futures-via-throw*)
                      (throw <span class="keyword">:result-no-longer-needed</span> nil))
                    (incf *almost-aborted-future-count*)))))))))
    ((<a class="sym-link system" href="axioms.html#def-null" data-sym="NULL">null</a> <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
    (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> (error <span class="string">"future-abort was given a non-future argument"</span>)))
  <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a>)</pre>
  </div>

<div class="form-block function" id="def-abort-future-indices" data-defines="ABORT-FUTURE-INDICES" data-references="CDR,CAR,*FUTURE-ARRAY*,FAREF,MT-FUTURE-ABORT,PROGN,T,ENDP,IF,INDICES,DEFUN" data-used-by="EARLY-TERMINATE-CHILDREN" data-part-name="ABORT-FUTURE-INDICES" data-part-args="INDICES" data-part-body="CDR,ABORT-FUTURE-INDICES,CAR,*FUTURE-ARRAY*,FAREF,MT-FUTURE-ABORT,PROGN,T,INDICES,ENDP,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="ABORT-FUTURE-INDICES">abort-future-indices</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-abort-future-indices" data-sym="ABORT-FUTURE-INDICES" title="(defun abort-future-indices (indices)
  (if (endp indices)
      t
      (progn
       (mt-future-abort (faref *future-array* (car indices)))">abort-future-indices</a>
  (indices)
  (if (<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> indices)
    <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>
    (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (<a class="sym-link local-def" href="#def-mt-future-abort" data-sym="MT-FUTURE-ABORT" title="(defun mt-future-abort (future)
  (incf *aborted-futures-total*)
  (cond ((st-future-p future) (st-future-abort future))
        ((mt-future-p future)
         (without-interrupts
...">mt-future-abort</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> *future-array* (car indices)))
      (<a class="sym-link local-def" href="#def-abort-future-indices" data-sym="ABORT-FUTURE-INDICES" title="(defun abort-future-indices (indices)
  (if (endp indices)
      t
      (progn
       (mt-future-abort (faref *future-array* (car indices)))">abort-future-indices</a> (cdr indices)))))</pre>
  </div>

<div class="form-block function" id="def-print-non-nils-in-array" data-defines="PRINT-NON-NILS-IN-ARRAY" data-references="PRINT,PROGN,1+,FAREF,NULL,LENGTH,EQUAL,IF,N,ARRAY,DEFUN" data-part-name="PRINT-NON-NILS-IN-ARRAY" data-part-args="N,ARRAY" data-part-body="PRINT,PROGN,1+,PRINT-NON-NILS-IN-ARRAY,FAREF,NULL,ARRAY,LENGTH,N,EQUAL,IF" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="PRINT-NON-NILS-IN-ARRAY">print-non-nils-in-array</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-print-non-nils-in-array" data-sym="PRINT-NON-NILS-IN-ARRAY" title="(defun print-non-nils-in-array (array n)
  (if (equal n (length array))
      &quot;end&quot;
      (if (null (faref array n))
          (print-non-nils-in-array array (1+ n))
...">print-non-nils-in-array</a>
  (array n)
  (if (equal n (<a class="sym-link system" href="axioms.html#def-length" data-sym="LENGTH">length</a> array))
    <span class="string">"end"</span>
    (if (<a class="sym-link system" href="axioms.html#def-null" data-sym="NULL">null</a> (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> array n))
      (<a class="sym-link local-def" href="#def-print-non-nils-in-array" data-sym="PRINT-NON-NILS-IN-ARRAY" title="(defun print-non-nils-in-array (array n)
  (if (equal n (length array))
      &quot;end&quot;
      (if (null (faref array n))
          (print-non-nils-in-array array (1+ n))
...">print-non-nils-in-array</a> array (<a class="sym-link system" href="axioms.html#def-1_2B" data-sym="1+">1+</a> n))
      (<a class="sym-link system" href="axioms.html#def-progn" data-sym="PROGN">progn</a> (print n)
        (print (<a class="sym-link local-def" href="#def-faref" data-sym="FAREF" title="(defmacro faref (array subscript)
  `(aref ,array
         (if (equal 0 ,subscript)
             0
             (1+ (mod ,subscript (1- *future-array-size*))))))">faref</a> array n))
        (<a class="sym-link local-def" href="#def-print-non-nils-in-array" data-sym="PRINT-NON-NILS-IN-ARRAY" title="(defun print-non-nils-in-array (array n)
  (if (equal n (length array))
      &quot;end&quot;
      (if (null (faref array n))
          (print-non-nils-in-array array (1+ n))
...">print-non-nils-in-array</a> array (<a class="sym-link system" href="axioms.html#def-1_2B" data-sym="1+">1+</a> n))))))</pre>
  </div>

<div class="form-block function" id="def-futures-still-in-flight" data-defines="FUTURES-STILL-IN-FLIGHT" data-references="*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,<,DEFUN" data-part-name="FUTURES-STILL-IN-FLIGHT" data-part-body="*UNASSIGNED-AND-ACTIVE-FUTURE-COUNT*,ATOMICALLY-MODIFIABLE-COUNTER-READ,<" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="FUTURES-STILL-IN-FLIGHT">futures-still-in-flight</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-futures-still-in-flight" data-sym="FUTURES-STILL-IN-FLIGHT" title="(defun futures-still-in-flight ()
  (&lt; 1
     (atomically-modifiable-counter-read *unassigned-and-active-future-count*)))">futures-still-in-flight</a>
  nil
  (&lt; <span class="number">1</span>
    (atomically-modifiable-counter-read *unassigned-and-active-future-count*)))</pre>
  </div>

<div class="form-block macro" id="def-future" data-defines="FUTURE" data-references="MT-FUTURE,QUASIQUOTE,X,DEFMACRO" data-used-by="MT-FUTURE-ABORT,MT-FUTURE-READ,MT-FUTURE,ADD-FUTURE-TO-QUEUE,MAKE-FUTURE-WITH-CLOSURE,EVAL-A-CLOSURE,SET-THREAD-CHECK-FOR-ABORT-AND-FUNCALL" typeof="Code">
    <div class="form-header"><span class="form-name" property="name" data-sym="FUTURE">future</span><span class="form-type">macro</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defmacro" data-sym="DEFMACRO">defmacro</a> <a class="sym-link local-def" href="#def-future" data-sym="FUTURE" title="(defmacro future (x) `(mt-future ,x))">future</a> (x) `(<a class="sym-link local-def" href="#def-mt-future" data-sym="MT-FUTURE" title="(defmacro mt-future (x)
  `(cond
    ((not (futures-resources-available))
     (incf *futures-resources-unavailable-count*) (st-future ,x))
    (t (incf *futures-resources-available-count*)
...">mt-future</a> ,X))</pre>
  </div>

<div class="form-block function" id="def-future-read" data-defines="FUTURE-READ" data-references="MT-FUTURE-READ,X,DEFUN" data-part-name="FUTURE-READ" data-part-args="X" data-part-body="X,MT-FUTURE-READ" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="FUTURE-READ">future-read</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-future-read" data-sym="FUTURE-READ" title="(defun future-read (x) (mt-future-read x))">future-read</a> (x) (<a class="sym-link local-def" href="#def-mt-future-read" data-sym="MT-FUTURE-READ" title="(defun mt-future-read (future)
  (cond ((st-future-p future) (st-future-read future))
        ((mt-future-p future)
         (when (not (barrier-value (mt-future-valid future)))
           (let ((notif nil))
...">mt-future-read</a> x))</pre>
  </div>

<div class="form-block function" id="def-future-abort" data-defines="FUTURE-ABORT" data-references="MT-FUTURE-ABORT,X,DEFUN" data-used-by="ABORT-FUTURES" data-part-name="FUTURE-ABORT" data-part-args="X" data-part-body="X,MT-FUTURE-ABORT" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="FUTURE-ABORT">future-abort</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-future-abort" data-sym="FUTURE-ABORT" title="(defun future-abort (x) (mt-future-abort x))">future-abort</a> (x) (<a class="sym-link local-def" href="#def-mt-future-abort" data-sym="MT-FUTURE-ABORT" title="(defun mt-future-abort (future)
  (incf *aborted-futures-total*)
  (cond ((st-future-p future) (st-future-abort future))
        ((mt-future-p future)
         (without-interrupts
...">mt-future-abort</a> x))</pre>
  </div>

<div class="form-block function" id="def-abort-futures" data-defines="ABORT-FUTURES" data-references="CDR,CAR,FUTURE-ABORT,T,ENDP,COND,FUTURES,DEFUN" data-part-name="ABORT-FUTURES" data-part-args="FUTURES" data-part-body="CDR,ABORT-FUTURES,CAR,FUTURE-ABORT,T,FUTURES,ENDP,COND" typeof="SoftwareSourceCode">
    <div class="form-header"><span class="form-name" property="name" data-sym="ABORT-FUTURES">abort-futures</span><span class="form-type">function</span></div>
    <pre class="code" property="text">(<a class="sym-link system" href="axioms.html#def-defun" data-sym="DEFUN">defun</a> <a class="sym-link local-def" href="#def-abort-futures" data-sym="ABORT-FUTURES" title="(defun abort-futures (futures)
  (cond ((endp futures) t)
        (t (future-abort (car futures)) (abort-futures (cdr futures)))))">abort-futures</a>
  (futures)
  (<a class="sym-link system" href="axioms.html#def-cond" data-sym="COND">cond</a> ((<a class="sym-link system" href="axioms.html#def-endp" data-sym="ENDP">endp</a> futures) <a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a>)
    (<a class="sym-link system" href="axioms.html#def-t" data-sym="T">t</a> (<a class="sym-link local-def" href="#def-future-abort" data-sym="FUTURE-ABORT" title="(defun future-abort (x) (mt-future-abort x))">future-abort</a> (car futures))
      (<a class="sym-link local-def" href="#def-abort-futures" data-sym="ABORT-FUTURES" title="(defun abort-futures (futures)
  (cond ((endp futures) t)
        (t (future-abort (car futures)) (abort-futures (cdr futures)))))">abort-futures</a> (cdr futures)))))</pre>
  </div>


  </main>
  
<script>
// ACL2 Book HTML Documentation - Interactive Features
// Generated by cert2 - build2 system

// State
let activeFilter = null;
let activePartFilter = null;
let activeNameFilter = null;
let currentFontSize = 14;

// Theme management
function getStoredTheme() {
  return localStorage.getItem('acl2-theme') || 'dark';
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('theme-toggle').textContent = '🌙';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('theme-toggle').textContent = '☀️';
  }
  localStorage.setItem('acl2-theme', theme);
}

function toggleTheme() {
  const current = getStoredTheme();
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Font size management
function getStoredFontSize() {
  return parseInt(localStorage.getItem('acl2-fontsize') || '14', 10);
}

function setFontSize(size) {
  size = Math.max(10, Math.min(24, size)); // Clamp between 10-24
  currentFontSize = size;
  document.body.style.fontSize = size + 'px';
  localStorage.setItem('acl2-fontsize', size.toString());
}

function increaseFontSize() {
  setFontSize(currentFontSize + 2);
}

function decreaseFontSize() {
  setFontSize(currentFontSize - 2);
}

// Get all form blocks
function getFormBlocks() {
  return document.querySelectorAll('.form-block');
}

// Clear all filters
function clearFilter() {
  activeFilter = null;
  activePartFilter = null;
  activeNameFilter = null;
  getFormBlocks().forEach(b => {
    b.classList.remove('hidden', 'dimmed');
  });
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  const status = document.querySelector('.filter-status');
  status.classList.remove('active');
  // Slide name filter back to original position
  document.querySelector('.controls-left').style.transform = '';
  // Clear the name filter input
  const nameInput = document.getElementById('name-filter');
  if (nameInput) nameInput.value = '';
}

// Show filter status and slide name filter right
function showFilterStatus(text) {
  const status = document.querySelector('.filter-status');
  status.classList.add('active');
  status.querySelector('.filter-text').textContent = text;
  // Slide name filter to the right to make room
  setTimeout(() => {
    const statusWidth = status.offsetWidth;
    document.querySelector('.controls-left').style.transform = `translateX(${statusWidth + 15}px)`;
  }, 10);
}

// Filter to show only forms that define or reference a symbol
function filterBySymbol(symName, showUsedBy) {
  clearFilter();
  activeFilter = symName;
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines;
    const references = (block.dataset.references || '').split(',');
    const usedBy = (block.dataset.usedBy || '').split(',');
    
    let show = false;
    if (showUsedBy) {
      // Show forms that USE this symbol
      show = references.includes(symName) || definesName === symName;
    } else {
      // Show forms that this symbol USES
      show = usedBy.includes(symName) || definesName === symName;
    }
    
    if (show) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering by: ${symName} (${visibleCount} items)`);
}

// Filter by defthm part (term, hints, rule-classes, etc.)
function filterByPart(formId, partName) {
  clearFilter();
  activePartFilter = { formId, partName };
  
  // Get the part's referenced symbols
  // data-part-term becomes dataset.partTerm, data-part-hints becomes dataset.partHints, etc.
  const block = document.getElementById(formId);
  const datasetKey = 'part' + partName.charAt(0).toUpperCase() + partName.slice(1).replace(/-([a-z])/g, (g) => g[1].toUpperCase());
  const partData = block.dataset[datasetKey];
  if (!partData) return;
  
  const partSyms = partData.split(',').filter(s => s);
  
  // Highlight the button
  block.querySelector(`.part-btn[data-part="${partName}"]`).classList.add('active');
  
  // Hide forms not referenced by this part
  getFormBlocks().forEach(b => {
    const definesName = b.dataset.defines;
    if (b.id === formId || partSyms.includes(definesName)) {
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
    }
  });
  
  // Update status
  showFilterStatus(`Filtering ${formId} :${partName} (${partSyms.length} references)`);
}

// Filter by name (substring or regex)
function filterByName(pattern, useRegex) {
  // Clear other filters but keep the input value
  activeFilter = null;
  activePartFilter = null;
  document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
  
  if (!pattern || pattern.trim() === '') {
    // Empty pattern - show all
    activeNameFilter = null;
    getFormBlocks().forEach(b => b.classList.remove('hidden'));
    const status = document.querySelector('.filter-status');
    status.classList.remove('active');
    document.querySelector('.controls-left').style.transform = '';
    return;
  }
  
  activeNameFilter = pattern;
  
  let matcher;
  let isValidRegex = true;
  
  if (useRegex) {
    try {
      matcher = new RegExp(pattern, 'i');
    } catch (e) {
      // Invalid regex - show error in status and don't filter
      showFilterStatus(`Invalid regex: ${e.message}`);
      return;
    }
  } else {
    // Plain substring match (case-insensitive)
    const lowerPattern = pattern.toLowerCase();
    matcher = { test: (s) => s.toLowerCase().includes(lowerPattern) };
  }
  
  const blocks = getFormBlocks();
  let visibleCount = 0;
  
  blocks.forEach(block => {
    const definesName = block.dataset.defines || '';
    if (matcher.test(definesName)) {
      block.classList.remove('hidden');
      visibleCount++;
    } else {
      block.classList.add('hidden');
    }
  });
  
  // Update status
  const modeText = useRegex ? 'regex' : 'name';
  showFilterStatus(`Filtering by ${modeText}: "${pattern}" (${visibleCount} matches)`);
}

// Click on a name to show what references it
function handleNameClick(symName) {
  if (activeFilter === symName) {
    clearFilter();
  } else {
    filterBySymbol(symName, true);
  }
}

// Navigate to a definition (same file or different)
function navigateTo(symName, file) {
  if (file) {
    // External file - navigate
    window.location.href = file + '.html#def-' + symName.toLowerCase();
  } else {
    // Same file - scroll
    const target = document.getElementById('def-' + symName.toLowerCase());
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.classList.add('highlight');
      setTimeout(() => target.classList.remove('highlight'), 400);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Part buttons
  document.querySelectorAll('.part-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const formId = btn.closest('.form-block').id;
      const partName = btn.dataset.part;
      if (activePartFilter && activePartFilter.formId === formId && 
          activePartFilter.partName === partName) {
        clearFilter();
      } else {
        filterByPart(formId, partName);
      }
    });
  });
  
  // Clear filter button
  document.querySelector('.clear-filter').addEventListener('click', clearFilter);
  
  // Name filter input
  const nameFilter = document.getElementById('name-filter');
  const regexToggle = document.getElementById('regex-toggle');
  
  let filterTimeout = null;
  nameFilter.addEventListener('input', () => {
    // Debounce the filter to avoid excessive updates while typing
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      filterByName(nameFilter.value, regexToggle.checked);
    }, 150);
  });
  
  // Re-filter when regex toggle changes
  regexToggle.addEventListener('change', () => {
    if (nameFilter.value) {
      filterByName(nameFilter.value, regexToggle.checked);
    }
  });
  
  // Allow Escape key to clear filter when in input
  nameFilter.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearFilter();
      nameFilter.blur();
    }
  });
  
  // Symbol references (old span-based refs)
  document.querySelectorAll('.sym-ref').forEach(ref => {
    ref.addEventListener('click', (e) => {
      e.stopPropagation();
      const sym = ref.dataset.sym;
      const file = ref.dataset.file;
      if (file) {
        navigateTo(sym, file);
      } else {
        handleNameClick(sym);
      }
    });
  });
  
  // Symbol links (new anchor-based links)
  // These use standard <a> tags so navigation happens automatically
  // But we need to clear filters if target would be hidden
  document.querySelectorAll('.sym-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('#')) {
        // Local link - check if target is hidden by filter
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          // If target is hidden, clear the filter first
          if (target.classList.contains('hidden')) {
            clearFilter();
          }
          // Add highlight effect after a short delay
          setTimeout(() => {
            target.classList.add('highlight');
            setTimeout(() => target.classList.remove('highlight'), 400);
          }, 100);
        }
      }
      // For external links, default behavior handles navigation
    });
  });
  
  // Form names (show what uses them)
  document.querySelectorAll('.form-name').forEach(name => {
    name.addEventListener('click', (e) => {
      handleNameClick(name.dataset.sym);
    });
  });
  
  // Handle hash navigation (when arriving at page with #anchor)
  if (window.location.hash) {
    const target = document.querySelector(window.location.hash);
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.classList.add('highlight');
        setTimeout(() => target.classList.remove('highlight'), 400);
      }, 200);
    }
  }
  
  // Initialize theme from storage
  setTheme(getStoredTheme());
  
  // Initialize font size from storage
  currentFontSize = getStoredFontSize();
  setFontSize(currentFontSize);
  
  // Theme toggle button
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  
  // Font size buttons
  document.getElementById('font-larger').addEventListener('click', increaseFontSize);
  document.getElementById('font-smaller').addEventListener('click', decreaseFontSize);
});

</script>

</body>
</html>